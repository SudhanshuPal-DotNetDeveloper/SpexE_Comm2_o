!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(require("@firebase/app-compat"),require("@firebase/app")):"function"==typeof define&&define.amd?define(["@firebase/app-compat","@firebase/app"],t):t((e="undefined"!=typeof globalThis?globalThis:e||self).firebase,e.firebase.INTERNAL.modularAPIs)}(this,function(yf,vf){"use strict";try{!function(){var l,t=(t=yf)&&"object"==typeof t&&"default"in t?t:{default:t};function i(n){const r=[];let s=0;for(let t=0;t<n.length;t++){let e=n.charCodeAt(t);e<128?r[s++]=e:(e<2048?r[s++]=e>>6|192:(55296==(64512&e)&&t+1<n.length&&56320==(64512&n.charCodeAt(t+1))?(e=65536+((1023&e)<<10)+(1023&n.charCodeAt(++t)),r[s++]=e>>18|240,r[s++]=e>>12&63|128):r[s++]=e>>12|224,r[s++]=e>>6&63|128),r[s++]=63&e|128)}return r}function u(e){return e=i(e),c.encodeByteArray(e,!0).replace(/\./g,"")}const c={byteToCharMap_:null,charToByteMap_:null,byteToCharMapWebSafe_:null,charToByteMapWebSafe_:null,ENCODED_VALS_BASE:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789",get ENCODED_VALS(){return this.ENCODED_VALS_BASE+"+/="},get ENCODED_VALS_WEBSAFE(){return this.ENCODED_VALS_BASE+"-_."},HAS_NATIVE_SUPPORT:"function"==typeof atob,encodeByteArray(r,e){if(!Array.isArray(r))throw Error("encodeByteArray takes an array as a parameter");this.init_();var s=e?this.byteToCharMapWebSafe_:this.byteToCharMap_;const i=[];for(let n=0;n<r.length;n+=3){var a=r[n],o=n+1<r.length,u=o?r[n+1]:0,c=n+2<r.length,h=c?r[n+2]:0;let e=(15&u)<<2|h>>6,t=63&h;c||(t=64,o||(e=64)),i.push(s[a>>2],s[(3&a)<<4|u>>4],s[e],s[t])}return i.join("")},encodeString(e,t){return this.HAS_NATIVE_SUPPORT&&!t?btoa(e):this.encodeByteArray(i(e),t)},decodeString(n,r){if(this.HAS_NATIVE_SUPPORT&&!r)return atob(n);{var s=this.decodeStringToByteArray(n,r);const u=[];let e=0,t=0;for(;e<s.length;){var i,a,o=s[e++];o<128?u[t++]=String.fromCharCode(o):191<o&&o<224?(i=s[e++],u[t++]=String.fromCharCode((31&o)<<6|63&i)):239<o&&o<365?(a=((7&o)<<18|(63&s[e++])<<12|(63&s[e++])<<6|63&s[e++])-65536,u[t++]=String.fromCharCode(55296+(a>>10)),u[t++]=String.fromCharCode(56320+(1023&a))):(i=s[e++],a=s[e++],u[t++]=String.fromCharCode((15&o)<<12|(63&i)<<6|63&a))}return u.join("")}},decodeStringToByteArray(t,e){this.init_();var n=e?this.charToByteMapWebSafe_:this.charToByteMap_;const r=[];for(let e=0;e<t.length;){var s=n[t.charAt(e++)],i=e<t.length?n[t.charAt(e)]:0,a=++e<t.length?n[t.charAt(e)]:64,o=++e<t.length?n[t.charAt(e)]:64;if(++e,null==s||null==i||null==a||null==o)throw Error();r.push(s<<2|i>>4),64!==a&&(r.push(i<<4&240|a>>2),64!==o&&r.push(a<<6&192|o))}return r},init_(){if(!this.byteToCharMap_){this.byteToCharMap_={},this.charToByteMap_={},this.byteToCharMapWebSafe_={},this.charToByteMapWebSafe_={};for(let e=0;e<this.ENCODED_VALS.length;e++)this.byteToCharMap_[e]=this.ENCODED_VALS.charAt(e),this.charToByteMap_[this.byteToCharMap_[e]]=e,this.byteToCharMapWebSafe_[e]=this.ENCODED_VALS_WEBSAFE.charAt(e),(this.charToByteMapWebSafe_[this.byteToCharMapWebSafe_[e]]=e)>=this.ENCODED_VALS_BASE.length&&(this.charToByteMap_[this.ENCODED_VALS_WEBSAFE.charAt(e)]=e,this.charToByteMapWebSafe_[this.ENCODED_VALS.charAt(e)]=e)}}};function U(){return"undefined"!=typeof navigator&&"string"==typeof navigator.userAgent?navigator.userAgent:""}class q extends Error{constructor(e,t,n){super(t),this.code=e,this.customData=n,this.name="FirebaseError",Object.setPrototypeOf(this,q.prototype),Error.captureStackTrace&&Error.captureStackTrace(this,K.prototype.create)}}class K{constructor(e,t,n){this.service=e,this.serviceName=t,this.errors=n}create(e,...t){var r,t=t[0]||{},n=this.service+"/"+e,e=(e=this.errors[e])?(r=t,e.replace(G,(e,t)=>{var n=r[t];return null!=n?String(n):`<${t}?>`})):"Error",e=this.serviceName+`: ${e} (${n}).`;return new q(n,e,t)}}const G=/\{\$([^}]+)}/g;function v(e){return e&&e._delegate?e._delegate:e}class j{constructor(e,t,n){this.name=e,this.instanceFactory=t,this.type=n,this.multipleInstances=!1,this.serviceProps={},this.instantiationMode="LAZY",this.onInstanceCreated=null}setInstantiationMode(e){return this.instantiationMode=e,this}setMultipleInstances(e){return this.multipleInstances=e,this}setServiceProps(e){return this.serviceProps=e,this}setInstanceCreatedCallback(e){return this.onInstanceCreated=e,this}}(vr=l=l||{})[vr.DEBUG=0]="DEBUG",vr[vr.VERBOSE=1]="VERBOSE",vr[vr.INFO=2]="INFO",vr[vr.WARN=3]="WARN",vr[vr.ERROR=4]="ERROR",vr[vr.SILENT=5]="SILENT";const Q={debug:l.DEBUG,verbose:l.VERBOSE,info:l.INFO,warn:l.WARN,error:l.ERROR,silent:l.SILENT},z=l.INFO,H={[l.DEBUG]:"log",[l.VERBOSE]:"log",[l.INFO]:"info",[l.WARN]:"warn",[l.ERROR]:"error"},W=(e,t,...n)=>{if(!(t<e.logLevel)){var r=(new Date).toISOString(),s=H[t];if(!s)throw new Error(`Attempted to log a message with an invalid logType (value: ${t})`);console[s](`[${r}]  ${e.name}:`,...n)}};var $="undefined"!=typeof globalThis?globalThis:"undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:{},w=$||self;function Y(){}function X(e){var t=typeof e;return"array"==(t="object"!=t?t:e?Array.isArray(e)?"array":t:"null")||"object"==t&&"number"==typeof e.length}function J(e){var t=typeof e;return"object"==t&&null!=e||"function"==t}Math.random();function Z(e,t,n){return e.call.apply(e.bind,arguments)}function ee(t,n,e){if(t)return 2<arguments.length?(r=Array.prototype.slice.call(arguments,2),function(){var e=Array.prototype.slice.call(arguments);return Array.prototype.unshift.apply(e,r),t.apply(n,e)}):function(){return t.apply(n,arguments)};var r;throw Error()}function te(e,t,n){return(te=Function.prototype.bind&&-1!=Function.prototype.bind.toString().indexOf("native code")?Z:ee).apply(null,arguments)}function ne(t){var n=Array.prototype.slice.call(arguments,1);return function(){var e=n.slice();return e.push.apply(e,arguments),t.apply(this,e)}}function re(e,i){function t(){}t.prototype=i.prototype,e.X=i.prototype,e.prototype=new t,(e.prototype.constructor=e).Wb=function(e,t,n){for(var r=Array(arguments.length-2),s=2;s<arguments.length;s++)r[s-2]=arguments[s];return i.prototype[t].apply(e,r)}}function se(){this.s=this.s,this.o=this.o}se.prototype.s=!1,se.prototype.na=function(){this.s||(this.s=!0,this.M())},se.prototype.M=function(){if(this.o)for(;this.o.length;)this.o.shift()()};const ie=Array.prototype.indexOf?function(e,t){return Array.prototype.indexOf.call(e,t,void 0)}:function(t,n){if("string"==typeof t)return"string"!=typeof n||1!=n.length?-1:t.indexOf(n,0);for(let e=0;e<t.length;e++)if(e in t&&t[e]===n)return e;return-1};function ae(t){var n=t.length;if(0<n){const r=Array(n);for(let e=0;e<n;e++)r[e]=t[e];return r}return[]}function oe(t){for(let e=1;e<arguments.length;e++){var n=arguments[e];if(X(n)){var r=t.length||0,s=n.length||0;t.length=r+s;for(let e=0;e<s;e++)t[r+e]=n[e]}else t.push(n)}}function ue(e,t){this.type=e,this.g=this.target=t,this.defaultPrevented=!1}ue.prototype.h=function(){this.defaultPrevented=!0};var ce=function(){if(!w.addEventListener||!Object.defineProperty)return!1;var e=!1,t=Object.defineProperty({},"passive",{get:function(){e=!0}});try{w.addEventListener("test",Y,t),w.removeEventListener("test",Y,t)}catch(e){}return e}();function he(e){return/^[\s\xa0]*$/.test(e)}var le=String.prototype.trim?function(e){return e.trim()}:function(e){return/^[\s\xa0]*([\s\S]*?)[\s\xa0]*$/.exec(e)[1]};function de(e,t){return e<t?-1:t<e?1:0}function fe(){var e=w.navigator;return(e=e&&e.userAgent)?e:""}function ge(e){return-1!=fe().indexOf(e)}function me(e){return me[" "](e),e}me[" "]=Y;var pe,ye=ge("Opera"),ve=ge("Trident")||ge("MSIE"),e=ge("Edge"),we=e||ve,Ie=ge("Gecko")&&!(-1!=fe().toLowerCase().indexOf("webkit")&&!ge("Edge"))&&!(ge("Trident")||ge("MSIE"))&&!ge("Edge"),be=-1!=fe().toLowerCase().indexOf("webkit")&&!ge("Edge");function Ee(){var e=w.document;return e?e.documentMode:void 0}var Te="",Se=(Se=fe(),Ie?/rv:([^\);]+)(\)|;)/.exec(Se):e?/Edge\/([\d\.]+)/.exec(Se):ve?/\b(?:MSIE|rv)[: ]([^\);]+)(\)|;)/.exec(Se):be?/WebKit\/(\S+)/.exec(Se):ye?/(?:Version)[ \/]?(\S+)/.exec(Se):void 0),_e=((Se&&(Te=Se?Se[1]:""),ve&&null!=(Se=Ee())&&Se>parseFloat(Te))?pe=String(Se):pe=Te,{});var xe=w.document&&ve&&(Ee()||parseInt(pe,10))||void 0;function De(e,t){if(ue.call(this,e?e.type:""),this.relatedTarget=this.g=this.target=null,this.button=this.screenY=this.screenX=this.clientY=this.clientX=0,this.key="",this.metaKey=this.shiftKey=this.altKey=this.ctrlKey=!1,this.state=null,this.pointerId=0,this.pointerType="",this.i=null,e){var n=this.type=e.type,r=e.changedTouches&&e.changedTouches.length?e.changedTouches[0]:null;if(this.target=e.target||e.srcElement,this.g=t,t=e.relatedTarget){if(Ie){e:{try{me(t.nodeName);var s=!0;break e}catch(e){}s=!1}s||(t=null)}}else"mouseover"==n?t=e.fromElement:"mouseout"==n&&(t=e.toElement);this.relatedTarget=t,r?(this.clientX=void 0!==r.clientX?r.clientX:r.pageX,this.clientY=void 0!==r.clientY?r.clientY:r.pageY,this.screenX=r.screenX||0,this.screenY=r.screenY||0):(this.clientX=void 0!==e.clientX?e.clientX:e.pageX,this.clientY=void 0!==e.clientY?e.clientY:e.pageY,this.screenX=e.screenX||0,this.screenY=e.screenY||0),this.button=e.button,this.key=e.key||"",this.ctrlKey=e.ctrlKey,this.altKey=e.altKey,this.shiftKey=e.shiftKey,this.metaKey=e.metaKey,this.pointerId=e.pointerId||0,this.pointerType="string"==typeof e.pointerType?e.pointerType:Ae[e.pointerType]||"",this.state=e.state,(this.i=e).defaultPrevented&&De.X.h.call(this)}}re(De,ue);var Ae={2:"touch",3:"pen",4:"mouse"},Ce=(De.prototype.h=function(){De.X.h.call(this);var e=this.i;e.preventDefault?e.preventDefault():e.returnValue=!1},"closure_listenable_"+(1e6*Math.random()|0)),Ne=0;function ke(e,t,n,r,s){this.listener=e,this.proxy=null,this.src=t,this.type=n,this.capture=!!r,this.ha=s,this.key=++Ne,this.ba=this.ea=!1}function Re(e){e.ba=!0,e.listener=null,e.proxy=null,e.src=null,e.ha=null}function Le(e,t,n){for(const r in e)t.call(n,e[r],r,e)}function Me(e){const t={};for(const n in e)t[n]=e[n];return t}const Oe="constructor hasOwnProperty isPrototypeOf propertyIsEnumerable toLocaleString toString valueOf".split(" ");function Ve(t){let n,r;for(let e=1;e<arguments.length;e++){for(n in r=arguments[e])t[n]=r[n];for(let e=0;e<Oe.length;e++)n=Oe[e],Object.prototype.hasOwnProperty.call(r,n)&&(t[n]=r[n])}}function Fe(e){this.src=e,this.g={},this.h=0}function Pe(e,t){var n,r,s,i=t.type;i in e.g&&(n=e.g[i],(s=0<=(r=ie(n,t)))&&Array.prototype.splice.call(n,r,1),s&&(Re(t),0==e.g[i].length&&(delete e.g[i],e.h--)))}function Be(e,t,n,r){for(var s=0;s<e.length;++s){var i=e[s];if(!i.ba&&i.listener==t&&i.capture==!!n&&i.ha==r)return s}return-1}Fe.prototype.add=function(e,t,n,r,s){var i=e.toString(),a=((e=this.g[i])||(e=this.g[i]=[],this.h++),Be(e,t,r,s));return-1<a?(t=e[a],n||(t.ea=!1)):((t=new ke(t,this.src,i,!!r,s)).ea=n,e.push(t)),t};var Ue="closure_lm_"+(1e6*Math.random()|0),qe={};function Ke(e,t,n,r,s,i){if(!t)throw Error("Invalid event type");var a=J(s)?!!s.capture:!!s,o=ze(e);if(o||(e[Ue]=o=new Fe(e)),(n=o.add(t,n,r,a,i)).proxy)return n;if(r=function(){const n=Qe;return function e(t){return n.call(e.src,e.listener,t)}}(),(n.proxy=r).src=e,r.listener=n,e.addEventListener)void 0===(s=ce?s:a)&&(s=!1),e.addEventListener(t.toString(),r,s);else if(e.attachEvent)e.attachEvent(je(t.toString()),r);else{if(!e.addListener||!e.removeListener)throw Error("addEventListener and attachEvent are unavailable.");e.addListener(r)}return n}function Ge(e){var t,n,r;"number"!=typeof e&&e&&!e.ba&&((t=e.src)&&t[Ce]?Pe(t.i,e):(n=e.type,r=e.proxy,t.removeEventListener?t.removeEventListener(n,r,e.capture):t.detachEvent?t.detachEvent(je(n),r):t.addListener&&t.removeListener&&t.removeListener(r),(n=ze(t))?(Pe(n,e),0==n.h&&(n.src=null,t[Ue]=null)):Re(e)))}function je(e){return e in qe?qe[e]:qe[e]="on"+e}function Qe(e,t){var n,r;return!!e.ba||(t=new De(t,this),n=e.listener,r=e.ha||e.src,e.ea&&Ge(e),n.call(r,t))}function ze(e){return(e=e[Ue])instanceof Fe?e:null}var He="__closure_events_fn_"+(1e9*Math.random()>>>0);function We(t){return"function"==typeof t?t:(t[He]||(t[He]=function(e){return t.handleEvent(e)}),t[He])}function s(){se.call(this),this.i=new Fe(this),(this.P=this).I=null}function $e(e,t){var n,r=e.I;if(r)for(n=[];r;r=r.I)n.push(r);if(e=e.P,r=t.type||t,"string"==typeof t?t=new ue(t,e):t instanceof ue?t.target=t.target||e:(a=t,Ve(t=new ue(r,e),a)),a=!0,n)for(var s=n.length-1;0<=s;s--)var i=t.g=n[s],a=Ye(i,r,!0,t)&&a;if(a=Ye(i=t.g=e,r,!0,t)&&a,a=Ye(i,r,!1,t)&&a,n)for(s=0;s<n.length;s++)a=Ye(i=t.g=n[s],r,!1,t)&&a}function Ye(e,t,n,r){if(!(t=e.i.g[String(t)]))return!0;t=t.concat();for(var s=!0,i=0;i<t.length;++i){var a,o,u=t[i];u&&!u.ba&&u.capture==n&&(a=u.listener,o=u.ha||u.src,u.ea&&Pe(e.i,u),s=!1!==a.call(o,r)&&s)}return s&&!r.defaultPrevented}re(s,se),s.prototype[Ce]=!0,s.prototype.removeEventListener=function(e,t,n,r){!function e(t,n,r,s,i){if(Array.isArray(n))for(var a=0;a<n.length;a++)e(t,n[a],r,s,i);else s=J(s)?!!s.capture:!!s,r=We(r),t&&t[Ce]?(t=t.i,(n=String(n).toString())in t.g&&-1<(r=Be(a=t.g[n],r,s,i))&&(Re(a[r]),Array.prototype.splice.call(a,r,1),0==a.length&&(delete t.g[n],t.h--))):(t=t&&ze(t))&&(n=t.g[n.toString()],(r=(t=-1)<(t=n?Be(n,r,s,i):t)?n[t]:null)&&Ge(r))}(this,e,t,n,r)},s.prototype.M=function(){if(s.X.M.call(this),this.i){var e,t=this.i;for(e in t.g){for(var n=t.g[e],r=0;r<n.length;r++)Re(n[r]);delete t.g[e],t.h--}}this.I=null},s.prototype.N=function(e,t,n,r){return this.i.add(String(e),t,!1,n,r)},s.prototype.O=function(e,t,n,r){return this.i.add(String(e),t,!0,n,r)};var Xe,Je=w.JSON.stringify,Ze=new class{constructor(e,t){this.i=e,this.j=t,this.h=0,this.g=null}get(){let e;return 0<this.h?(this.h--,e=this.g,this.g=e.next,e.next=null):e=this.i(),e}}(()=>new et,e=>e.reset());class et{constructor(){this.next=this.g=this.h=null}set(e,t){this.h=e,this.g=t,this.next=null}reset(){this.next=this.g=this.h=null}}function tt(e,t){var n;Xe||(n=w.Promise.resolve(void 0),Xe=function(){n.then(st)}),nt||(Xe(),nt=!0),rt.add(e,t)}var nt=!1,rt=new class{constructor(){this.h=this.g=null}add(e,t){const n=Ze.get();n.set(e,t),this.h?this.h.next=n:this.g=n,this.h=n}};function st(){for(var e;e=function(){var e=rt;let t=null;return e.g&&(t=e.g,e.g=e.g.next,e.g||(e.h=null),t.next=null),t}();){try{e.h.call(e.g)}catch(e){!function(e){w.setTimeout(()=>{throw e},0)}(e)}var t=Ze;t.j(e),t.h<100&&(t.h++,e.next=t.g,t.g=e)}nt=!1}function it(e,t){s.call(this),this.h=e||1,this.g=t||w,this.j=te(this.lb,this),this.l=Date.now()}function at(e){e.ca=!1,e.R&&(e.g.clearTimeout(e.R),e.R=null)}function ot(e,t,n){if("function"==typeof e)n&&(e=te(e,n));else{if(!e||"function"!=typeof e.handleEvent)throw Error("Invalid listener argument");e=te(e.handleEvent,e)}return 2147483647<Number(t)?-1:w.setTimeout(e,t||0)}re(it,s),(e=it.prototype).ca=!1,e.R=null,e.lb=function(){var e;this.ca&&(0<(e=Date.now()-this.l)&&e<.8*this.h?this.R=this.g.setTimeout(this.j,this.h-e):(this.R&&(this.g.clearTimeout(this.R),this.R=null),$e(this,"tick"),this.ca&&(at(this),this.start())))},e.start=function(){this.ca=!0,this.R||(this.R=this.g.setTimeout(this.j,this.h),this.l=Date.now())},e.M=function(){it.X.M.call(this),at(this),delete this.g};class ut extends se{constructor(e,t){super(),this.m=e,this.j=t,this.h=null,this.i=!1,this.g=null}l(e){this.h=arguments,this.g?this.i=!0:function e(t){t.g=ot(()=>{t.g=null,t.i&&(t.i=!1,e(t))},t.j);var n=t.h;t.h=null,t.m.apply(null,n)}(this)}M(){super.M(),this.g&&(w.clearTimeout(this.g),this.g=null,this.i=!1,this.h=null)}}function ct(e){se.call(this),this.h=e,this.g={}}re(ct,se);var ht=[];function lt(e,t,n,r){Array.isArray(n)||(n&&(ht[0]=n.toString()),n=ht);for(var s=0;s<n.length;s++){var i=function e(t,n,r,s,i){if(s&&s.once)return function e(t,n,r,s,i){if(Array.isArray(n)){for(var a=0;a<n.length;a++)e(t,n[a],r,s,i);return null}return r=We(r),t&&t[Ce]?t.O(n,r,J(s)?!!s.capture:!!s,i):Ke(t,n,r,!0,s,i)}(t,n,r,s,i);if(Array.isArray(n)){for(var a=0;a<n.length;a++)e(t,n[a],r,s,i);return null}return r=We(r),t&&t[Ce]?t.N(n,r,J(s)?!!s.capture:!!s,i):Ke(t,n,r,!1,s,i)}(t,n[s],r||e.handleEvent,!1,e.h||e);if(!i)break;e.g[i.key]=i}}function dt(e){Le(e.g,function(e,t){this.g.hasOwnProperty(t)&&Ge(e)},e),e.g={}}function ft(){this.g=!0}function gt(e,t,n,r){e.info(function(){return"XMLHTTP TEXT ("+t+"): "+function(e,t){if(!e.g)return t;if(!t)return null;try{var n=JSON.parse(t);if(n)for(e=0;e<n.length;e++)if(Array.isArray(n[e])){var r=n[e];if(!(r.length<2)){var s=r[1];if(Array.isArray(s)&&!(s.length<1)){var i=s[0];if("noop"!=i&&"stop"!=i&&"close"!=i)for(var a=1;a<s.length;a++)s[a]=""}}}return Je(n)}catch(e){return t}}(e,n)+(r?" "+r:"")})}ct.prototype.M=function(){ct.X.M.call(this),dt(this)},ct.prototype.handleEvent=function(){throw Error("EventHandler.handleEvent not implemented")},ft.prototype.Aa=function(){this.g=!1},ft.prototype.info=function(){};var mt={},pt=null;function yt(){return pt=pt||new s}function vt(e){ue.call(this,mt.Pa,e)}function wt(){var e=yt();$e(e,new vt(e))}function It(e,t){ue.call(this,mt.STAT_EVENT,e),this.stat=t}function bt(e){var t=yt();$e(t,new It(t,e))}function Et(e,t){ue.call(this,mt.Qa,e),this.size=t}function Tt(e,t){if("function"!=typeof e)throw Error("Fn must not be null and must be a function");return w.setTimeout(function(){e()},t)}mt.Pa="serverreachability",re(vt,ue),mt.STAT_EVENT="statevent",re(It,ue),mt.Qa="timingevent",re(Et,ue);be={NO_ERROR:0,mb:1,zb:2,yb:3,tb:4,xb:5,Ab:6,Ma:7,TIMEOUT:8,Db:9},ye={rb:"complete",Nb:"success",Na:"error",Ma:"abort",Fb:"ready",Gb:"readystatechange",TIMEOUT:"timeout",Bb:"incrementaldata",Eb:"progress",ub:"downloadprogress",Vb:"uploadprogress"};function St(){}function _t(e){return e.h||(e.h=e.i())}function xt(){}function Dt(){ue.call(this,"d")}function At(){ue.call(this,"c")}function Ct(){}function Nt(e,t,n,r){this.l=e,this.j=t,this.m=n,this.U=r||1,this.S=new ct(this),this.O=Lt,this.T=new it(e=we?125:void 0),this.H=null,this.i=!1,this.s=this.A=this.v=this.K=this.F=this.V=this.B=null,this.D=[],this.g=null,this.C=0,this.o=this.u=null,this.Y=-1,this.I=!1,this.N=0,this.L=null,this.$=this.J=this.Z=this.P=!1,this.h=new kt}function kt(){this.i=null,this.g="",this.h=!1}St.prototype.h=null,$={OPEN:"a",qb:"b",Na:"c",Cb:"d"},re(Dt,ue),re(At,ue),re(Ct,St),Ct.prototype.g=function(){return new XMLHttpRequest},Ct.prototype.i=function(){return{}};var Rt=new Ct,Lt=45e3,Mt={},Ot={};function Vt(e,t,n){e.K=1,e.v=Zt($t(t)),e.s=n,e.P=!0,Ft(e,null)}function Ft(e,t){e.F=Date.now(),Ut(e),e.A=$t(e.v);var a,o,u,c,h,l,n=e.A,r=e.U;Array.isArray(r)||(r=[String(r)]),fn(n.i,"t",r),e.C=0,n=e.l.H,e.h=new kt,e.g=lr(e.l,n?t:null,!e.s),0<e.N&&(e.L=new ut(te(e.La,e,e.g),e.N)),lt(e.S,e.g,"readystatechange",e.ib),t=e.H?Me(e.H):{},e.s?(e.u||(e.u="POST"),t["Content-Type"]="application/x-www-form-urlencoded",e.g.da(e.A,e.u,e.s,t)):(e.u="GET",e.g.da(e.A,e.u,null,t)),wt(),a=e.j,o=e.u,u=e.A,c=e.m,h=e.U,l=e.s,a.info(function(){if(a.g)if(l)for(var e="",t=l.split("&"),n=0;n<t.length;n++){var r,s,i=t[n].split("=");1<i.length&&(r=i[0],i=i[1],e=2<=(s=r.split("_")).length&&"type"==s[1]?e+(r+"=")+i+"&":e+(r+"=redacted&"))}else e=null;else e=l;return"XMLHTTP REQ ("+c+") [attempt "+h+"]: "+o+"\n"+u+"\n"+e})}function Pt(e){return e.g&&"GET"==e.u&&2!=e.K&&e.l.Da}function Bt(e,t,n){let r=!0,s;for(;!e.I&&e.C<n.length;){if((s=(u=void 0,o=(i=e).C,-1==(u=(a=n).indexOf("\n",o))?Ot:(o=Number(a.substring(o,u)),isNaN(o)?Mt:(u+=1)+o>a.length?Ot:(a=a.substr(u,o),i.C=u+o,a))))==Ot){4==t&&(e.o=4,bt(14),r=!1),gt(e.j,e.m,null,"[Incomplete Response]");break}if(s==Mt){e.o=4,bt(15),gt(e.j,e.m,n,"[Invalid Chunk]"),r=!1;break}gt(e.j,e.m,s,null),Qt(e,s)}var i,a,o,u;Pt(e)&&s!=Ot&&s!=Mt&&(e.h.g="",e.C=0),4!=t||0!=n.length||e.h.h||(e.o=1,bt(16),r=!1),e.i=e.i&&r,r?0<n.length&&!e.$&&(e.$=!0,(t=e.l).g==e&&t.$&&!t.K&&(t.j.info("Great, no buffering proxy detected. Bytes received: "+n.length),rr(t),t.K=!0,bt(11))):(gt(e.j,e.m,n,"[Invalid Chunked Response]"),jt(e),Gt(e))}function Ut(e){e.V=Date.now()+e.O,qt(e,e.O)}function qt(e,t){if(null!=e.B)throw Error("WatchDog timer not null");e.B=Tt(te(e.gb,e),t)}function Kt(e){e.B&&(w.clearTimeout(e.B),e.B=null)}function Gt(e){0==e.l.G||e.I||ar(e.l,e)}function jt(e){Kt(e);var t=e.L;t&&"function"==typeof t.na&&t.na(),e.L=null,at(e.T),dt(e.S),e.g&&(t=e.g,e.g=null,t.abort(),t.na())}function Qt(e,t){try{var n=e.l;if(0!=n.G&&(n.g==e||In(n.h,e)))if(!e.J&&In(n.h,e)&&3==n.G){try{var r=n.Fa.g.parse(t)}catch(e){r=null}if(Array.isArray(r)&&3==r.length){var s=r;if(0==s[0]){e:if(!n.u){if(n.g){if(!(n.g.F+3e3<e.F))break e;ir(n),$n(n)}nr(n),bt(18)}}else n.Ba=s[1],0<n.Ba-n.T&&s[2]<37500&&n.L&&0==n.A&&!n.v&&(n.v=Tt(te(n.cb,n),6e3));if(wn(n.h)<=1&&n.ja){try{n.ja()}catch(e){}n.ja=void 0}}else ur(n,11)}else if(!e.J&&n.g!=e||ir(n),!he(t))for(s=n.Fa.g.parse(t),t=0;t<s.length;t++){var i=s[t];if(n.T=i[0],i=i[1],2==n.G)if("c"==i[0]){n.I=i[1],n.ka=i[2];var a=i[3],o=(null!=a&&(n.ma=a,n.j.info("VER="+n.ma)),i[4]);null!=o&&(n.Ca=o,n.j.info("SVER="+n.Ca));var u,c,h=i[5];null!=h&&"number"==typeof h&&0<h&&(r=1.5*h,n.J=r,n.j.info("backChannelRequestTimeoutMs_="+r)),r=n;const g=e.g;if(g){const m=g.g?g.g.getResponseHeader("X-Client-Wire-Protocol"):null;!m||(u=r.h).g||-1==m.indexOf("spdy")&&-1==m.indexOf("quic")&&-1==m.indexOf("h2")||(u.j=u.l,u.g=new Set,u.h&&(bn(u,u.h),u.h=null)),r.D&&(c=g.g?g.g.getResponseHeader("X-HTTP-Session-Id"):null)&&(r.za=c,p(r.F,r.D,c))}n.G=3,n.l&&n.l.xa(),n.$&&(n.P=Date.now()-e.F,n.j.info("Handshake RTT: "+n.P+"ms"));var l,d,f=e;(r=n).sa=hr(r,r.H?r.ka:null,r.V),f.J?(En(r.h,f),l=f,(d=r.J)&&l.setTimeout(d),l.B&&(Kt(l),Ut(l)),r.g=f):tr(r),0<n.i.length&&Xn(n)}else"stop"!=i[0]&&"close"!=i[0]||ur(n,7);else 3==n.G&&("stop"==i[0]||"close"==i[0]?"stop"==i[0]?ur(n,7):Wn(n):"noop"!=i[0]&&n.l&&n.l.wa(i),n.A=0)}wt()}catch(e){}}function zt(e,t){if(e.forEach&&"function"==typeof e.forEach)e.forEach(t,void 0);else if(X(e)||"string"==typeof e)Array.prototype.forEach.call(e,t,void 0);else for(var n=function(e){if(e.oa&&"function"==typeof e.oa)return e.oa();if(!e.W||"function"!=typeof e.W){if("undefined"!=typeof Map&&e instanceof Map)return Array.from(e.keys());if(!("undefined"!=typeof Set&&e instanceof Set)){if(X(e)||"string"==typeof e){var t=[];e=e.length;for(var n=0;n<e;n++)t.push(n);return t}t=[],n=0;for(const r in e)t[n++]=r;return t}}}(e),r=function(e){if(e.W&&"function"==typeof e.W)return e.W();if("undefined"!=typeof Map&&e instanceof Map||"undefined"!=typeof Set&&e instanceof Set)return Array.from(e.values());if("string"==typeof e)return e.split("");if(X(e)){for(var t=[],n=e.length,r=0;r<n;r++)t.push(e[r]);return t}for(r in t=[],n=0,e)t[n++]=e[r];return t}(e),s=r.length,i=0;i<s;i++)t.call(void 0,r[i],n&&n[i],e)}(e=Nt.prototype).setTimeout=function(e){this.O=e},e.ib=function(e){e=e.target;const t=this.L;t&&3==Kn(e)?t.l():this.La(e)},e.La=function(e){try{if(e==this.g)e:{var t=Kn(this.g),n=this.g.Ea();if(this.g.aa(),!(t<3)&&(3!=t||we||this.g&&(this.h.h||this.g.fa()||Gn(this.g)))){this.I||4!=t||7==n||wt(),Kt(this);var r=this.g.aa();this.Y=r;t:if(Pt(this)){var s=Gn(this.g),i=(e="",s.length),a=4==Kn(this.g);if(!this.h.i){if("undefined"==typeof TextDecoder){jt(this),Gt(this);var o="";break t}this.h.i=new w.TextDecoder}for(n=0;n<i;n++)this.h.h=!0,e+=this.h.i.decode(s[n],{stream:a&&n==i-1});s.splice(0,i),this.h.g+=e,this.C=0,o=this.h.g}else o=this.g.fa();if(this.i=200==r,l=this.j,d=this.u,f=this.A,g=this.m,m=this.U,p=t,y=r,l.info(function(){return"XMLHTTP RESP ("+g+") [ attempt "+m+"]: "+d+"\n"+f+"\n"+p+" "+y}),this.i){if(this.Z&&!this.J){t:{if(this.g){var u,c=this.g;if((u=c.g?c.g.getResponseHeader("X-HTTP-Initial-Response"):null)&&!he(u)){var h=u;break t}}h=null}if(!(r=h)){this.i=!1,this.o=3,bt(12),jt(this),Gt(this);break e}gt(this.j,this.m,r,"Initial handshake response via X-HTTP-Initial-Response"),this.J=!0,Qt(this,r)}this.P?(Bt(this,t,o),we&&this.i&&3==t&&(lt(this.S,this.T,"tick",this.hb),this.T.start())):(gt(this.j,this.m,o,null),Qt(this,o)),4==t&&jt(this),this.i&&!this.I&&(4==t?ar(this.l,this):(this.i=!1,Ut(this)))}else 400==r&&0<o.indexOf("Unknown SID")?(this.o=3,bt(12)):(this.o=0,bt(13)),jt(this),Gt(this)}}}catch(e){}var l,d,f,g,m,p,y},e.hb=function(){var e,t;this.g&&(e=Kn(this.g),t=this.g.fa(),this.C<t.length&&(Kt(this),Bt(this,e,t),this.i&&4!=e&&Ut(this)))},e.cancel=function(){this.I=!0,jt(this)},e.gb=function(){this.B=null;var e,t,n=Date.now();0<=n-this.V?(e=this.j,t=this.A,e.info(function(){return"TIMEOUT: "+t}),2!=this.K&&(wt(),bt(17)),jt(this),this.o=2,Gt(this)):qt(this,this.V-n)};var Ht=RegExp("^(?:([^:/?#.]+):)?(?://(?:([^\\\\/?#]*)@)?([^\\\\/?#]*?)(?::([0-9]+))?(?=[\\\\/?#]|$))?([^?#]+)?(?:\\?([^#]*))?(?:#([\\s\\S]*))?$");function Wt(e,t){var n;this.g=this.s=this.j="",this.m=null,this.o=this.l="",this.h=!1,e instanceof Wt?(this.h=void 0!==t?t:e.h,Yt(this,e.j),this.s=e.s,this.g=e.g,Xt(this,e.m),this.l=e.l,t=e.i,(n=new cn).i=t.i,t.g&&(n.g=new Map(t.g),n.h=t.h),Jt(this,n),this.o=e.o):e&&(n=String(e).match(Ht))?(this.h=!!t,Yt(this,n[1]||"",!0),this.s=en(n[2]||""),this.g=en(n[3]||"",!0),Xt(this,n[4]),this.l=en(n[5]||"",!0),Jt(this,n[6]||"",!0),this.o=en(n[7]||"")):(this.h=!!t,this.i=new cn(null,this.h))}function $t(e){return new Wt(e)}function Yt(e,t,n){e.j=n?en(t,!0):t,e.j&&(e.j=e.j.replace(/:$/,""))}function Xt(e,t){if(t){if(t=Number(t),isNaN(t)||t<0)throw Error("Bad port number "+t);e.m=t}else e.m=null}function Jt(e,t,n){var r,s;t instanceof cn?(e.i=t,r=e.i,(s=e.h)&&!r.j&&(hn(r),r.i=null,r.g.forEach(function(e,t){var n=t.toLowerCase();t!=n&&(ln(this,t),fn(this,n,e))},r)),r.j=s):(n||(t=tn(t,on)),e.i=new cn(t,e.h))}function p(e,t,n){e.i.set(t,n)}function Zt(e){return p(e,"zx",Math.floor(2147483648*Math.random()).toString(36)+Math.abs(Math.floor(2147483648*Math.random())^Date.now()).toString(36)),e}function en(e,t){return e?t?decodeURI(e.replace(/%25/g,"%2525")):decodeURIComponent(e):""}function tn(e,t,n){return"string"==typeof e?(e=encodeURI(e).replace(t,nn),n?e.replace(/%25([0-9a-fA-F]{2})/g,"%$1"):e):null}function nn(e){return"%"+((e=e.charCodeAt(0))>>4&15).toString(16)+(15&e).toString(16)}Wt.prototype.toString=function(){var e=[],t=this.j,n=(t&&e.push(tn(t,rn,!0),":"),this.g);return!n&&"file"!=t||(e.push("//"),(t=this.s)&&e.push(tn(t,rn,!0),"@"),e.push(encodeURIComponent(String(n)).replace(/%25([0-9a-fA-F]{2})/g,"%$1")),null!=(n=this.m)&&e.push(":",String(n))),(n=this.l)&&(this.g&&"/"!=n.charAt(0)&&e.push("/"),e.push(tn(n,"/"==n.charAt(0)?an:sn,!0))),(n=this.i.toString())&&e.push("?",n),(n=this.o)&&e.push("#",tn(n,un)),e.join("")};var rn=/[#\/\?@]/g,sn=/[#\?:]/g,an=/[#\?]/g,on=/[#\?@]/g,un=/#/g;function cn(e,t){this.h=this.g=null,this.i=e||null,this.j=!!t}function hn(e){if(!e.g&&(e.g=new Map,e.h=0,e.i)){var t=e.i;if(t){t=t.split("&");for(var n=0;n<t.length;n++){var r,s=t[n].indexOf("="),i=null;0<=s?(r=t[n].substring(0,s),i=t[n].substring(s+1)):r=t[n],s=r,i=i?decodeURIComponent(i.replace(/\+/g," ")):"",e.add(decodeURIComponent(s.replace(/\+/g," ")),i)}}}}function ln(e,t){hn(e),t=gn(e,t),e.g.has(t)&&(e.i=null,e.h-=e.g.get(t).length,e.g.delete(t))}function dn(e,t){return hn(e),t=gn(e,t),e.g.has(t)}function fn(e,t,n){ln(e,t),0<n.length&&(e.i=null,e.g.set(gn(e,t),ae(n)),e.h+=n.length)}function gn(e,t){return t=String(t),e.j?t.toLowerCase():t}(e=cn.prototype).add=function(e,t){hn(this),this.i=null,e=gn(this,e);var n=this.g.get(e);return n||this.g.set(e,n=[]),n.push(t),this.h+=1,this},e.forEach=function(n,r){hn(this),this.g.forEach(function(e,t){e.forEach(function(e){n.call(r,e,t,this)},this)},this)},e.oa=function(){hn(this);const e=Array.from(this.g.values()),n=Array.from(this.g.keys()),r=[];for(let t=0;t<n.length;t++){var s=e[t];for(let e=0;e<s.length;e++)r.push(n[t])}return r},e.W=function(t){hn(this);let n=[];if("string"==typeof t)dn(this,t)&&(n=n.concat(this.g.get(gn(this,t))));else{t=Array.from(this.g.values());for(let e=0;e<t.length;e++)n=n.concat(t[e])}return n},e.set=function(e,t){return hn(this),this.i=null,dn(this,e=gn(this,e))&&(this.h-=this.g.get(e).length),this.g.set(e,[t]),this.h+=1,this},e.get=function(e,t){return e&&0<(e=this.W(e)).length?String(e[0]):t},e.toString=function(){if(this.i)return this.i;if(!this.g)return"";const e=[],t=Array.from(this.g.keys());for(var n=0;n<t.length;n++)for(var r=t[n],s=encodeURIComponent(String(r)),i=this.W(r),r=0;r<i.length;r++){var a=s;""!==i[r]&&(a+="="+encodeURIComponent(String(i[r]))),e.push(a)}return this.i=e.join("&")};var mn,pn=class{constructor(e,t){this.h=e,this.g=t}};function yn(e){this.l=e||10,e=w.PerformanceNavigationTiming?0<(e=w.performance.getEntriesByType("navigation")).length&&("hq"==e[0].nextHopProtocol||"h2"==e[0].nextHopProtocol):!!(w.g&&w.g.Ga&&w.g.Ga()&&w.g.Ga().$b),this.j=e?this.l:1,this.g=null,1<this.j&&(this.g=new Set),this.h=null,this.i=[]}function vn(e){return e.h||e.g&&e.g.size>=e.j}function wn(e){return e.h?1:e.g?e.g.size:0}function In(e,t){return e.h?e.h==t:e.g&&e.g.has(t)}function bn(e,t){e.g?e.g.add(t):e.h=t}function En(e,t){e.h&&e.h==t?e.h=null:e.g&&e.g.has(t)&&e.g.delete(t)}function Tn(t){if(null!=t.h)return t.i.concat(t.h.D);if(null==t.g||0===t.g.size)return ae(t.i);{let e=t.i;for(const n of t.g.values())e=e.concat(n.D);return e}}function Sn(){}function _n(){this.g=new Sn}function xn(e,t,n,r,s){try{t.onload=null,t.onerror=null,t.onabort=null,t.ontimeout=null,s(r)}catch(e){}}function Dn(e){this.l=e.ac||null,this.j=e.jb||!1}function An(e,t){s.call(this),this.D=e,this.u=t,this.m=void 0,this.readyState=Cn,this.status=0,this.responseType=this.responseText=this.response=this.statusText="",this.onreadystatechange=null,this.v=new Headers,this.h=null,this.C="GET",this.B="",this.g=!1,this.A=this.j=this.l=null}yn.prototype.cancel=function(){if(this.i=Tn(this),this.h)this.h.cancel(),this.h=null;else if(this.g&&0!==this.g.size){for(const e of this.g.values())e.cancel();this.g.clear()}},Sn.prototype.stringify=function(e){return w.JSON.stringify(e,void 0)},Sn.prototype.parse=function(e){return w.JSON.parse(e,void 0)},re(Dn,St),Dn.prototype.g=function(){return new An(this.l,this.j)},Dn.prototype.i=(mn={},function(){return mn}),re(An,s);var Cn=0;function Nn(e){e.j.read().then(e.Ta.bind(e)).catch(e.ga.bind(e))}function kn(e){e.readyState=4,e.l=null,e.j=null,e.A=null,Rn(e)}function Rn(e){e.onreadystatechange&&e.onreadystatechange.call(e)}(e=An.prototype).open=function(e,t){if(this.readyState!=Cn)throw this.abort(),Error("Error reopening a connection");this.C=e,this.B=t,this.readyState=1,Rn(this)},e.send=function(e){if(1!=this.readyState)throw this.abort(),Error("need to call open() first. ");this.g=!0;const t={headers:this.v,method:this.C,credentials:this.m,cache:void 0};e&&(t.body=e),(this.D||w).fetch(new Request(this.B,t)).then(this.Wa.bind(this),this.ga.bind(this))},e.abort=function(){this.response=this.responseText="",this.v=new Headers,this.status=0,this.j&&this.j.cancel("Request was aborted.").catch(()=>{}),1<=this.readyState&&this.g&&4!=this.readyState&&(this.g=!1,kn(this)),this.readyState=Cn},e.Wa=function(e){if(this.g&&(this.l=e,this.h||(this.status=this.l.status,this.statusText=this.l.statusText,this.h=e.headers,this.readyState=2,Rn(this)),this.g&&(this.readyState=3,Rn(this),this.g)))if("arraybuffer"===this.responseType)e.arrayBuffer().then(this.Ua.bind(this),this.ga.bind(this));else if(void 0!==w.ReadableStream&&"body"in e){if(this.j=e.body.getReader(),this.u){if(this.responseType)throw Error('responseType must be empty for "streamBinaryChunks" mode responses.');this.response=[]}else this.response=this.responseText="",this.A=new TextDecoder;Nn(this)}else e.text().then(this.Va.bind(this),this.ga.bind(this))},e.Ta=function(e){var t;this.g&&(this.u&&e.value?this.response.push(e.value):this.u||(t=e.value||new Uint8Array(0),(t=this.A.decode(t,{stream:!e.done}))&&(this.response=this.responseText+=t)),(e.done?kn:Rn)(this),3==this.readyState&&Nn(this))},e.Va=function(e){this.g&&(this.response=this.responseText=e,kn(this))},e.Ua=function(e){this.g&&(this.response=e,kn(this))},e.ga=function(){this.g&&kn(this)},e.setRequestHeader=function(e,t){this.v.append(e,t)},e.getResponseHeader=function(e){return this.h&&this.h.get(e.toLowerCase())||""},e.getAllResponseHeaders=function(){if(!this.h)return"";const e=[],t=this.h.entries();for(var n=t.next();!n.done;)n=n.value,e.push(n[0]+": "+n[1]),n=t.next();return e.join("\r\n")},Object.defineProperty(An.prototype,"withCredentials",{get:function(){return"include"===this.m},set:function(e){this.m=e?"include":"same-origin"}});var Ln=w.JSON.parse;function r(e){s.call(this),this.headers=new Map,this.u=e||null,this.h=!1,this.C=this.g=null,this.H="",this.m=0,this.j="",this.l=this.F=this.v=this.D=!1,this.B=0,this.A=null,this.J=Mn,this.K=this.L=!1}re(r,s);var Mn="",On=/^https?$/i,Vn=["POST","PUT"];function Fn(e,t){e.h=!1,e.g&&(e.l=!0,e.g.abort(),e.l=!1),e.j=t,e.m=5,Pn(e),Un(e)}function Pn(e){e.D||(e.D=!0,$e(e,"complete"),$e(e,"error"))}function Bn(e){if(e.h&&(!e.C[1]||4!=Kn(e)||2!=e.aa()))if(e.v&&4==Kn(e))ot(e.Ha,0,e);else if($e(e,"readystatechange"),4==Kn(e)){e.h=!1;try{var t,n,r,s,i=e.aa();switch(i){case 200:case 201:case 202:case 204:case 206:case 304:case 1223:var a=!0;break;default:a=!1}if((t=a)||((n=0===i)&&(!(s=String(e.H).match(Ht)[1]||null)&&w.self&&w.self.location&&(s=(r=w.self.location.protocol).substr(0,r.length-1)),n=!On.test(s?s.toLowerCase():"")),t=n),t)$e(e,"complete"),$e(e,"success");else{e.m=6;try{var o=2<Kn(e)?e.g.statusText:""}catch(e){o=""}e.j=o+" ["+e.aa()+"]",Pn(e)}}finally{Un(e)}}}function Un(e,t){if(e.g){qn(e);const n=e.g,r=e.C[0]?Y:null;e.g=null,e.C=null,t||$e(e,"ready");try{n.onreadystatechange=r}catch(e){}}}function qn(e){e.g&&e.K&&(e.g.ontimeout=null),e.A&&(w.clearTimeout(e.A),e.A=null)}function Kn(e){return e.g?e.g.readyState:0}function Gn(e){try{if(!e.g)return null;if("response"in e.g)return e.g.response;switch(e.J){case Mn:case"text":return e.g.responseText;case"arraybuffer":if("mozResponseArrayBuffer"in e.g)return e.g.mozResponseArrayBuffer}return null}catch(e){return null}}function jn(e){let n="";return Le(e,function(e,t){n=(n=n+t+":")+e+"\r\n"}),n}function Qn(e,t,n){e:{for(r in n){var r=!1;break e}r=!0}r||(n=jn(n),"string"==typeof e?null!=n&&encodeURIComponent(String(n)):p(e,t,n))}function zn(e,t,n){return n&&n.internalChannelParams&&n.internalChannelParams[e]||t}function Hn(e){this.Ca=0,this.i=[],this.j=new ft,this.ka=this.sa=this.F=this.V=this.g=this.za=this.D=this.ia=this.o=this.S=this.s=null,this.ab=this.U=0,this.Za=zn("failFast",!1,e),this.L=this.v=this.u=this.m=this.l=null,this.Y=!0,this.pa=this.Ba=this.T=-1,this.Z=this.A=this.C=0,this.Xa=zn("baseRetryDelayMs",5e3,e),this.bb=zn("retryDelaySeedMs",1e4,e),this.$a=zn("forwardChannelMaxRetries",2,e),this.ta=zn("forwardChannelRequestTimeoutMs",2e4,e),this.ra=e&&e.xmlHttpFactory||void 0,this.Da=e&&e.Zb||!1,this.J=void 0,this.H=e&&e.supportsCrossDomainXhr||!1,this.I="",this.h=new yn(e&&e.concurrentRequestLimit),this.Fa=new _n,this.O=e&&e.fastHandshake||!1,this.N=e&&e.encodeInitMessageHeaders||!1,this.O&&this.N&&(this.N=!1),this.Ya=e&&e.Xb||!1,e&&e.Aa&&this.j.Aa(),e&&e.forceLongPolling&&(this.Y=!1),this.$=!this.O&&this.Y&&e&&e.detectBufferingProxy||!1,this.ja=void 0,this.P=0,this.K=!1,this.la=this.B=null}function Wn(e){var t,n;Yn(e),3==e.G&&(t=e.U++,p(n=$t(e.F),"SID",e.I),p(n,"RID",t),p(n,"TYPE","terminate"),Zn(e,n),(t=new Nt(e,e.j,t,void 0)).K=2,t.v=Zt($t(n)),n=!1,!(n=w.navigator&&w.navigator.sendBeacon?w.navigator.sendBeacon(t.v.toString(),""):n)&&w.Image&&((new Image).src=t.v,n=!0),n||(t.g=lr(t.l,null),t.g.da(t.v)),t.F=Date.now(),Ut(t)),cr(e)}function $n(e){e.g&&(rr(e),e.g.cancel(),e.g=null)}function Yn(e){$n(e),e.u&&(w.clearTimeout(e.u),e.u=null),ir(e),e.h.cancel(),e.m&&("number"==typeof e.m&&w.clearTimeout(e.m),e.m=null)}function Xn(e){vn(e.h)||e.m||(e.m=!0,tt(e.Ja,e),e.C=0)}function Jn(e,t){var n=t?t.m:e.U++,r=$t(e.F);p(r,"SID",e.I),p(r,"RID",n),p(r,"AID",e.T),Zn(e,r),e.o&&e.s&&Qn(r,e.o,e.s),n=new Nt(e,e.j,n,e.C+1),null===e.o&&(n.H=e.s),t&&(e.i=t.D.concat(e.i)),t=er(e,n,1e3),n.setTimeout(Math.round(.5*e.ta)+Math.round(.5*e.ta*Math.random())),bn(e.h,n),Vt(n,r,t)}function Zn(e,n){e.ia&&Le(e.ia,function(e,t){p(n,t,e)}),e.l&&zt({},function(e,t){p(n,t,e)})}function er(r,e,s){s=Math.min(r.i.length,s);var i=r.l?te(r.l.Ra,r.l,r):null;e:{var a=r.i;let n=-1;for(;;){const c=["count="+s];-1==n?0<s?(n=a[0].h,c.push("ofs="+n)):n=0:c.push("ofs="+n);let t=!0;for(let e=0;e<s;e++){var o=a[e].h,u=a[e].g;if((o-=n)<0)n=Math.max(0,a[e].h-100),t=!1;else try{!function(e,r){const s="req"+o+"_"||"";try{zt(e,function(e,t){let n=e;J(e)&&(n=Je(e)),r.push(s+t+"="+encodeURIComponent(n))})}catch(e){throw r.push(s+"type="+encodeURIComponent("_badmap")),e}}(u,c)}catch(r){i&&i(u)}}if(t){i=c.join("&");break e}}}return r=r.i.splice(0,s),e.D=r,i}function tr(e){e.g||e.u||(e.Z=1,tt(e.Ia,e),e.A=0)}function nr(e){return!(e.g||e.u||3<=e.A)&&(e.Z++,e.u=Tt(te(e.Ia,e),or(e,e.A)),e.A++,1)}function rr(e){null!=e.B&&(w.clearTimeout(e.B),e.B=null)}function sr(e){e.g=new Nt(e,e.j,"rpc",e.Z),null===e.o&&(e.g.H=e.s),e.g.N=0;var t=$t(e.sa),n=(p(t,"RID","rpc"),p(t,"SID",e.I),p(t,"CI",e.L?"0":"1"),p(t,"AID",e.T),p(t,"TYPE","xmlhttp"),Zn(e,t),e.o&&e.s&&Qn(t,e.o,e.s),e.J&&e.g.setTimeout(e.J),e.g);e=e.ka,n.K=1,n.v=Zt($t(t)),n.s=null,n.P=!0,Ft(n,e)}function ir(e){null!=e.v&&(w.clearTimeout(e.v),e.v=null)}function ar(e,t){var n,r,s,i=null;if(e.g==t){ir(e),rr(e),e.g=null;var a=2}else{if(!In(e.h,t))return;i=t.D,En(e.h,t),a=1}if(0!=e.G)if(e.pa=t.Y,t.i)1==a?(i=t.s?t.s.length:0,t=Date.now()-t.F,n=e.C,$e(a=yt(),new Et(a,i)),Xn(e)):tr(e);else if(3==(n=t.o)||0==n&&0<e.pa||(1!=a||(s=t,wn((r=e).h)>=r.h.j-(r.m?1:0)||(r.m?(r.i=s.D.concat(r.i),0):1==r.G||2==r.G||r.C>=(r.Za?0:r.$a)||(r.m=Tt(te(r.Ja,r,s),or(r,r.C)),r.C++,0))))&&(2!=a||!nr(e)))switch(i&&0<i.length&&(t=e.h,t.i=t.i.concat(i)),n){case 1:ur(e,5);break;case 4:ur(e,10);break;case 3:ur(e,6);break;default:ur(e,2)}}function or(e,t){let n=e.Xa+Math.floor(Math.random()*e.bb);return e.l||(n*=2),n*t}function ur(e,t){if(e.j.info("Error code "+t),2==t){n=null,e.l&&(n=null),r=te(e.kb,e),n||(n=new Wt("//www.google.com/images/cleardot.gif"),w.location&&"http"==w.location.protocol||Yt(n,"https"),Zt(n));var n=n.toString(),r,s=new ft;if(w.Image){const i=new Image;i.onload=ne(xn,s,i,"TestLoadImage: loaded",!0,r),i.onerror=ne(xn,s,i,"TestLoadImage: error",!1,r),i.onabort=ne(xn,s,i,"TestLoadImage: abort",!1,r),i.ontimeout=ne(xn,s,i,"TestLoadImage: timeout",!1,r),w.setTimeout(function(){i.ontimeout&&i.ontimeout()},1e4),i.src=n}else r(!1)}else bt(2);e.G=0,e.l&&e.l.va(t),cr(e),Yn(e)}function cr(e){var t;e.G=0,e.la=[],e.l&&(0==(t=Tn(e.h)).length&&0==e.i.length||(oe(e.la,t),oe(e.la,e.i),e.h.i.length=0,ae(e.i),e.i.length=0),e.l.ua())}function hr(e,t,n){var r,s,i=n instanceof Wt?$t(n):new Wt(n,void 0);return""!=i.g?(t&&(i.g=t+"."+i.g),Xt(i,i.m)):(i=(r=w.location).protocol,t=t?t+"."+r.hostname:r.hostname,r=+r.port,s=new Wt(null,void 0),i&&Yt(s,i),t&&(s.g=t),r&&Xt(s,r),n&&(s.l=n),i=s),n=e.D,t=e.za,n&&t&&p(i,n,t),p(i,"VER",e.ma),Zn(e,i),i}function lr(e,t,n){if(t&&!e.H)throw Error("Can't create secondary domain capable XhrIo object.");return(t=n&&e.Da&&!e.ra?new r(new Dn({jb:!0})):new r(e.ra)).Ka(e.H),t}function dr(){}function fr(){if(ve&&!(10<=Number(xe)))throw Error("Environmental error: no available transport.")}function gr(e,t){s.call(this),this.g=new Hn(t),this.l=e,this.h=t&&t.messageUrlParams||null,e=t&&t.messageHeaders||null,t&&t.clientProtocolHeaderRequired&&(e?e["X-Client-Protocol"]="webchannel":e={"X-Client-Protocol":"webchannel"}),this.g.s=e,e=t&&t.initMessageHeaders||null,t&&t.messageContentType&&(e?e["X-WebChannel-Content-Type"]=t.messageContentType:e={"X-WebChannel-Content-Type":t.messageContentType}),t&&t.ya&&(e?e["X-WebChannel-Client-Profile"]=t.ya:e={"X-WebChannel-Client-Profile":t.ya}),this.g.S=e,(e=t&&t.Yb)&&!he(e)&&(this.g.o=e),this.A=t&&t.supportsCrossDomainXhr||!1,this.v=t&&t.sendRawJson||!1,(t=t&&t.httpSessionIdParam)&&!he(t)&&(this.g.D=t,null!==(e=this.h)&&t in e&&t in(e=this.h)&&delete e[t]),this.j=new yr(this)}function mr(e){Dt.call(this);var t=e.__sm__;if(t){e:{for(const n in t){e=n;break e}e=void 0}(this.i=e)&&(e=this.i,t=null!==t&&e in t?t[e]:void 0),this.data=t}else this.data=e}function pr(){At.call(this),this.status=1}function yr(e){this.g=e}(e=r.prototype).Ka=function(e){this.L=e},e.da=function(e,t,n,r){if(this.g)throw Error("[goog.net.XhrIo] Object is active with another request="+this.H+"; newUri="+e);t=t?t.toUpperCase():"GET",this.H=e,this.j="",this.m=0,this.D=!1,this.h=!0,this.g=(this.u||Rt).g(),this.C=this.u?_t(this.u):_t(Rt),this.g.onreadystatechange=te(this.Ha,this);try{this.F=!0,this.g.open(t,String(e),!0),this.F=!1}catch(e){return void Fn(this,e)}if(e=n||"",n=new Map(this.headers),r)if(Object.getPrototypeOf(r)===Object.prototype)for(var s in r)n.set(s,r[s]);else{if("function"!=typeof r.keys||"function"!=typeof r.get)throw Error("Unknown input type for opt_headers: "+String(r));for(const h of r.keys())n.set(h,r.get(h))}r=Array.from(n.keys()).find(e=>"content-type"==e.toLowerCase()),s=w.FormData&&e instanceof w.FormData,0<=ie(Vn,t)&&!r&&!s&&n.set("Content-Type","application/x-www-form-urlencoded;charset=utf-8");for(var[i,a]of n)this.g.setRequestHeader(i,a);this.J&&(this.g.responseType=this.J),"withCredentials"in this.g&&this.g.withCredentials!==this.L&&(this.g.withCredentials=this.L);try{qn(this),0<this.B&&((this.K=(c=this.g,ve&&(o=function(){let t=0;var n=le(String(pe)).split("."),r=le("9").split("."),s=Math.max(n.length,r.length);for(let e=0;0==t&&e<s;e++)for(var i=n[e]||"",a=r[e]||"";i=/(\d*)(\D*)(.*)/.exec(i)||["","","",""],a=/(\d*)(\D*)(.*)/.exec(a)||["","","",""],(0!=i[0].length||0!=a[0].length)&&(t=de(0==i[1].length?0:parseInt(i[1],10),0==a[1].length?0:parseInt(a[1],10))||de(0==i[2].length,0==a[2].length)||de(i[2],a[2]),i=i[3],a=a[3],0==t););return 0<=t},u=_e,Object.prototype.hasOwnProperty.call(u,9)?u[9]:u[9]=o())&&"number"==typeof c.timeout&&void 0!==c.ontimeout))?(this.g.timeout=this.B,this.g.ontimeout=te(this.qa,this)):this.A=ot(this.qa,this.B,this)),this.v=!0,this.g.send(e),this.v=!1}catch(e){Fn(this,e)}var o,u,c},e.qa=function(){this.g&&(this.j="Timed out after "+this.B+"ms, aborting",this.m=8,$e(this,"timeout"),this.abort(8))},e.abort=function(e){this.g&&this.h&&(this.h=!1,this.l=!0,this.g.abort(),this.l=!1,this.m=e||7,$e(this,"complete"),$e(this,"abort"),Un(this))},e.M=function(){this.g&&(this.h&&(this.h=!1,this.l=!0,this.g.abort(),this.l=!1),Un(this,!0)),r.X.M.call(this)},e.Ha=function(){this.s||(this.F||this.v||this.l?Bn(this):this.fb())},e.fb=function(){Bn(this)},e.aa=function(){try{return 2<Kn(this)?this.g.status:-1}catch(e){return-1}},e.fa=function(){try{return this.g?this.g.responseText:""}catch(e){return""}},e.Sa=function(e){var t;if(this.g)return t=this.g.responseText,e&&0==t.indexOf(e)&&(t=t.substring(e.length)),Ln(t)},e.Ea=function(){return this.m},e.Oa=function(){return"string"==typeof this.j?this.j:String(this.j)},(e=Hn.prototype).ma=8,e.G=1,e.Ja=function(t){if(this.m)if(this.m=null,1==this.G){if(!t){this.U=Math.floor(1e5*Math.random()),t=this.U++;const i=new Nt(this,this.j,t,void 0);let e=this.s;if(this.S&&(e?Ve(e=Me(e),this.S):e=this.S),null!==this.o||this.N||(i.H=e,e=null),this.O)e:{for(var n=0,r=0;r<this.i.length;r++){var s=this.i[r];if(void 0===(s="__data__"in s.g&&"string"==typeof(s=s.g.__data__)?s.length:void 0))break;if(4096<(n+=s)){n=r;break e}if(4096===n||r===this.i.length-1){n=r+1;break e}}n=1e3}else n=1e3;n=er(this,i,n),p(r=$t(this.F),"RID",t),p(r,"CVER",22),this.D&&p(r,"X-HTTP-Session-Id",this.D),Zn(this,r),e&&(this.N?n="headers="+encodeURIComponent(String(jn(e)))+"&"+n:this.o&&Qn(r,this.o,e)),bn(this.h,i),this.Ya&&p(r,"TYPE","init"),this.O?(p(r,"$req",n),p(r,"SID","null"),i.Z=!0,Vt(i,r,null)):Vt(i,r,n),this.G=2}}else 3==this.G&&(t?Jn(this,t):0==this.i.length||vn(this.h)||Jn(this))},e.Ia=function(){var e;this.u=null,sr(this),this.$&&!(this.K||null==this.g||this.P<=0)&&(e=2*this.P,this.j.info("BP detection timer enabled: "+e),this.B=Tt(te(this.eb,this),e))},e.eb=function(){this.B&&(this.B=null,this.j.info("BP detection timeout reached."),this.j.info("Buffering proxy detected and switch to long-polling!"),this.L=!1,this.K=!0,bt(10),$n(this),sr(this))},e.cb=function(){null!=this.v&&(this.v=null,$n(this),nr(this),bt(19))},e.kb=function(e){e?(this.j.info("Successfully pinged google.com"),bt(2)):(this.j.info("Failed to ping google.com"),bt(1))},(e=dr.prototype).xa=function(){},e.wa=function(){},e.va=function(){},e.ua=function(){},e.Ra=function(){},fr.prototype.g=function(e,t){return new gr(e,t)},re(gr,s),gr.prototype.m=function(){this.g.l=this.j,this.A&&(this.g.H=!0);var e=this.g,t=this.l,n=this.h||void 0;bt(0),e.V=t,e.ia=n||{},e.L=e.Y,e.F=hr(e,null,e.V),Xn(e)},gr.prototype.close=function(){Wn(this.g)},gr.prototype.u=function(e){var t,n=this.g;"string"==typeof e?((t={}).__data__=e,e=t):this.v&&((t={}).__data__=Je(e),e=t),n.i.push(new pn(n.ab++,e)),3==n.G&&Xn(n)},gr.prototype.M=function(){this.g.l=null,delete this.j,Wn(this.g),delete this.g,gr.X.M.call(this)},re(mr,Dt),re(pr,At),re(yr,dr),yr.prototype.xa=function(){$e(this.g,"a")},yr.prototype.wa=function(e){$e(this.g,new mr(e))},yr.prototype.va=function(e){$e(this.g,new pr)},yr.prototype.ua=function(){$e(this.g,"b")},fr.prototype.createWebChannel=fr.prototype.g,gr.prototype.send=gr.prototype.u,gr.prototype.open=gr.prototype.m,be.NO_ERROR=0,be.TIMEOUT=8,be.HTTP_ERROR=6,ye.COMPLETE="complete",(xt.EventType=$).OPEN="a",$.CLOSE="b",$.ERROR="c",$.MESSAGE="d",s.prototype.listen=s.prototype.N,r.prototype.listenOnce=r.prototype.O,r.prototype.getLastError=r.prototype.Oa,r.prototype.getLastErrorCode=r.prototype.Ea,r.prototype.getStatus=r.prototype.aa,r.prototype.getResponseJson=r.prototype.Sa,r.prototype.getResponseText=r.prototype.fa,r.prototype.send=r.prototype.da,r.prototype.setWithCredentials=r.prototype.Ka;var d,vr,wr=yt,Ir=be,br=ye,Er=mt,Tr=Dn,Sr=xt,_r=r,Se="@firebase/firestore";class o{constructor(e){this.uid=e}isAuthenticated(){return null!=this.uid}toKey(){return this.isAuthenticated()?"uid:"+this.uid:"anonymous-user"}isEqual(e){return e.uid===this.uid}}o.UNAUTHENTICATED=new o(null),o.GOOGLE_CREDENTIALS=new o("google-credentials-uid"),o.FIRST_PARTY=new o("first-party-uid"),o.MOCK_USER=new o("mock-user");let xr="9.14.0";const Dr=new class{constructor(e){this.name=e,this._logLevel=z,this._logHandler=W,this._userLogHandler=null}get logLevel(){return this._logLevel}set logLevel(e){if(!(e in l))throw new TypeError(`Invalid value "${e}" assigned to \`logLevel\``);this._logLevel=e}setLogLevel(e){this._logLevel="string"==typeof e?Q[e]:e}get logHandler(){return this._logHandler}set logHandler(e){if("function"!=typeof e)throw new TypeError("Value assigned to `logHandler` must be a function");this._logHandler=e}get userLogHandler(){return this._userLogHandler}set userLogHandler(e){this._userLogHandler=e}debug(...e){this._userLogHandler&&this._userLogHandler(this,l.DEBUG,...e),this._logHandler(this,l.DEBUG,...e)}log(...e){this._userLogHandler&&this._userLogHandler(this,l.VERBOSE,...e),this._logHandler(this,l.VERBOSE,...e)}info(...e){this._userLogHandler&&this._userLogHandler(this,l.INFO,...e),this._logHandler(this,l.INFO,...e)}warn(...e){this._userLogHandler&&this._userLogHandler(this,l.WARN,...e),this._logHandler(this,l.WARN,...e)}error(...e){this._userLogHandler&&this._userLogHandler(this,l.ERROR,...e),this._logHandler(this,l.ERROR,...e)}}("@firebase/firestore");function Ar(){return Dr.logLevel}function f(e,...t){Dr.logLevel<=l.DEBUG&&(t=t.map(Nr),Dr.debug(`Firestore (${xr}): `+e,...t))}function g(e,...t){Dr.logLevel<=l.ERROR&&(t=t.map(Nr),Dr.error(`Firestore (${xr}): `+e,...t))}function Cr(e,...t){Dr.logLevel<=l.WARN&&(t=t.map(Nr),Dr.warn(`Firestore (${xr}): `+e,...t))}function Nr(t){if("string"==typeof t)return t;try{return JSON.stringify(t)}catch(e){return t}}function E(e="Unexpected state"){e=`FIRESTORE (${xr}) INTERNAL ASSERTION FAILED: `+e;throw g(e),new Error(e)}function y(e){e||E()}const I={OK:"ok",CANCELLED:"cancelled",UNKNOWN:"unknown",INVALID_ARGUMENT:"invalid-argument",DEADLINE_EXCEEDED:"deadline-exceeded",NOT_FOUND:"not-found",ALREADY_EXISTS:"already-exists",PERMISSION_DENIED:"permission-denied",UNAUTHENTICATED:"unauthenticated",RESOURCE_EXHAUSTED:"resource-exhausted",FAILED_PRECONDITION:"failed-precondition",ABORTED:"aborted",OUT_OF_RANGE:"out-of-range",UNIMPLEMENTED:"unimplemented",INTERNAL:"internal",UNAVAILABLE:"unavailable",DATA_LOSS:"data-loss"};class b extends q{constructor(e,t){super(e,t),this.code=e,this.message=t,this.toString=()=>`${this.name}: [code=${this.code}]: `+this.message}}class m{constructor(){this.promise=new Promise((e,t)=>{this.resolve=e,this.reject=t})}}class kr{constructor(e,t){this.user=t,this.type="OAuth",this.headers=new Map,this.headers.set("Authorization","Bearer "+e)}}class Rr{getToken(){return Promise.resolve(null)}invalidateToken(){}start(e,t){e.enqueueRetryable(()=>t(o.UNAUTHENTICATED))}shutdown(){}}class Lr{constructor(e){this.token=e,this.changeListener=null}getToken(){return Promise.resolve(this.token)}invalidateToken(){}start(e,t){this.changeListener=t,e.enqueueRetryable(()=>t(this.token.user))}shutdown(){this.changeListener=null}}class Mr{constructor(e){this.t=e,this.currentUser=o.UNAUTHENTICATED,this.i=0,this.forceRefresh=!1,this.auth=null}start(t,n){let r=this.i;const s=e=>this.i!==r?(r=this.i,n(e)):Promise.resolve();let i=new m;this.o=()=>{this.i++,this.currentUser=this.u(),i.resolve(),i=new m,t.enqueueRetryable(()=>s(this.currentUser))};const a=()=>{const e=i;t.enqueueRetryable(async()=>{await e.promise,await s(this.currentUser)})},o=e=>{f("FirebaseAuthCredentialsProvider","Auth detected"),this.auth=e,this.auth.addAuthTokenListener(this.o),a()};this.t.onInit(e=>o(e)),setTimeout(()=>{var e;this.auth||((e=this.t.getImmediate({optional:!0}))?o(e):(f("FirebaseAuthCredentialsProvider","Auth not yet detected"),i.resolve(),i=new m))},0),a()}getToken(){const t=this.i,e=this.forceRefresh;return this.forceRefresh=!1,this.auth?this.auth.getToken(e).then(e=>this.i!==t?(f("FirebaseAuthCredentialsProvider","getToken aborted due to token change."),this.getToken()):e?(y("string"==typeof e.accessToken),new kr(e.accessToken,this.currentUser)):null):Promise.resolve(null)}invalidateToken(){this.forceRefresh=!0}shutdown(){this.auth&&this.auth.removeAuthTokenListener(this.o)}u(){var e=this.auth&&this.auth.getUid();return y(null===e||"string"==typeof e),new o(e)}}class Or{constructor(e,t,n,r){this.h=e,this.l=t,this.m=n,this.g=r,this.type="FirstParty",this.user=o.FIRST_PARTY,this.p=new Map}I(){return this.g?this.g():(y(!("object"!=typeof this.h||null===this.h||!this.h.auth||!this.h.auth.getAuthHeaderValueForFirstParty)),this.h.auth.getAuthHeaderValueForFirstParty([]))}get headers(){this.p.set("X-Goog-AuthUser",this.l);var e=this.I();return e&&this.p.set("Authorization",e),this.m&&this.p.set("X-Goog-Iam-Authorization-Token",this.m),this.p}}class Vr{constructor(e,t,n,r){this.h=e,this.l=t,this.m=n,this.g=r}getToken(){return Promise.resolve(new Or(this.h,this.l,this.m,this.g))}start(e,t){e.enqueueRetryable(()=>t(o.FIRST_PARTY))}shutdown(){}invalidateToken(){}}class Fr{constructor(e){this.value=e,this.type="AppCheck",this.headers=new Map,e&&0<e.length&&this.headers.set("x-firebase-appcheck",this.value)}}class Pr{constructor(e){this.T=e,this.forceRefresh=!1,this.appCheck=null,this.A=null}start(t,n){const r=e=>{null!=e.error&&f("FirebaseAppCheckTokenProvider","Error getting App Check token; using placeholder token instead. Error: "+e.error.message);var t=e.token!==this.A;return this.A=e.token,f("FirebaseAppCheckTokenProvider",`Received ${t?"new":"existing"} token.`),t?n(e.token):Promise.resolve()},s=(this.o=e=>{t.enqueueRetryable(()=>r(e))},e=>{f("FirebaseAppCheckTokenProvider","AppCheck detected"),this.appCheck=e,this.appCheck.addTokenListener(this.o)});this.T.onInit(e=>s(e)),setTimeout(()=>{var e;this.appCheck||((e=this.T.getImmediate({optional:!0}))?s(e):f("FirebaseAppCheckTokenProvider","AppCheck not yet detected"))},0)}getToken(){var e=this.forceRefresh;return this.forceRefresh=!1,this.appCheck?this.appCheck.getToken(e).then(e=>e?(y("string"==typeof e.token),this.A=e.token,new Fr(e.token)):null):Promise.resolve(null)}invalidateToken(){this.forceRefresh=!0}shutdown(){this.appCheck&&this.appCheck.removeTokenListener(this.o)}}class Br{static R(){var t="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789",n=Math.floor(256/t.length)*t.length;let r="";for(;r.length<20;){var s=function(){const e="undefined"!=typeof self&&(self.crypto||self.msCrypto),t=new Uint8Array(40);if(e&&"function"==typeof e.getRandomValues)e.getRandomValues(t);else for(let e=0;e<40;e++)t[e]=Math.floor(256*Math.random());return t}();for(let e=0;e<s.length;++e)r.length<20&&s[e]<n&&(r+=t.charAt(s[e]%t.length))}return r}}function T(e,t){return e<t?-1:t<e?1:0}function Ur(e,n,r){return e.length===n.length&&e.every((e,t)=>r(e,n[t]))}function qr(e){return e+"\0"}class h{constructor(e,t){if(this.seconds=e,(this.nanoseconds=t)<0)throw new b(I.INVALID_ARGUMENT,"Timestamp nanoseconds out of range: "+t);if(1e9<=t)throw new b(I.INVALID_ARGUMENT,"Timestamp nanoseconds out of range: "+t);if(e<-62135596800)throw new b(I.INVALID_ARGUMENT,"Timestamp seconds out of range: "+e);if(253402300800<=e)throw new b(I.INVALID_ARGUMENT,"Timestamp seconds out of range: "+e)}static now(){return h.fromMillis(Date.now())}static fromDate(e){return h.fromMillis(e.getTime())}static fromMillis(e){var t=Math.floor(e/1e3),e=Math.floor(1e6*(e-1e3*t));return new h(t,e)}toDate(){return new Date(this.toMillis())}toMillis(){return 1e3*this.seconds+this.nanoseconds/1e6}_compareTo(e){return this.seconds===e.seconds?T(this.nanoseconds,e.nanoseconds):T(this.seconds,e.seconds)}isEqual(e){return e.seconds===this.seconds&&e.nanoseconds===this.nanoseconds}toString(){return"Timestamp(seconds="+this.seconds+", nanoseconds="+this.nanoseconds+")"}toJSON(){return{seconds:this.seconds,nanoseconds:this.nanoseconds}}valueOf(){var e=this.seconds- -62135596800;return String(e).padStart(12,"0")+"."+String(this.nanoseconds).padStart(9,"0")}}class S{constructor(e){this.timestamp=e}static fromTimestamp(e){return new S(e)}static min(){return new S(new h(0,0))}static max(){return new S(new h(253402300799,999999999))}compareTo(e){return this.timestamp._compareTo(e.timestamp)}isEqual(e){return this.timestamp.isEqual(e.timestamp)}toMicroseconds(){return 1e6*this.timestamp.seconds+this.timestamp.nanoseconds/1e3}toString(){return"SnapshotVersion("+this.timestamp.toString()+")"}toTimestamp(){return this.timestamp}}class Kr{constructor(e,t,n){void 0===t?t=0:t>e.length&&E(),void 0===n?n=e.length-t:n>e.length-t&&E(),this.segments=e,this.offset=t,this.len=n}get length(){return this.len}isEqual(e){return 0===Kr.comparator(this,e)}child(e){const t=this.segments.slice(this.offset,this.limit());return e instanceof Kr?e.forEach(e=>{t.push(e)}):t.push(e),this.construct(t)}limit(){return this.offset+this.length}popFirst(e){return this.construct(this.segments,this.offset+(e=void 0===e?1:e),this.length-e)}popLast(){return this.construct(this.segments,this.offset,this.length-1)}firstSegment(){return this.segments[this.offset]}lastSegment(){return this.get(this.length-1)}get(e){return this.segments[this.offset+e]}isEmpty(){return 0===this.length}isPrefixOf(t){if(t.length<this.length)return!1;for(let e=0;e<this.length;e++)if(this.get(e)!==t.get(e))return!1;return!0}isImmediateParentOf(t){if(this.length+1!==t.length)return!1;for(let e=0;e<this.length;e++)if(this.get(e)!==t.get(e))return!1;return!0}forEach(n){for(let e=this.offset,t=this.limit();e<t;e++)n(this.segments[e])}toArray(){return this.segments.slice(this.offset,this.limit())}static comparator(t,n){const r=Math.min(t.length,n.length);for(let e=0;e<r;e++){const r=t.get(e),s=n.get(e);if(r<s)return-1;if(r>s)return 1}return t.length<n.length?-1:t.length>n.length?1:0}}class _ extends Kr{construct(e,t,n){return new _(e,t,n)}canonicalString(){return this.toArray().join("/")}toString(){return this.canonicalString()}static fromString(...e){const t=[];for(const n of e){if(0<=n.indexOf("//"))throw new b(I.INVALID_ARGUMENT,`Invalid segment (${n}). Paths must not contain // in them.`);t.push(...n.split("/").filter(e=>0<e.length))}return new _(t)}static emptyPath(){return new _([])}}const Gr=/^[_a-zA-Z][_a-zA-Z0-9]*$/;class x extends Kr{construct(e,t,n){return new x(e,t,n)}static isValidIdentifier(e){return Gr.test(e)}canonicalString(){return this.toArray().map(e=>(e=e.replace(/\\/g,"\\\\").replace(/`/g,"\\`"),e=x.isValidIdentifier(e)?e:"`"+e+"`")).join(".")}toString(){return this.canonicalString()}isKeyField(){return 1===this.length&&"__name__"===this.get(0)}static keyField(){return new x(["__name__"])}static fromServerFormat(e){const t=[];let n="",r=0;var s=()=>{if(0===n.length)throw new b(I.INVALID_ARGUMENT,`Invalid field path (${e}). Paths must not be empty, begin with '.', end with '.', or contain '..'`);t.push(n),n=""};let i=!1;for(;r<e.length;){const t=e[r];if("\\"===t){if(r+1===e.length)throw new b(I.INVALID_ARGUMENT,"Path has trailing escape character: "+e);const t=e[r+1];if("\\"!==t&&"."!==t&&"`"!==t)throw new b(I.INVALID_ARGUMENT,"Path has invalid escape sequence: "+e);n+=t,r+=2}else"`"===t?i=!i:"."!==t||i?n+=t:s(),r++}if(s(),i)throw new b(I.INVALID_ARGUMENT,"Unterminated ` in path: "+e);return new x(t)}static emptyPath(){return new x([])}}class D{constructor(e){this.path=e}static fromPath(e){return new D(_.fromString(e))}static fromName(e){return new D(_.fromString(e).popFirst(5))}static empty(){return new D(_.emptyPath())}get collectionGroup(){return this.path.popLast().lastSegment()}hasCollectionId(e){return 2<=this.path.length&&this.path.get(this.path.length-2)===e}getCollectionGroup(){return this.path.get(this.path.length-2)}getCollectionPath(){return this.path.popLast()}isEqual(e){return null!==e&&0===_.comparator(this.path,e.path)}toString(){return this.path.toString()}static comparator(e,t){return _.comparator(e.path,t.path)}static isDocumentKey(e){return e.length%2==0}static fromSegments(e){return new D(new _(e.slice()))}}class jr{constructor(e,t,n,r){this.indexId=e,this.collectionGroup=t,this.fields=n,this.indexState=r}}function Qr(e){return e.fields.find(e=>2===e.kind)}function zr(e){return e.fields.filter(e=>2!==e.kind)}jr.UNKNOWN_ID=-1;class Hr{constructor(e,t){this.fieldPath=e,this.kind=t}}class Wr{constructor(e,t){this.sequenceNumber=e,this.offset=t}static empty(){return new Wr(0,Xr.min())}}function $r(e,t){var n=e.toTimestamp().seconds,e=e.toTimestamp().nanoseconds+1,e=S.fromTimestamp(1e9===e?new h(n+1,0):new h(n,e));return new Xr(e,D.empty(),t)}function Yr(e){return new Xr(e.readTime,e.key,-1)}class Xr{constructor(e,t,n){this.readTime=e,this.documentKey=t,this.largestBatchId=n}static min(){return new Xr(S.min(),D.empty(),-1)}static max(){return new Xr(S.max(),D.empty(),-1)}}function Jr(e,t){let n=e.readTime.compareTo(t.readTime);return 0!==n?n:0!==(n=D.comparator(e.documentKey,t.documentKey))?n:T(e.largestBatchId,t.largestBatchId)}const Zr="The current tab is not in the required state to perform this operation. It might be necessary to refresh the browser tab.";class es{constructor(){this.onCommittedListeners=[]}addOnCommittedListener(e){this.onCommittedListeners.push(e)}raiseOnCommittedEvent(){this.onCommittedListeners.forEach(e=>e())}}async function ts(e){if(e.code!==I.FAILED_PRECONDITION||e.message!==Zr)throw e;f("LocalStore","Unexpectedly lost primary lease")}class A{constructor(e){this.nextCallback=null,this.catchCallback=null,this.result=void 0,this.error=void 0,this.isDone=!1,this.callbackAttached=!1,e(e=>{this.isDone=!0,this.result=e,this.nextCallback&&this.nextCallback(e)},e=>{this.isDone=!0,this.error=e,this.catchCallback&&this.catchCallback(e)})}catch(e){return this.next(void 0,e)}next(r,s){return this.callbackAttached&&E(),this.callbackAttached=!0,this.isDone?this.error?this.wrapFailure(s,this.error):this.wrapSuccess(r,this.result):new A((t,n)=>{this.nextCallback=e=>{this.wrapSuccess(r,e).next(t,n)},this.catchCallback=e=>{this.wrapFailure(s,e).next(t,n)}})}toPromise(){return new Promise((e,t)=>{this.next(e,t)})}wrapUserFunction(e){try{var t=e();return t instanceof A?t:A.resolve(t)}catch(e){return A.reject(e)}}wrapSuccess(e,t){return e?this.wrapUserFunction(()=>e(t)):A.resolve(t)}wrapFailure(e,t){return e?this.wrapUserFunction(()=>e(t)):A.reject(t)}static resolve(n){return new A((e,t)=>{e(n)})}static reject(n){return new A((e,t)=>{t(n)})}static waitFor(e){return new A((t,n)=>{let r=0,s=0,i=!1;e.forEach(e=>{++r,e.next(()=>{++s,i&&s===r&&t()},e=>n(e))}),i=!0,s===r&&t()})}static or(e){let t=A.resolve(!1);for(const n of e)t=t.next(e=>e?A.resolve(e):n());return t}static forEach(e,n){const r=[];return e.forEach((e,t)=>{r.push(n.call(this,e,t))}),this.waitFor(r)}static mapArray(o,u){return new A((t,n)=>{const r=o.length,s=new Array(r);let i=0;for(let e=0;e<r;e++){const a=e;u(o[a]).next(e=>{s[a]=e,++i===r&&t(s)},e=>n(e))}})}static doWhile(r,s){return new A((e,t)=>{const n=()=>{!0===r()?s().next(()=>{n()},t):e()};n()})}}class ns{constructor(t,e){this.action=t,this.transaction=e,this.aborted=!1,this.P=new m,this.transaction.oncomplete=()=>{this.P.resolve()},this.transaction.onabort=()=>{e.error?this.P.reject(new is(t,e.error)):this.P.resolve()},this.transaction.onerror=e=>{e=hs(e.target.error);this.P.reject(new is(t,e))}}static open(e,t,n,r){try{return new ns(t,e.transaction(r,n))}catch(e){throw new is(t,e)}}get v(){return this.P.promise}abort(e){e&&this.P.reject(e),this.aborted||(f("SimpleDb","Aborting transaction:",e?e.message:"Client-initiated abort"),this.aborted=!0,this.transaction.abort())}V(){const e=this.transaction;this.aborted||"function"!=typeof e.commit||e.commit()}store(e){e=this.transaction.objectStore(e);return new os(e)}}class rs{constructor(e,t,n){this.name=e,this.version=t,this.S=n,12.2===rs.D(U())&&g("Firestore persistence suffers from a bug in iOS 12.2 Safari that may cause your app to stop working. See https://stackoverflow.com/q/56496296/110915 for details and a potential workaround.")}static delete(e){return f("SimpleDb","Removing database:",e),us(window.indexedDB.deleteDatabase(e)).toPromise()}static C(){if("object"!=typeof indexedDB)return!1;if(rs.N())return!0;const e=U(),t=rs.D(e),n=0<t&&t<10,r=rs.k(e),s=0<r&&r<4.5;return!(0<e.indexOf("MSIE ")||0<e.indexOf("Trident/")||0<e.indexOf("Edge/")||n||s)}static N(){var e;return"undefined"!=typeof process&&"YES"===(null==(e=process.env)?void 0:e.O)}static M(e,t){return e.store(t)}static D(e){const t=e.match(/i(?:phone|pad|pod) os ([\d_]+)/i),n=t?t[1].split("_").slice(0,2).join("."):"-1";return Number(n)}static k(e){const t=e.match(/Android ([\d.]+)/i),n=t?t[1].split(".").slice(0,2).join("."):"-1";return Number(n)}async F(s){return this.db||(f("SimpleDb","Opening database:",this.name),this.db=await new Promise((t,n)=>{const r=indexedDB.open(this.name,this.version);r.onsuccess=e=>{e=e.target.result;t(e)},r.onblocked=()=>{n(new is(s,"Cannot upgrade IndexedDB schema while another tab is open. Close all tabs that access Firestore and reload this page to proceed."))},r.onerror=e=>{e=e.target.error;"VersionError"===e.name?n(new b(I.FAILED_PRECONDITION,"A newer version of the Firestore SDK was previously used and so the persisted data is not compatible with the version of the SDK you are now using. The SDK will operate with persistence disabled. If you need persistence, please re-upgrade to a newer version of the SDK or else clear the persisted IndexedDB data for your app to start fresh.")):"InvalidStateError"===e.name?n(new b(I.FAILED_PRECONDITION,"Unable to open an IndexedDB connection. This could be due to running in a private browsing session on a browser whose private browsing sessions do not support IndexedDB: "+e)):n(new is(s,e))},r.onupgradeneeded=e=>{f("SimpleDb",'Database "'+this.name+'" requires upgrade from version:',e.oldVersion);var t=e.target.result;this.S.$(t,r.transaction,e.oldVersion,this.version).next(()=>{f("SimpleDb","Database upgrade to version "+this.version+" complete")})}})),this.B&&(this.db.onversionchange=e=>this.B(e)),this.db}L(t){this.B=t,this.db&&(this.db.onversionchange=e=>t(e))}async runTransaction(e,t,n,r){var s="readonly"===t;let i=0;for(;;){++i;try{this.db=await this.F(e);const t=ns.open(this.db,e,s?"readonly":"readwrite",n),i=r(t).next(e=>(t.V(),e)).catch(e=>(t.abort(e),A.reject(e))).toPromise();return i.catch(()=>{}),await t.v,i}catch(e){const t=e,n="FirebaseError"!==t.name&&i<3;if(f("SimpleDb","Transaction failed with error:",t.message,"Retrying:",n),this.close(),!n)return Promise.reject(t)}}}close(){this.db&&this.db.close(),this.db=void 0}}class ss{constructor(e){this.U=e,this.q=!1,this.K=null}get isDone(){return this.q}get G(){return this.K}set cursor(e){this.U=e}done(){this.q=!0}j(e){this.K=e}delete(){return us(this.U.delete())}}class is extends b{constructor(e,t){super(I.UNAVAILABLE,`IndexedDB transaction '${e}' failed: `+t),this.name="IndexedDbTransactionError"}}function as(e){return"IndexedDbTransactionError"===e.name}class os{constructor(e){this.store=e}put(e,t){return us(void 0!==t?(f("SimpleDb","PUT",this.store.name,e,t),this.store.put(t,e)):(f("SimpleDb","PUT",this.store.name,"<auto-key>",e),this.store.put(e)))}add(e){return f("SimpleDb","ADD",this.store.name,e,e),us(this.store.add(e))}get(t){return us(this.store.get(t)).next(e=>(f("SimpleDb","GET",this.store.name,t,e=void 0===e?null:e),e))}delete(e){return f("SimpleDb","DELETE",this.store.name,e),us(this.store.delete(e))}count(){return f("SimpleDb","COUNT",this.store.name),us(this.store.count())}W(e,n){var t=this.options(e,n);if(t.index||"function"!=typeof this.store.getAll){const e=this.cursor(t),n=[];return this.H(e,(e,t)=>{n.push(t)}).next(()=>n)}{const e=this.store.getAll(t.range);return new A((t,n)=>{e.onerror=e=>{n(e.target.error)},e.onsuccess=e=>{t(e.target.result)}})}}J(e,t){const r=this.store.getAll(e,null===t?void 0:t);return new A((t,n)=>{r.onerror=e=>{n(e.target.error)},r.onsuccess=e=>{t(e.target.result)}})}Y(e,t){f("SimpleDb","DELETE ALL",this.store.name);const n=this.options(e,t);n.X=!1;e=this.cursor(n);return this.H(e,(e,t,n)=>n.delete())}Z(e,t){let n;t?n=e:(n={},t=e);e=this.cursor(n);return this.H(e,t)}tt(r){const e=this.cursor({});return new A((n,t)=>{e.onerror=e=>{e=hs(e.target.error);t(e)},e.onsuccess=e=>{const t=e.target.result;t?r(t.primaryKey,t.value).next(e=>{e?t.continue():n()}):n()}})}H(e,i){const a=[];return new A((s,t)=>{e.onerror=e=>{t(e.target.error)},e.onsuccess=e=>{const t=e.target.result;if(t){const n=new ss(t),r=i(t.primaryKey,t.value,n);if(r instanceof A){const e=r.catch(e=>(n.done(),A.reject(e)));a.push(e)}n.isDone?s():null===n.G?t.continue():t.continue(n.G)}else s()}}).next(()=>A.waitFor(a))}options(e,t){let n;return void 0!==e&&("string"==typeof e?n=e:t=e),{index:n,range:t}}cursor(e){let t="next";if(e.reverse&&(t="prev"),e.index){const n=this.store.index(e.index);return e.X?n.openKeyCursor(e.range,t):n.openCursor(e.range,t)}return this.store.openCursor(e.range,t)}}function us(e){return new A((t,n)=>{e.onsuccess=e=>{e=e.target.result;t(e)},e.onerror=e=>{e=hs(e.target.error);n(e)}})}let cs=!1;function hs(e){const t=rs.D(U());if(12.2<=t&&t<13){const t="An internal error was encountered in the Indexed Database server";if(0<=e.message.indexOf(t)){const e=new b("internal",`IOS_INDEXEDDB_BUG1: IndexedDb has thrown '${t}'. This is likely due to an unavoidable bug in iOS. See https://stackoverflow.com/q/56496296/110915 for details and a potential workaround.`);return cs||(cs=!0,setTimeout(()=>{throw e},0)),e}}return e}class ls{constructor(e,t){this.asyncQueue=e,this.et=t,this.task=null}start(){this.nt(15e3)}stop(){this.task&&(this.task.cancel(),this.task=null)}get started(){return null!==this.task}nt(e){f("IndexBackiller",`Scheduled in ${e}ms`),this.task=this.asyncQueue.enqueueAfterDelay("index_backfill",e,async()=>{this.task=null;try{f("IndexBackiller","Documents written: "+await this.et.st())}catch(e){as(e)?f("IndexBackiller","Ignoring IndexedDB error during index backfill: ",e):await ts(e)}await this.nt(6e4)})}}class ds{constructor(e,t){this.localStore=e,this.persistence=t}async st(t=50){return this.persistence.runTransaction("Backfill Indexes","readwrite-primary",e=>this.it(e,t))}it(e,t){const n=new Set;let r=t,s=!0;return A.doWhile(()=>!0===s&&0<r,()=>this.localStore.indexManager.getNextCollectionGroupToUpdate(e).next(t=>null===t||n.has(t)?void(s=!1):(f("IndexBackiller","Processing collection: "+t),this.rt(e,t,r).next(e=>{r-=e,n.add(t)})))).next(()=>t-r)}rt(r,s,e){return this.localStore.indexManager.getMinOffsetFromCollectionGroup(r,s).next(n=>this.localStore.localDocuments.getNextDocuments(r,s,n,e).next(e=>{const t=e.changes;return this.localStore.indexManager.updateIndexEntries(r,t).next(()=>this.ot(n,e)).next(e=>(f("IndexBackiller","Updating offset: "+e),this.localStore.indexManager.updateCollectionGroup(r,s,e))).next(()=>t.size)}))}ot(e,t){let n=e;return t.changes.forEach((e,t)=>{t=Yr(t);0<Jr(t,n)&&(n=t)}),new Xr(n.readTime,n.documentKey,Math.max(t.batchId,e.largestBatchId))}}class fs{constructor(e,t){this.previousValue=e,t&&(t.sequenceNumberHandler=e=>this.ut(e),this.ct=e=>t.writeSequenceNumber(e))}ut(e){return this.previousValue=Math.max(e,this.previousValue),this.previousValue}next(){var e=++this.previousValue;return this.ct&&this.ct(e),e}}function gs(e){let t=0;for(const n in e)Object.prototype.hasOwnProperty.call(e,n)&&t++;return t}function ms(e,t){for(const n in e)Object.prototype.hasOwnProperty.call(e,n)&&t(n,e[n])}function ps(e){for(const t in e)if(Object.prototype.hasOwnProperty.call(e,t))return!1;return!0}fs.at=-1;class C{constructor(e,t){this.comparator=e,this.root=t||vs.EMPTY}insert(e,t){return new C(this.comparator,this.root.insert(e,t,this.comparator).copy(null,null,vs.BLACK,null,null))}remove(e){return new C(this.comparator,this.root.remove(e,this.comparator).copy(null,null,vs.BLACK,null,null))}get(e){let t=this.root;for(;!t.isEmpty();){var n=this.comparator(e,t.key);if(0===n)return t.value;n<0?t=t.left:0<n&&(t=t.right)}return null}indexOf(e){let t=0,n=this.root;for(;!n.isEmpty();){var r=this.comparator(e,n.key);if(0===r)return t+n.left.size;n=r<0?n.left:(t+=n.left.size+1,n.right)}return-1}isEmpty(){return this.root.isEmpty()}get size(){return this.root.size}minKey(){return this.root.minKey()}maxKey(){return this.root.maxKey()}inorderTraversal(e){return this.root.inorderTraversal(e)}forEach(n){this.inorderTraversal((e,t)=>(n(e,t),!1))}toString(){const n=[];return this.inorderTraversal((e,t)=>(n.push(e+":"+t),!1)),`{${n.join(", ")}}`}reverseTraversal(e){return this.root.reverseTraversal(e)}getIterator(){return new ys(this.root,null,this.comparator,!1)}getIteratorFrom(e){return new ys(this.root,e,this.comparator,!1)}getReverseIterator(){return new ys(this.root,null,this.comparator,!0)}getReverseIteratorFrom(e){return new ys(this.root,e,this.comparator,!0)}}class ys{constructor(e,t,n,r){this.isReverse=r,this.nodeStack=[];let s=1;for(;!e.isEmpty();)if(s=t?n(e.key,t):1,t&&r&&(s*=-1),s<0)e=this.isReverse?e.left:e.right;else{if(0===s){this.nodeStack.push(e);break}this.nodeStack.push(e),e=this.isReverse?e.right:e.left}}getNext(){let e=this.nodeStack.pop();var t={key:e.key,value:e.value};if(this.isReverse)for(e=e.left;!e.isEmpty();)this.nodeStack.push(e),e=e.right;else for(e=e.right;!e.isEmpty();)this.nodeStack.push(e),e=e.left;return t}hasNext(){return 0<this.nodeStack.length}peek(){if(0===this.nodeStack.length)return null;var e=this.nodeStack[this.nodeStack.length-1];return{key:e.key,value:e.value}}}class vs{constructor(e,t,n,r,s){this.key=e,this.value=t,this.color=null!=n?n:vs.RED,this.left=null!=r?r:vs.EMPTY,this.right=null!=s?s:vs.EMPTY,this.size=this.left.size+1+this.right.size}copy(e,t,n,r,s){return new vs(null!=e?e:this.key,null!=t?t:this.value,null!=n?n:this.color,null!=r?r:this.left,null!=s?s:this.right)}isEmpty(){return!1}inorderTraversal(e){return this.left.inorderTraversal(e)||e(this.key,this.value)||this.right.inorderTraversal(e)}reverseTraversal(e){return this.right.reverseTraversal(e)||e(this.key,this.value)||this.left.reverseTraversal(e)}min(){return this.left.isEmpty()?this:this.left.min()}minKey(){return this.min().key}maxKey(){return this.right.isEmpty()?this.key:this.right.maxKey()}insert(e,t,n){let r=this;var s=n(e,r.key);return(r=s<0?r.copy(null,null,null,r.left.insert(e,t,n),null):0===s?r.copy(null,t,null,null,null):r.copy(null,null,null,null,r.right.insert(e,t,n))).fixUp()}removeMin(){if(this.left.isEmpty())return vs.EMPTY;let e=this;return(e=(e=e.left.isRed()||e.left.left.isRed()?e:e.moveRedLeft()).copy(null,null,null,e.left.removeMin(),null)).fixUp()}remove(e,t){let n,r=this;if(t(e,r.key)<0)r=(r=r.left.isEmpty()||r.left.isRed()||r.left.left.isRed()?r:r.moveRedLeft()).copy(null,null,null,r.left.remove(e,t),null);else{if(0===t(e,(r=(r=r.left.isRed()?r.rotateRight():r).right.isEmpty()||r.right.isRed()||r.right.left.isRed()?r:r.moveRedRight()).key)){if(r.right.isEmpty())return vs.EMPTY;n=r.right.min(),r=r.copy(n.key,n.value,null,null,r.right.removeMin())}r=r.copy(null,null,null,null,r.right.remove(e,t))}return r.fixUp()}isRed(){return this.color}fixUp(){let e=this;return e=(e=(e=e.right.isRed()&&!e.left.isRed()?e.rotateLeft():e).left.isRed()&&e.left.left.isRed()?e.rotateRight():e).left.isRed()&&e.right.isRed()?e.colorFlip():e}moveRedLeft(){let e=this.colorFlip();return e=e.right.left.isRed()?(e=(e=e.copy(null,null,null,null,e.right.rotateRight())).rotateLeft()).colorFlip():e}moveRedRight(){let e=this.colorFlip();return e=e.left.left.isRed()?(e=e.rotateRight()).colorFlip():e}rotateLeft(){var e=this.copy(null,null,vs.RED,null,this.right.left);return this.right.copy(null,null,this.color,e,null)}rotateRight(){var e=this.copy(null,null,vs.RED,this.left.right,null);return this.left.copy(null,null,this.color,null,e)}colorFlip(){var e=this.left.copy(null,null,!this.left.color,null,null),t=this.right.copy(null,null,!this.right.color,null,null);return this.copy(null,null,!this.color,e,t)}checkMaxDepth(){var e=this.check();return Math.pow(2,e)<=this.size+1}check(){if(this.isRed()&&this.left.isRed())throw E();if(this.right.isRed())throw E();var e=this.left.check();if(e!==this.right.check())throw E();return e+(this.isRed()?0:1)}}vs.EMPTY=null,vs.RED=!0,vs.BLACK=!1,vs.EMPTY=new class{constructor(){this.size=0}get key(){throw E()}get value(){throw E()}get color(){throw E()}get left(){throw E()}get right(){throw E()}copy(e,t,n,r,s){return this}insert(e,t,n){return new vs(e,t)}remove(e,t){return this}isEmpty(){return!0}inorderTraversal(e){return!1}reverseTraversal(e){return!1}minKey(){return null}maxKey(){return null}isRed(){return!1}checkMaxDepth(){return!0}check(){return 0}};class N{constructor(e){this.comparator=e,this.data=new C(this.comparator)}has(e){return null!==this.data.get(e)}first(){return this.data.minKey()}last(){return this.data.maxKey()}get size(){return this.data.size}indexOf(e){return this.data.indexOf(e)}forEach(n){this.data.inorderTraversal((e,t)=>(n(e),!1))}forEachInRange(e,t){const n=this.data.getIteratorFrom(e[0]);for(;n.hasNext();){var r=n.getNext();if(0<=this.comparator(r.key,e[1]))return;t(r.key)}}forEachWhile(e,t){let n;for(n=void 0!==t?this.data.getIteratorFrom(t):this.data.getIterator();n.hasNext();)if(!e(n.getNext().key))return}firstAfterOrEqual(e){const t=this.data.getIteratorFrom(e);return t.hasNext()?t.getNext().key:null}getIterator(){return new ws(this.data.getIterator())}getIteratorFrom(e){return new ws(this.data.getIteratorFrom(e))}add(e){return this.copy(this.data.remove(e).insert(e,!0))}delete(e){return this.has(e)?this.copy(this.data.remove(e)):this}isEmpty(){return this.data.isEmpty()}unionWith(e){let t=this;return t.size<e.size&&(t=e,e=this),e.forEach(e=>{t=t.add(e)}),t}isEqual(e){if(!(e instanceof N))return!1;if(this.size!==e.size)return!1;const t=this.data.getIterator(),n=e.data.getIterator();for(;t.hasNext();){const e=t.getNext().key,r=n.getNext().key;if(0!==this.comparator(e,r))return!1}return!0}toArray(){const t=[];return this.forEach(e=>{t.push(e)}),t}toString(){const t=[];return this.forEach(e=>t.push(e)),"SortedSet("+t.toString()+")"}copy(e){const t=new N(this.comparator);return t.data=e,t}}class ws{constructor(e){this.iter=e}getNext(){return this.iter.getNext().key}hasNext(){return this.iter.hasNext()}}function Is(e){return e.hasNext()?e.getNext():void 0}class bs{constructor(e){(this.fields=e).sort(x.comparator)}static empty(){return new bs([])}unionWith(e){let t=new N(x.comparator);for(const e of this.fields)t=t.add(e);for(const n of e)t=t.add(n);return new bs(t.toArray())}covers(e){for(const t of this.fields)if(t.isPrefixOf(e))return!0;return!1}isEqual(e){return Ur(this.fields,e.fields,(e,t)=>e.isEqual(t))}}class k{constructor(e){this.binaryString=e}static fromBase64String(e){e=atob(e);return new k(e)}static fromUint8Array(e){e=function(t){let n="";for(let e=0;e<t.length;++e)n+=String.fromCharCode(t[e]);return n}(e);return new k(e)}[Symbol.iterator](){let e=0;return{next:()=>e<this.binaryString.length?{value:this.binaryString.charCodeAt(e++),done:!1}:{value:void 0,done:!0}}}toBase64(){return e=this.binaryString,btoa(e);var e}toUint8Array(){{var t=this.binaryString;const n=new Uint8Array(t.length);for(let e=0;e<t.length;e++)n[e]=t.charCodeAt(e);return n}}approximateByteSize(){return 2*this.binaryString.length}compareTo(e){return T(this.binaryString,e.binaryString)}isEqual(e){return this.binaryString===e.binaryString}}k.EMPTY_BYTE_STRING=new k("");const Es=new RegExp(/^\d{4}-\d\d-\d\dT\d\d:\d\d:\d\d(?:\.(\d+))?Z$/);function Ts(t){if(y(!!t),"string"!=typeof t)return{seconds:R(t.seconds),nanos:R(t.nanos)};{let e=0;var n=Es.exec(t);y(!!n),n[1]&&(n=(n[1]+"000000000").substr(0,9),e=Number(n));const r=new Date(t);return{seconds:Math.floor(r.getTime()/1e3),nanos:e}}}function R(e){return"number"==typeof e?e:"string"==typeof e?Number(e):0}function Ss(e){return"string"==typeof e?k.fromBase64String(e):k.fromUint8Array(e)}function _s(e){return"server_timestamp"===(null==(e=((null==(e=null==e?void 0:e.mapValue)?void 0:e.fields)||{}).__type__)?void 0:e.stringValue)}function xs(e){e=Ts(e.mapValue.fields.__local_write_time__.timestampValue);return new h(e.seconds,e.nanos)}class Ds{constructor(e,t,n,r,s,i,a,o){this.databaseId=e,this.appId=t,this.persistenceKey=n,this.host=r,this.ssl=s,this.forceLongPolling=i,this.autoDetectLongPolling=a,this.useFetchStreams=o}}class As{constructor(e,t){this.projectId=e,this.database=t||"(default)"}static empty(){return new As("","")}get isDefaultDatabase(){return"(default)"===this.database}isEqual(e){return e instanceof As&&e.projectId===this.projectId&&e.database===this.database}}function Cs(e){return null==e}function Ns(e){return 0===e&&1/e==-1/0}function ks(e){return"number"==typeof e&&Number.isInteger(e)&&!Ns(e)&&e<=Number.MAX_SAFE_INTEGER&&e>=Number.MIN_SAFE_INTEGER}const Rs={mapValue:{fields:{__type__:{stringValue:"__max__"}}}},Ls={nullValue:"NULL_VALUE"};function Ms(e){return"nullValue"in e?0:"booleanValue"in e?1:"integerValue"in e||"doubleValue"in e?2:"timestampValue"in e?3:"stringValue"in e?5:"bytesValue"in e?6:"referenceValue"in e?7:"geoPointValue"in e?8:"arrayValue"in e?9:"mapValue"in e?_s(e)?4:Hs(e)?9007199254740991:10:E()}function Os(e,t){if(e===t)return!0;var n,r=Ms(e);if(r!==Ms(t))return!1;switch(r){case 0:case 9007199254740991:return!0;case 1:return e.booleanValue===t.booleanValue;case 4:return xs(e).isEqual(xs(t));case 3:var s=t;if("string"==typeof e.timestampValue&&"string"==typeof s.timestampValue&&e.timestampValue.length===s.timestampValue.length)return e.timestampValue===s.timestampValue;var i=Ts(e.timestampValue),s=Ts(s.timestampValue);return i.seconds===s.seconds&&i.nanos===s.nanos;case 5:return e.stringValue===t.stringValue;case 6:return n=t,Ss(e.bytesValue).isEqual(Ss(n.bytesValue));case 7:return e.referenceValue===t.referenceValue;case 8:return i=t,R((n=e).geoPointValue.latitude)===R(i.geoPointValue.latitude)&&R(n.geoPointValue.longitude)===R(i.geoPointValue.longitude);case 2:return s=t,"integerValue"in(n=e)&&"integerValue"in s?R(n.integerValue)===R(s.integerValue):"doubleValue"in n&&"doubleValue"in s&&((n=R(n.doubleValue))===(s=R(s.doubleValue))?Ns(n)===Ns(s):isNaN(n)&&isNaN(s));case 9:return Ur(e.arrayValue.values||[],t.arrayValue.values||[],Os);case 10:{var a=e;const o=a.mapValue.fields||{},u=t.mapValue.fields||{};if(gs(o)!==gs(u))return!1;for(const a in o)if(o.hasOwnProperty(a)&&(void 0===u[a]||!Os(o[a],u[a])))return!1;return!0;return}default:return E()}}function Vs(e,t){return void 0!==(e.values||[]).find(e=>Os(e,t))}function Fs(e,t){if(e===t)return 0;var n=Ms(e),r=Ms(t);if(n!==r)return T(n,r);switch(n){case 0:case 9007199254740991:return 0;case 1:return T(e.booleanValue,t.booleanValue);case 2:return f=t,(s=R(e.integerValue||e.doubleValue))<(c=R(f.integerValue||f.doubleValue))?-1:c<s?1:s===c?0:isNaN(s)?isNaN(c)?0:-1:1;case 3:return Ps(e.timestampValue,t.timestampValue);case 4:return Ps(xs(e),xs(t));case 5:return T(e.stringValue,t.stringValue);case 6:{var s=e.bytesValue;var i=t.bytesValue;const p=Ss(s),y=Ss(i);return p.compareTo(y);return}case 7:var i=e.referenceValue,a=t.referenceValue,o=i.split("/"),u=a.split("/");for(let e=0;e<o.length&&e<u.length;e++){const a=T(o[e],u[e]);if(0!==a)return a}return T(o.length,u.length);case 8:return a=e.geoPointValue,f=t.geoPointValue,0!==(c=T(R(a.latitude),R(f.latitude)))?c:T(R(a.longitude),R(f.longitude));case 9:var c=e.arrayValue,h=t.arrayValue,l=c.values||[],d=h.values||[];for(let e=0;e<l.length&&e<d.length;++e){const h=Fs(l[e],d[e]);if(h)return h}return T(l.length,d.length);case 10:{var f=e.mapValue;var g=t.mapValue;if(f===Rs.mapValue&&g===Rs.mapValue)return 0;if(f===Rs.mapValue)return 1;if(g===Rs.mapValue)return-1;const v=f.fields||{},w=Object.keys(v),I=g.fields||{},b=Object.keys(I);w.sort(),b.sort();for(let e=0;e<w.length&&e<b.length;++e){const g=T(w[e],b[e]);if(0!==g)return g;var m=Fs(v[w[e]],I[b[e]]);if(0!==m)return m}return T(w.length,b.length);return}default:throw E()}}function Ps(e,t){if("string"==typeof e&&"string"==typeof t&&e.length===t.length)return T(e,t);var e=Ts(e),t=Ts(t),n=T(e.seconds,t.seconds);return 0!==n?n:T(e.nanos,t.nanos)}function Bs(e){return function n(r){{if("nullValue"in r)return"null";if("booleanValue"in r)return""+r.booleanValue;if("integerValue"in r)return""+r.integerValue;if("doubleValue"in r)return""+r.doubleValue;if("timestampValue"in r)return`time(${(e=Ts(r.timestampValue)).seconds},${e.nanos})`;if("stringValue"in r)return r.stringValue;if("bytesValue"in r)return Ss(r.bytesValue).toBase64();if("referenceValue"in r)return t=r.referenceValue,D.fromName(t).toString();if("geoPointValue"in r)return`geo(${(t=r.geoPointValue).latitude},${t.longitude})`;if("arrayValue"in r){let e="[",t=!0;for(const i of r.arrayValue.values||[])t?t=!1:e+=",",e+=n(i);return e+"]"}if("mapValue"in r){var s=r.mapValue;let e="{",t=!0;for(const a of Object.keys(s.fields||{}).sort())t?t=!1:e+=",",e+=a+":"+n(s.fields[a]);return e+"}"}return E()}var e,t}(e)}function Us(e,t){return{referenceValue:`projects/${e.projectId}/databases/${e.database}/documents/`+t.path.canonicalString()}}function qs(e){return e&&"integerValue"in e}function Ks(e){return!!e&&"arrayValue"in e}function Gs(e){return e&&"nullValue"in e}function js(e){return e&&"doubleValue"in e&&isNaN(Number(e.doubleValue))}function Qs(e){return e&&"mapValue"in e}function zs(t){if(t.geoPointValue)return{geoPointValue:Object.assign({},t.geoPointValue)};if(t.timestampValue&&"object"==typeof t.timestampValue)return{timestampValue:Object.assign({},t.timestampValue)};if(t.mapValue){const n={mapValue:{fields:{}}};return ms(t.mapValue.fields,(e,t)=>n.mapValue.fields[e]=zs(t)),n}if(t.arrayValue){const r={arrayValue:{values:[]}};for(let e=0;e<(t.arrayValue.values||[]).length;++e)r.arrayValue.values[e]=zs(t.arrayValue.values[e]);return r}return Object.assign({},t)}function Hs(e){return"__max__"===(((e.mapValue||{}).fields||{}).__type__||{}).stringValue}function Ws(e,t){var n=Fs(e.value,t.value);return 0!==n?n:e.inclusive&&!t.inclusive?-1:!e.inclusive&&t.inclusive?1:0}function $s(e,t){var n=Fs(e.value,t.value);return 0!==n?n:e.inclusive&&!t.inclusive?1:!e.inclusive&&t.inclusive?-1:0}class Ys{constructor(e){this.value=e}static empty(){return new Ys({mapValue:{}})}field(n){if(n.isEmpty())return this.value;{let t=this.value;for(let e=0;e<n.length-1;++e)if(!Qs(t=(t.mapValue.fields||{})[n.get(e)]))return null;return(t=(t.mapValue.fields||{})[n.lastSegment()])||null}}set(e,t){this.getFieldsMap(e.popLast())[e.lastSegment()]=zs(t)}setAll(e){let n=x.emptyPath(),r={},s=[];e.forEach((e,t)=>{if(!n.isImmediateParentOf(t)){const e=this.getFieldsMap(n);this.applyChanges(e,r,s),r={},s=[],n=t.popLast()}e?r[t.lastSegment()]=zs(e):s.push(t.lastSegment())});e=this.getFieldsMap(n);this.applyChanges(e,r,s)}delete(e){const t=this.field(e.popLast());Qs(t)&&t.mapValue.fields&&delete t.mapValue.fields[e.lastSegment()]}isEqual(e){return Os(this.value,e.value)}getFieldsMap(n){let r=this.value;r.mapValue.fields||(r.mapValue={fields:{}});for(let t=0;t<n.length;++t){let e=r.mapValue.fields[n.get(t)];Qs(e)&&e.mapValue.fields||(e={mapValue:{fields:{}}},r.mapValue.fields[n.get(t)]=e),r=e}return r.mapValue.fields}applyChanges(n,e,t){ms(e,(e,t)=>n[e]=t);for(const e of t)delete n[e]}clone(){return new Ys(zs(this.value))}}class L{constructor(e,t,n,r,s,i){this.key=e,this.documentType=t,this.version=n,this.readTime=r,this.data=s,this.documentState=i}static newInvalidDocument(e){return new L(e,0,S.min(),S.min(),Ys.empty(),0)}static newFoundDocument(e,t,n){return new L(e,1,t,S.min(),n,0)}static newNoDocument(e,t){return new L(e,2,t,S.min(),Ys.empty(),0)}static newUnknownDocument(e,t){return new L(e,3,t,S.min(),Ys.empty(),2)}convertToFoundDocument(e,t){return this.version=e,this.documentType=1,this.data=t,this.documentState=0,this}convertToNoDocument(e){return this.version=e,this.documentType=2,this.data=Ys.empty(),this.documentState=0,this}convertToUnknownDocument(e){return this.version=e,this.documentType=3,this.data=Ys.empty(),this.documentState=2,this}setHasCommittedMutations(){return this.documentState=2,this}setHasLocalMutations(){return this.documentState=1,this.version=S.min(),this}setReadTime(e){return this.readTime=e,this}get hasLocalMutations(){return 1===this.documentState}get hasCommittedMutations(){return 2===this.documentState}get hasPendingWrites(){return this.hasLocalMutations||this.hasCommittedMutations}isValidDocument(){return 0!==this.documentType}isFoundDocument(){return 1===this.documentType}isNoDocument(){return 2===this.documentType}isUnknownDocument(){return 3===this.documentType}isEqual(e){return e instanceof L&&this.key.isEqual(e.key)&&this.version.isEqual(e.version)&&this.documentType===e.documentType&&this.documentState===e.documentState&&this.data.isEqual(e.data)}mutableCopy(){return new L(this.key,this.documentType,this.version,this.readTime,this.data.clone(),this.documentState)}toString(){return`Document(${this.key}, ${this.version}, ${JSON.stringify(this.data.value)}, {documentType: ${this.documentType}}), {documentState: ${this.documentState}})`}}class Xs{constructor(e,t=null,n=[],r=[],s=null,i=null,a=null){this.path=e,this.collectionGroup=t,this.orderBy=n,this.filters=r,this.limit=s,this.startAt=i,this.endAt=a,this.ht=null}}function Js(e,t=null,n=[],r=[],s=null,i=null,a=null){return new Xs(e,t,n,r,s,i,a)}function Zs(e){const t=e;if(null===t.ht){let e=t.path.canonicalString();null!==t.collectionGroup&&(e+="|cg:"+t.collectionGroup),e=(e=(e+="|f:")+t.filters.map(e=>{return(e=e).field.canonicalString()+e.op.toString()+Bs(e.value)}).join(",")+"|ob:")+t.orderBy.map(e=>{return e.field.canonicalString()+e.dir}).join(","),Cs(t.limit)||(e=(e+="|l:")+t.limit),t.startAt&&(e=(e=(e+="|lb:")+(t.startAt.inclusive?"b:":"a:"))+t.startAt.position.map(e=>Bs(e)).join(",")),t.endAt&&(e=(e=(e+="|ub:")+(t.endAt.inclusive?"a:":"b:"))+t.endAt.position.map(e=>Bs(e)).join(",")),t.ht=e}return t.ht}function ei(t,n){if(t.limit!==n.limit)return!1;if(t.orderBy.length!==n.orderBy.length)return!1;for(let e=0;e<t.orderBy.length;e++)if(r=t.orderBy[e],s=n.orderBy[e],r.dir!==s.dir||!r.field.isEqual(s.field))return!1;var r,s,i,a;if(t.filters.length!==n.filters.length)return!1;for(let e=0;e<t.filters.length;e++)if(i=t.filters[e],a=n.filters[e],i.op!==a.op||!i.field.isEqual(a.field)||!Os(i.value,a.value))return!1;return t.collectionGroup===n.collectionGroup&&!!t.path.isEqual(n.path)&&!!yi(t.startAt,n.startAt)&&yi(t.endAt,n.endAt)}function ti(e){return D.isDocumentKey(e.path)&&null===e.collectionGroup&&0===e.filters.length}function ni(e,t){return e.filters.filter(e=>e instanceof ii&&e.field.isEqual(t))}function ri(t,n,r){let s=Ls,i=!0;for(const r of ni(t,n)){let e=Ls,t=!0;switch(r.op){case"<":case"<=":e="nullValue"in(a=r.value)?Ls:"booleanValue"in a?{booleanValue:!1}:"integerValue"in a||"doubleValue"in a?{doubleValue:NaN}:"timestampValue"in a?{timestampValue:{seconds:Number.MIN_SAFE_INTEGER}}:"stringValue"in a?{stringValue:""}:"bytesValue"in a?{bytesValue:""}:"referenceValue"in a?Us(As.empty(),D.empty()):"geoPointValue"in a?{geoPointValue:{latitude:-90,longitude:-180}}:"arrayValue"in a?{arrayValue:{}}:"mapValue"in a?{mapValue:{}}:E();break;case"==":case"in":case">=":e=r.value;break;case">":e=r.value,t=!1;break;case"!=":case"not-in":e=Ls}Ws({value:s,inclusive:i},{value:e,inclusive:t})<0&&(s=e,i=t)}var a;if(null!==r)for(let e=0;e<t.orderBy.length;++e)if(t.orderBy[e].field.isEqual(n)){const t=r.position[e];Ws({value:s,inclusive:i},{value:t,inclusive:r.inclusive})<0&&(s=t,i=r.inclusive);break}return{value:s,inclusive:i}}function si(t,n,r){let s=Rs,i=!0;for(const r of ni(t,n)){let e=Rs,t=!0;switch(r.op){case">=":case">":e="nullValue"in(a=r.value)?{booleanValue:!1}:"booleanValue"in a?{doubleValue:NaN}:"integerValue"in a||"doubleValue"in a?{timestampValue:{seconds:Number.MIN_SAFE_INTEGER}}:"timestampValue"in a?{stringValue:""}:"stringValue"in a?{bytesValue:""}:"bytesValue"in a?Us(As.empty(),D.empty()):"referenceValue"in a?{geoPointValue:{latitude:-90,longitude:-180}}:"geoPointValue"in a?{arrayValue:{}}:"arrayValue"in a?{mapValue:{}}:"mapValue"in a?Rs:E(),t=!1;break;case"==":case"in":case"<=":e=r.value;break;case"<":e=r.value,t=!1;break;case"!=":case"not-in":e=Rs}0<$s({value:s,inclusive:i},{value:e,inclusive:t})&&(s=e,i=t)}var a;if(null!==r)for(let e=0;e<t.orderBy.length;++e)if(t.orderBy[e].field.isEqual(n)){const t=r.position[e];0<$s({value:s,inclusive:i},{value:t,inclusive:r.inclusive})&&(s=t,i=r.inclusive);break}return{value:s,inclusive:i}}class ii extends class{}{constructor(e,t,n){super(),this.field=e,this.op=t,this.value=n}static create(e,t,n){return e.isKeyField()?"in"===t||"not-in"===t?this.lt(e,t,n):new ai(e,t,n):"array-contains"===t?new hi(e,n):"in"===t?new li(e,n):"not-in"===t?new di(e,n):"array-contains-any"===t?new fi(e,n):new ii(e,t,n)}static lt(e,t,n){return new("in"===t?oi:ui)(e,n)}matches(e){e=e.data.field(this.field);return"!="===this.op?null!==e&&this.ft(Fs(e,this.value)):null!==e&&Ms(this.value)===Ms(e)&&this.ft(Fs(e,this.value))}ft(e){switch(this.op){case"<":return e<0;case"<=":return e<=0;case"==":return 0===e;case"!=":return 0!==e;case">":return 0<e;case">=":return 0<=e;default:return E()}}dt(){return 0<=["<","<=",">",">=","!=","not-in"].indexOf(this.op)}}class ai extends ii{constructor(e,t,n){super(e,t,n),this.key=D.fromName(n.referenceValue)}matches(e){e=D.comparator(e.key,this.key);return this.ft(e)}}class oi extends ii{constructor(e,t){super(e,"in",t),this.keys=ci(0,t)}matches(t){return this.keys.some(e=>e.isEqual(t.key))}}class ui extends ii{constructor(e,t){super(e,"not-in",t),this.keys=ci(0,t)}matches(t){return!this.keys.some(e=>e.isEqual(t.key))}}function ci(e,t){return((null==(t=t.arrayValue)?void 0:t.values)||[]).map(e=>D.fromName(e.referenceValue))}class hi extends ii{constructor(e,t){super(e,"array-contains",t)}matches(e){e=e.data.field(this.field);return Ks(e)&&Vs(e.arrayValue,this.value)}}class li extends ii{constructor(e,t){super(e,"in",t)}matches(e){e=e.data.field(this.field);return null!==e&&Vs(this.value.arrayValue,e)}}class di extends ii{constructor(e,t){super(e,"not-in",t)}matches(e){if(Vs(this.value.arrayValue,{nullValue:"NULL_VALUE"}))return!1;e=e.data.field(this.field);return null!==e&&!Vs(this.value.arrayValue,e)}}class fi extends ii{constructor(e,t){super(e,"array-contains-any",t)}matches(e){const t=e.data.field(this.field);return!(!Ks(t)||!t.arrayValue.values)&&t.arrayValue.values.some(e=>Vs(this.value.arrayValue,e))}}class gi{constructor(e,t){this.position=e,this.inclusive=t}}class mi{constructor(e,t="asc"){this.field=e,this.dir=t}}function pi(t,n,r){let s=0;for(let e=0;e<t.position.length;e++){const i=n[e],a=t.position[e];if(s=i.field.isKeyField()?D.comparator(D.fromName(a.referenceValue),r.key):Fs(a,r.data.field(i.field)),"desc"===i.dir&&(s*=-1),0!==s)break}return s}function yi(t,n){if(null===t)return null===n;if(null===n)return!1;if(t.inclusive!==n.inclusive||t.position.length!==n.position.length)return!1;for(let e=0;e<t.position.length;e++)if(!Os(t.position[e],n.position[e]))return!1;return!0}class vi{constructor(e,t=null,n=[],r=[],s=null,i="F",a=null,o=null){this.path=e,this.collectionGroup=t,this.explicitOrderBy=n,this.filters=r,this.limit=s,this.limitType=i,this.startAt=a,this.endAt=o,this._t=null,this.wt=null,this.startAt,this.endAt}}function wi(e,t,n,r,s,i,a,o){return new vi(e,t,n,r,s,i,a,o)}function Ii(e){return new vi(e)}function bi(e){return 0===e.filters.length&&null===e.limit&&null==e.startAt&&null==e.endAt&&(0===e.explicitOrderBy.length||1===e.explicitOrderBy.length&&e.explicitOrderBy[0].field.isKeyField())}function Ei(e){return 0<e.explicitOrderBy.length?e.explicitOrderBy[0].field:null}function Ti(e){for(const t of e.filters)if(t.dt())return t.field;return null}function Si(e){return null!==e.collectionGroup}function _i(t){const n=t;if(null===n._t){n._t=[];const t=Ti(n),e=Ei(n);if(null!==t&&null===e)t.isKeyField()||n._t.push(new mi(t)),n._t.push(new mi(x.keyField(),"asc"));else{let e=!1;for(const r of n.explicitOrderBy)n._t.push(r),r.field.isKeyField()&&(e=!0);if(!e){const t=0<n.explicitOrderBy.length?n.explicitOrderBy[n.explicitOrderBy.length-1].dir:"asc";n._t.push(new mi(x.keyField(),t))}}}return n._t}function xi(e){const t=e;if(!t.wt)if("F"===t.limitType)t.wt=Js(t.path,t.collectionGroup,_i(t),t.filters,t.limit,t.startAt,t.endAt);else{const e=[];for(const s of _i(t)){const t="desc"===s.dir?"asc":"desc";e.push(new mi(s.field,t))}var n=t.endAt?new gi(t.endAt.position,t.endAt.inclusive):null,r=t.startAt?new gi(t.startAt.position,t.startAt.inclusive):null;t.wt=Js(t.path,t.collectionGroup,e,t.filters,t.limit,n,r)}return t.wt}function Di(e,t,n){return new vi(e.path,e.collectionGroup,e.explicitOrderBy.slice(),e.filters.slice(),t,n,e.startAt,e.endAt)}function Ai(e,t){return ei(xi(e),xi(t))&&e.limitType===t.limitType}function Ci(e){return Zs(xi(e))+"|lt:"+e.limitType}function Ni(e){return`Query(target=${function(e){let t=e.path.canonicalString();return null!==e.collectionGroup&&(t+=" collectionGroup="+e.collectionGroup),0<e.filters.length&&(t+=`, filters: [${e.filters.map(e=>{return`${(e=e).field.canonicalString()} ${e.op} `+Bs(e.value)}).join(", ")}]`),Cs(e.limit)||(t+=", limit: "+e.limit),0<e.orderBy.length&&(t+=`, orderBy: [${e.orderBy.map(e=>{return`${e.field.canonicalString()} (${e.dir})`}).join(", ")}]`),e.startAt&&(t=(t=(t+=", startAt: ")+(e.startAt.inclusive?"b:":"a:"))+e.startAt.position.map(e=>Bs(e)).join(",")),`Target(${t=e.endAt?(t=(t+=", endAt: ")+(e.endAt.inclusive?"a:":"b:"))+e.endAt.position.map(e=>Bs(e)).join(","):t})`}(xi(e))}; limitType=${e.limitType})`}function ki(n,e){return e.isFoundDocument()&&(a=(i=e).key.path,null!==(s=n).collectionGroup?i.key.hasCollectionId(s.collectionGroup)&&s.path.isPrefixOf(a):D.isDocumentKey(s.path)?s.path.isEqual(a):s.path.isImmediateParentOf(a))&&function(e){for(const t of n.explicitOrderBy)if(!t.field.isKeyField()&&null===e.data.field(t.field))return;return 1}(e)&&function(e){for(const t of n.filters)if(!t.matches(e))return;return 1}(e)&&(s=e,(!(e=n).startAt||(r=pi(t=e.startAt,_i(e),s),t.inclusive?r<=0:r<0))&&(!e.endAt||(r=pi(t=e.endAt,_i(e),s),t.inclusive?0<=r:0<r)));var t,r,s,i,a}function Ri(e){return e.collectionGroup||(e.path.length%2==1?e.path.lastSegment():e.path.get(e.path.length-2))}function Li(s){return(e,t)=>{let n=!1;for(const r of _i(s)){const s=function(e,t,n){var r,s=e.field.isKeyField()?D.comparator(t.key,n.key):(r=e.field,n=n,t=t.data.field(r),n=n.data.field(r),null!==t&&null!==n?Fs(t,n):E());switch(e.dir){case"asc":return s;case"desc":return-1*s;default:return E()}}(r,e,t);if(0!==s)return s;n=n||r.field.isKeyField()}return 0}}function Mi(e,t){if(e.gt){if(isNaN(t))return{doubleValue:"NaN"};if(t===1/0)return{doubleValue:"Infinity"};if(t===-1/0)return{doubleValue:"-Infinity"}}return{doubleValue:Ns(t)?"-0":t}}function Oi(e){return{integerValue:""+e}}function Vi(e,t){return ks(t)?Oi(t):Mi(e,t)}class Fi{constructor(){this._=void 0}}function Pi(e,t){return e instanceof ji?qs(e=t)||e&&"doubleValue"in e?t:{integerValue:0}:null}class Bi extends Fi{}class Ui extends Fi{constructor(e){super(),this.elements=e}}function qi(e,t){const n=zi(t);for(const t of e.elements)n.some(e=>Os(e,t))||n.push(t);return{arrayValue:{values:n}}}class Ki extends Fi{constructor(e){super(),this.elements=e}}function Gi(e,t){let n=zi(t);for(const t of e.elements)n=n.filter(e=>!Os(e,t));return{arrayValue:{values:n}}}class ji extends Fi{constructor(e,t){super(),this.It=e,this.yt=t}}function Qi(e){return R(e.integerValue||e.doubleValue)}function zi(e){return Ks(e)&&e.arrayValue.values?e.arrayValue.values.slice():[]}class Hi{constructor(e,t){this.field=e,this.transform=t}}class Wi{constructor(e,t){this.version=e,this.transformResults=t}}class M{constructor(e,t){this.updateTime=e,this.exists=t}static none(){return new M}static exists(e){return new M(void 0,e)}static updateTime(e){return new M(e)}get isNone(){return void 0===this.updateTime&&void 0===this.exists}isEqual(e){return this.exists===e.exists&&(this.updateTime?!!e.updateTime&&this.updateTime.isEqual(e.updateTime):!e.updateTime)}}function $i(e,t){return void 0!==e.updateTime?t.isFoundDocument()&&t.version.isEqual(e.updateTime):void 0===e.exists||e.exists===t.isFoundDocument()}class Yi{}function Xi(e,n){if(!e.hasLocalMutations||n&&0===n.fields.length)return null;if(null===n)return e.isNoDocument()?new ia(e.key,M.none()):new ea(e.key,e.data,M.none());{const s=e.data,i=Ys.empty();let t=new N(x.comparator);for(var r of n.fields)if(!t.has(r)){let e=s.field(r);null===e&&1<r.length&&(r=r.popLast(),e=s.field(r)),null===e?i.delete(r):i.set(r,e),t=t.add(r)}return new ta(e.key,i,new bs(t.toArray()),M.none())}}function Ji(e,t,n,r){if(e instanceof ea){var s=e,i=t,a=n,o=r;if(!$i(s.precondition,i))return a;const u=s.value.clone(),c=sa(s.fieldTransforms,o,i);return u.setAll(c),i.convertToFoundDocument(i.version,u).setHasLocalMutations(),null}if(e instanceof ta){a=e,s=t,o=n,i=r;if(!$i(a.precondition,s))return o;const h=sa(a.fieldTransforms,i,s),l=s.data;return l.setAll(na(a)),l.setAll(h),s.convertToFoundDocument(s.version,l).setHasLocalMutations(),null===o?null:o.unionWith(a.fieldMask.fields).unionWith(a.fieldTransforms.map(e=>e.field))}return $i(e.precondition,t)?(t.convertToNoDocument(t.version).setHasLocalMutations(),null):n}function Zi(e,t){return e.type===t.type&&!!e.key.isEqual(t.key)&&!!e.precondition.isEqual(t.precondition)&&(n=e.fieldTransforms,r=t.fieldTransforms,!!(void 0===n&&void 0===r||n&&r&&Ur(n,r,(e,t)=>{return e.field.isEqual(t.field)&&(e=e.transform,t=t.transform,e instanceof Ui&&t instanceof Ui||e instanceof Ki&&t instanceof Ki?Ur(e.elements,t.elements,Os):e instanceof ji&&t instanceof ji?Os(e.yt,t.yt):e instanceof Bi&&t instanceof Bi)}))&&(0===e.type?e.value.isEqual(t.value):1!==e.type||e.data.isEqual(t.data)&&e.fieldMask.isEqual(t.fieldMask)));var n,r}class ea extends Yi{constructor(e,t,n,r=[]){super(),this.key=e,this.value=t,this.precondition=n,this.fieldTransforms=r,this.type=0}getFieldMask(){return null}}class ta extends Yi{constructor(e,t,n,r,s=[]){super(),this.key=e,this.data=t,this.fieldMask=n,this.precondition=r,this.fieldTransforms=s,this.type=1}getFieldMask(){return this.fieldMask}}function na(n){const r=new Map;return n.fieldMask.fields.forEach(e=>{var t;e.isEmpty()||(t=n.data.field(e),r.set(e,t))}),r}function ra(t,n,r){const s=new Map;y(t.length===r.length);for(let e=0;e<r.length;e++){var i=t[e],a=i.transform,o=n.data.field(i.field);s.set(i.field,(i=a,a=o,o=r[e],i instanceof Ui?qi(i,a):i instanceof Ki?Gi(i,a):o))}return s}function sa(e,t,n){const r=new Map;for(const c of e){const e=c.transform,h=n.data.field(c.field);r.set(c.field,(s=e,i=h,a=t,0,s instanceof Bi?function(){const e={fields:{__type__:{stringValue:"server_timestamp"},__local_write_time__:{timestampValue:{seconds:a.seconds,nanos:a.nanoseconds}}}};return i&&(e.fields.__previous_value__=i),{mapValue:e}}():s instanceof Ui?qi(s,i):s instanceof Ki?Gi(s,i):(u=Qi(o=Pi(s,i))+Qi(s.yt),qs(o)&&qs(s.yt)?Oi(u):Mi(s.It,u))))}var s,i,a,o,u;return r}class ia extends Yi{constructor(e,t){super(),this.key=e,this.precondition=t,this.type=2,this.fieldTransforms=[]}getFieldMask(){return null}}class aa extends Yi{constructor(e,t){super(),this.key=e,this.precondition=t,this.type=3,this.fieldTransforms=[]}getFieldMask(){return null}}class oa{constructor(e){this.count=e}}function ua(e){switch(e){default:return E(),0;case I.CANCELLED:case I.UNKNOWN:case I.DEADLINE_EXCEEDED:case I.RESOURCE_EXHAUSTED:case I.INTERNAL:case I.UNAVAILABLE:case I.UNAUTHENTICATED:return;case I.INVALID_ARGUMENT:case I.NOT_FOUND:case I.ALREADY_EXISTS:case I.PERMISSION_DENIED:case I.FAILED_PRECONDITION:case I.ABORTED:case I.OUT_OF_RANGE:case I.UNIMPLEMENTED:case I.DATA_LOSS:return 1}}function ca(e){if(void 0===e)return g("GRPC error has no .code"),I.UNKNOWN;switch(e){case d.OK:return I.OK;case d.CANCELLED:return I.CANCELLED;case d.UNKNOWN:return I.UNKNOWN;case d.DEADLINE_EXCEEDED:return I.DEADLINE_EXCEEDED;case d.RESOURCE_EXHAUSTED:return I.RESOURCE_EXHAUSTED;case d.INTERNAL:return I.INTERNAL;case d.UNAVAILABLE:return I.UNAVAILABLE;case d.UNAUTHENTICATED:return I.UNAUTHENTICATED;case d.INVALID_ARGUMENT:return I.INVALID_ARGUMENT;case d.NOT_FOUND:return I.NOT_FOUND;case d.ALREADY_EXISTS:return I.ALREADY_EXISTS;case d.PERMISSION_DENIED:return I.PERMISSION_DENIED;case d.FAILED_PRECONDITION:return I.FAILED_PRECONDITION;case d.ABORTED:return I.ABORTED;case d.OUT_OF_RANGE:return I.OUT_OF_RANGE;case d.UNIMPLEMENTED:return I.UNIMPLEMENTED;case d.DATA_LOSS:return I.DATA_LOSS;default:return E()}}ye=d={OK:0,0:"OK",CANCELLED:1,1:"CANCELLED",UNKNOWN:2,2:"UNKNOWN",INVALID_ARGUMENT:3,3:"INVALID_ARGUMENT",DEADLINE_EXCEEDED:4,4:"DEADLINE_EXCEEDED",NOT_FOUND:5,5:"NOT_FOUND",ALREADY_EXISTS:6,6:"ALREADY_EXISTS",PERMISSION_DENIED:7,7:"PERMISSION_DENIED",UNAUTHENTICATED:16,16:"UNAUTHENTICATED",RESOURCE_EXHAUSTED:8,8:"RESOURCE_EXHAUSTED",FAILED_PRECONDITION:9,9:"FAILED_PRECONDITION",ABORTED:10,10:"ABORTED",OUT_OF_RANGE:11,11:"OUT_OF_RANGE",UNIMPLEMENTED:12,12:"UNIMPLEMENTED",INTERNAL:13,13:"INTERNAL",UNAVAILABLE:14,14:"UNAVAILABLE",DATA_LOSS:15,15:"DATA_LOSS"};class ha{constructor(e,t){this.mapKeyFn=e,this.equalsFn=t,this.inner={},this.innerSize=0}get(e){const t=this.mapKeyFn(e),n=this.inner[t];if(void 0!==n)for(const[t,r]of n)if(this.equalsFn(t,e))return r}has(e){return void 0!==this.get(e)}set(t,n){const e=this.mapKeyFn(t),r=this.inner[e];if(void 0===r)return this.inner[e]=[[t,n]],void this.innerSize++;for(let e=0;e<r.length;e++)if(this.equalsFn(r[e][0],t))return void(r[e]=[t,n]);r.push([t,n]),this.innerSize++}delete(t){const n=this.mapKeyFn(t),r=this.inner[n];if(void 0===r)return!1;for(let e=0;e<r.length;e++)if(this.equalsFn(r[e][0],t))return 1===r.length?delete this.inner[n]:r.splice(e,1),this.innerSize--,!0;return!1}forEach(r){ms(this.inner,(e,t)=>{for(const[e,n]of t)r(e,n)})}isEmpty(){return ps(this.inner)}size(){return this.innerSize}}const la=new C(D.comparator),da=new C(D.comparator);function fa(...e){let t=da;for(const n of e)t=t.insert(n.key,n);return t}function ga(e){let n=da;return e.forEach((e,t)=>n=n.insert(e,t.overlayedDocument)),n}function ma(){return new ha(e=>e.toString(),(e,t)=>e.isEqual(t))}const pa=new C(D.comparator),ya=new N(D.comparator);function O(...e){let t=ya;for(const n of e)t=t.add(n);return t}const va=new N(T);class wa{constructor(e,t,n,r,s){this.snapshotVersion=e,this.targetChanges=t,this.targetMismatches=n,this.documentUpdates=r,this.resolvedLimboDocuments=s}static createSynthesizedRemoteEventForCurrentChange(e,t,n){const r=new Map;return r.set(e,Ia.createSynthesizedTargetChangeForCurrentChange(e,t,n)),new wa(S.min(),r,va,la,O())}}class Ia{constructor(e,t,n,r,s){this.resumeToken=e,this.current=t,this.addedDocuments=n,this.modifiedDocuments=r,this.removedDocuments=s}static createSynthesizedTargetChangeForCurrentChange(e,t,n){return new Ia(n,t,O(),O(),O())}}class ba{constructor(e,t,n,r){this.Tt=e,this.removedTargetIds=t,this.key=n,this.Et=r}}class Ea{constructor(e,t){this.targetId=e,this.At=t}}class Ta{constructor(e,t,n=k.EMPTY_BYTE_STRING,r=null){this.state=e,this.targetIds=t,this.resumeToken=n,this.cause=r}}class Sa{constructor(){this.Rt=0,this.bt=Da(),this.Pt=k.EMPTY_BYTE_STRING,this.vt=!1,this.Vt=!0}get current(){return this.vt}get resumeToken(){return this.Pt}get St(){return 0!==this.Rt}get Dt(){return this.Vt}Ct(e){0<e.approximateByteSize()&&(this.Vt=!0,this.Pt=e)}xt(){let n=O(),r=O(),s=O();return this.bt.forEach((e,t)=>{switch(t){case 0:n=n.add(e);break;case 2:r=r.add(e);break;case 1:s=s.add(e);break;default:E()}}),new Ia(this.Pt,this.vt,n,r,s)}Nt(){this.Vt=!1,this.bt=Da()}kt(e,t){this.Vt=!0,this.bt=this.bt.insert(e,t)}Ot(e){this.Vt=!0,this.bt=this.bt.remove(e)}Mt(){this.Rt+=1}Ft(){--this.Rt}$t(){this.Vt=!0,this.vt=!0}}class _a{constructor(e){this.Bt=e,this.Lt=new Map,this.Ut=la,this.qt=xa(),this.Kt=new N(T)}Gt(e){for(const t of e.Tt)e.Et&&e.Et.isFoundDocument()?this.Qt(t,e.Et):this.jt(t,e.key,e.Et);for(const n of e.removedTargetIds)this.jt(n,e.key,e.Et)}Wt(n){this.forEachTarget(n,e=>{const t=this.zt(e);switch(n.state){case 0:this.Ht(e)&&t.Ct(n.resumeToken);break;case 1:t.Ft(),t.St||t.Nt(),t.Ct(n.resumeToken);break;case 2:t.Ft(),t.St||this.removeTarget(e);break;case 3:this.Ht(e)&&(t.$t(),t.Ct(n.resumeToken));break;case 4:this.Ht(e)&&(this.Jt(e),t.Ct(n.resumeToken));break;default:E()}})}forEachTarget(e,n){0<e.targetIds.length?e.targetIds.forEach(n):this.Lt.forEach((e,t)=>{this.Ht(t)&&n(t)})}Yt(e){const t=e.targetId,n=e.At.count,r=this.Xt(t);if(r){const e=r.target;if(ti(e))if(0===n){const n=new D(e.path);this.jt(t,n,L.newNoDocument(n,S.min()))}else y(1===n);else this.Zt(t)!==n&&(this.Jt(t),this.Kt=this.Kt.add(t))}}te(r){const s=new Map;this.Lt.forEach((e,t)=>{var n=this.Xt(t);if(n){if(e.current&&ti(n.target)){const s=new D(n.target.path);null!==this.Ut.get(s)||this.ee(t,s)||this.jt(t,s,L.newNoDocument(s,r))}e.Dt&&(s.set(t,e.xt()),e.Nt())}});let i=O();this.qt.forEach((e,t)=>{let n=!0;t.forEachWhile(e=>{e=this.Xt(e);return!e||2===e.purpose||(n=!1)}),n&&(i=i.add(e))}),this.Ut.forEach((e,t)=>t.setReadTime(r));var e=new wa(r,s,this.Kt,this.Ut,i);return this.Ut=la,this.qt=xa(),this.Kt=new N(T),e}Qt(e,t){var n;this.Ht(e)&&(n=this.ee(e,t.key)?2:0,this.zt(e).kt(t.key,n),this.Ut=this.Ut.insert(t.key,t),this.qt=this.qt.insert(t.key,this.ne(t.key).add(e)))}jt(e,t,n){if(this.Ht(e)){const r=this.zt(e);this.ee(e,t)?r.kt(t,1):r.Ot(t),this.qt=this.qt.insert(t,this.ne(t).delete(e)),n&&(this.Ut=this.Ut.insert(t,n))}}removeTarget(e){this.Lt.delete(e)}Zt(e){var t=this.zt(e).xt();return this.Bt.getRemoteKeysForTarget(e).size+t.addedDocuments.size-t.removedDocuments.size}Mt(e){this.zt(e).Mt()}zt(e){let t=this.Lt.get(e);return t||(t=new Sa,this.Lt.set(e,t)),t}ne(e){let t=this.qt.get(e);return t||(t=new N(T),this.qt=this.qt.insert(e,t)),t}Ht(e){var t=null!==this.Xt(e);return t||f("WatchChangeAggregator","Detected inactive target",e),t}Xt(e){var t=this.Lt.get(e);return t&&t.St?null:this.Bt.se(e)}Jt(t){this.Lt.set(t,new Sa),this.Bt.getRemoteKeysForTarget(t).forEach(e=>{this.jt(t,e,null)})}ee(e,t){return this.Bt.getRemoteKeysForTarget(e).has(t)}}function xa(){return new C(D.comparator)}function Da(){return new C(D.comparator)}const Aa={asc:"ASCENDING",desc:"DESCENDING"},Ca={"<":"LESS_THAN","<=":"LESS_THAN_OR_EQUAL",">":"GREATER_THAN",">=":"GREATER_THAN_OR_EQUAL","==":"EQUAL","!=":"NOT_EQUAL","array-contains":"ARRAY_CONTAINS",in:"IN","not-in":"NOT_IN","array-contains-any":"ARRAY_CONTAINS_ANY"};class Na{constructor(e,t){this.databaseId=e,this.gt=t}}function ka(e,t){return e.gt?`${new Date(1e3*t.seconds).toISOString().replace(/\.\d*/,"").replace("Z","")}.${("000000000"+t.nanoseconds).slice(-9)}Z`:{seconds:""+t.seconds,nanos:t.nanoseconds}}function Ra(e,t){return e.gt?t.toBase64():t.toUint8Array()}function V(e){return y(!!e),S.fromTimestamp((e=Ts(e),new h(e.seconds,e.nanos)))}function La(e,t){return new _(["projects",e.projectId,"databases",e.database]).child("documents").child(t).canonicalString()}function Ma(e){e=_.fromString(e);return y(Ya(e)),e}function Oa(e,t){return La(e.databaseId,t.path)}function Va(e,t){const n=Ma(t);if(n.get(1)!==e.databaseId.projectId)throw new b(I.INVALID_ARGUMENT,"Tried to deserialize key from different project: "+n.get(1)+" vs "+e.databaseId.projectId);if(n.get(3)!==e.databaseId.database)throw new b(I.INVALID_ARGUMENT,"Tried to deserialize key from different database: "+n.get(3)+" vs "+e.databaseId.database);return new D(Ua(n))}function Fa(e,t){return La(e.databaseId,t)}function Pa(e){e=Ma(e);return 4===e.length?_.emptyPath():Ua(e)}function Ba(e){return new _(["projects",e.databaseId.projectId,"databases",e.databaseId.database]).canonicalString()}function Ua(e){return y(4<e.length&&"documents"===e.get(4)),e.popFirst(5)}function qa(e,t,n){return{name:Oa(e,t),fields:n.value.mapValue.fields}}function Ka(e,t,n){const r=Va(e,t.name),s=V(t.updateTime),i=new Ys({mapValue:{fields:t.fields}}),a=L.newFoundDocument(r,s,i);return n&&a.setHasCommittedMutations(),n?a.setHasCommittedMutations():a}function Ga(e,t){let n;if(t instanceof ea)n={update:qa(e,t.key,t.value)};else if(t instanceof ia)n={delete:Oa(e,t.key)};else if(t instanceof ta)n={update:qa(e,t.key,t.data),updateMask:function(e){const t=[];return e.fields.forEach(e=>t.push(e.canonicalString())),{fieldPaths:t}}(t.fieldMask)};else{if(!(t instanceof aa))return E();n={verify:Oa(e,t.key)}}return 0<t.fieldTransforms.length&&(n.updateTransforms=t.fieldTransforms.map(e=>{var t=e.transform;if(t instanceof Bi)return{fieldPath:e.field.canonicalString(),setToServerValue:"REQUEST_TIME"};if(t instanceof Ui)return{fieldPath:e.field.canonicalString(),appendMissingElements:{values:t.elements}};if(t instanceof Ki)return{fieldPath:e.field.canonicalString(),removeAllFromArray:{values:t.elements}};if(t instanceof ji)return{fieldPath:e.field.canonicalString(),increment:t.yt};throw E()})),t.precondition.isNone||(n.currentDocument=void 0!==(r=t.precondition).updateTime?{updateTime:ka(e,(t=r.updateTime).toTimestamp())}:void 0!==r.exists?{exists:r.exists}:E()),n;var r}function ja(r,t){const e=t.currentDocument?void 0!==(s=t.currentDocument).updateTime?M.updateTime(V(s.updateTime)):void 0!==s.exists?M.exists(s.exists):M.none():M.none(),n=t.updateTransforms?t.updateTransforms.map(t=>{{var n=r;let e=null;if("setToServerValue"in t)y("REQUEST_TIME"===t.setToServerValue),e=new Bi;else if("appendMissingElements"in t){const n=t.appendMissingElements.values||[];e=new Ui(n)}else if("removeAllFromArray"in t){const n=t.removeAllFromArray.values||[];e=new Ki(n)}else"increment"in t?e=new ji(n,t.increment):E();return n=x.fromServerFormat(t.fieldPath),new Hi(n,e)}}):[];if(t.update){t.update.name;var s=Va(r,t.update.name),i=new Ys({mapValue:{fields:t.update.fields}});if(t.updateMask){const r=function(){const e=t.updateMask.fieldPaths||[];return new bs(e.map(e=>x.fromServerFormat(e)))}();return new ta(s,i,r,e,n)}return new ea(s,i,e,n)}if(t.delete){const n=Va(r,t.delete);return new ia(n,e)}if(t.verify){const n=Va(r,t.verify);return new aa(n,e)}return E()}function Qa(e,t){return{documents:[Fa(e,t.path)]}}function za(e,t){const n={structuredQuery:{}},r=t.path;null!==t.collectionGroup?(n.parent=Fa(e,r),n.structuredQuery.from=[{collectionId:t.collectionGroup,allDescendants:!0}]):(n.parent=Fa(e,r.popLast()),n.structuredQuery.from=[{collectionId:r.lastSegment()}]);var s,i=function(e){if(0!==e.length)return 1===(e=e.map(e=>{var t;if("=="===e.op){if(js(e.value))return{unaryFilter:{field:Wa(e.field),op:"IS_NAN"}};if(Gs(e.value))return{unaryFilter:{field:Wa(e.field),op:"IS_NULL"}}}else if("!="===e.op){if(js(e.value))return{unaryFilter:{field:Wa(e.field),op:"IS_NOT_NAN"}};if(Gs(e.value))return{unaryFilter:{field:Wa(e.field),op:"IS_NOT_NULL"}}}return{fieldFilter:{field:Wa(e.field),op:(t=e.op,Ca[t]),value:e.value}}})).length?e[0]:{compositeFilter:{op:"AND",filters:e}}}(t.filters);return i&&(n.structuredQuery.where=i),(i=function(e){if(0!==e.length)return e.map(e=>{return{field:Wa(e.field),direction:(e=e.dir,Aa[e])}})}(t.orderBy))&&(n.structuredQuery.orderBy=i),s=t.limit,null!==(i=e.gt||Cs(s)?s:{value:s})&&(n.structuredQuery.limit=i),t.startAt&&(n.structuredQuery.startAt={before:(i=t.startAt).inclusive,values:i.position}),t.endAt&&(n.structuredQuery.endAt={before:!(t=t.endAt).inclusive,values:t.position}),n}function Ha(e){let t=Pa(e.parent);const n=e.structuredQuery,r=n.from?n.from.length:0;let s=null;var i,a,o,u;0<r&&(y(1===r),(i=n.from[0]).allDescendants?s=i.collectionId:t=t.child(i.collectionId));let c=[],h=(n.where&&(c=function t(e){return e?void 0!==e.unaryFilter?[function(e){switch(e.unaryFilter.op){case"IS_NAN":var t=$a(e.unaryFilter.field);return ii.create(t,"==",{doubleValue:NaN});case"IS_NULL":return t=$a(e.unaryFilter.field),ii.create(t,"==",{nullValue:"NULL_VALUE"});case"IS_NOT_NAN":var n=$a(e.unaryFilter.field);return ii.create(n,"!=",{doubleValue:NaN});case"IS_NOT_NULL":return n=$a(e.unaryFilter.field),ii.create(n,"!=",{nullValue:"NULL_VALUE"});default:return E()}}(e)]:void 0!==e.fieldFilter?[(n=e,ii.create($a(n.fieldFilter.field),function(){switch(n.fieldFilter.op){case"EQUAL":return"==";case"NOT_EQUAL":return"!=";case"GREATER_THAN":return">";case"GREATER_THAN_OR_EQUAL":return">=";case"LESS_THAN":return"<";case"LESS_THAN_OR_EQUAL":return"<=";case"ARRAY_CONTAINS":return"array-contains";case"IN":return"in";case"NOT_IN":return"not-in";case"ARRAY_CONTAINS_ANY":return"array-contains-any";default:return E()}}(),n.fieldFilter.value))]:void 0!==e.compositeFilter?e.compositeFilter.filters.map(e=>t(e)).reduce((e,t)=>e.concat(t)):E():[];var n}(n.where)),[]),l=(n.orderBy&&(h=n.orderBy.map(e=>{var t=e;return new mi($a(t.field),function(){switch(t.direction){case"ASCENDING":return"asc";case"DESCENDING":return"desc";default:return}}())})),null),d=(n.limit&&(l=Cs(i="object"==typeof(e=n.limit)?e.value:e)?null:i),null),f=(n.startAt&&(d=(u=!!(a=n.startAt).before,o=a.values||[],new gi(o,u))),null);return n.endAt&&(f=(o=!(a=n.endAt).before,u=a.values||[],new gi(u,o))),wi(t,s,h,c,l,"F",d,f)}function Wa(e){return{fieldPath:e.canonicalString()}}function $a(e){return x.fromServerFormat(e.fieldPath)}function Ya(e){return 4<=e.length&&"projects"===e.get(0)&&"databases"===e.get(2)}function Xa(t){let s="";for(let e=0;e<t.length;e++)0<s.length&&(s=Ja(s)),s=function(t){let n=s;const r=t.length;for(let e=0;e<r;e++){const r=t.charAt(e);switch(r){case"\0":n+="";break;case"":n+="";break;default:n+=r}}return n}(t.get(e));return Ja(s)}function Ja(e){return e+""}function Za(n){const r=n.length;if(y(2<=r),2===r)return y(""===n.charAt(0)&&""===n.charAt(1)),_.emptyPath();r;const s=[];let i="";for(let t=0;t<r;){const r=n.indexOf("",t);switch((r<0||r>a)&&E(),n.charAt(r+1)){case"":const a=n.substring(t,r);let e;0===i.length?e=a:(i+=a,e=i,i=""),s.push(e);break;case"":i=i+n.substring(t,r)+"\0";break;case"":i+=n.substring(t,r+1);break;default:E()}t=r+2}return new _(s)}const eo=["userId","batchId"];function to(e,t){return[e,Xa(t)]}function no(e,t,n){return[e,Xa(t),n]}const ro={},so=["prefixPath","collectionGroup","readTime","documentId"],io=["prefixPath","collectionGroup","documentId"],ao=["collectionGroup","readTime","prefixPath","documentId"],oo=["canonicalId","targetId"],uo=["targetId","path"],co=["path","targetId"],ho=["collectionId","parent"],lo=["indexId","uid"],fo=["uid","sequenceNumber"],go=["indexId","uid","arrayValue","directionalValue","orderedDocumentKey","documentKey"],mo=["indexId","uid","orderedDocumentKey"],po=["userId","collectionPath","documentId"],yo=["userId","collectionPath","largestBatchId"],vo=["userId","collectionGroup","largestBatchId"],wo=["mutationQueues","mutations","documentMutations","remoteDocuments","targets","owner","targetGlobal","targetDocuments","clientMetadata","remoteDocumentGlobal","collectionParents","bundles","namedQueries"],Io=[...wo,"documentOverlays"],bo=["mutationQueues","mutations","documentMutations","remoteDocumentsV14","targets","owner","targetGlobal","targetDocuments","clientMetadata","remoteDocumentGlobal","collectionParents","bundles","namedQueries","documentOverlays"],Eo=bo,To=[...Eo,"indexConfiguration","indexState","indexEntries"];class So extends es{constructor(e,t){super(),this.ie=e,this.currentSequenceNumber=t}}function n(e,t){return rs.M(e.ie,t)}class _o{constructor(e,t,n,r){this.batchId=e,this.localWriteTime=t,this.baseMutations=n,this.mutations=r}applyToRemoteDocument(t,e){var n=e.mutationResults;for(let e=0;e<this.mutations.length;e++){const c=this.mutations[e];if(c.key.isEqual(t.key)){r=void 0;s=void 0;i=void 0;a=void 0;o=void 0;u=void 0;a=void 0;o=void 0;u=void 0;var r=c;var s=t;var i=n[e];if(r instanceof ea){var a=r,o=s,u=i;const h=a.value.clone(),l=ra(a.fieldTransforms,o,u.transformResults);h.setAll(l),o.convertToFoundDocument(u.version,h).setHasCommittedMutations()}else if(r instanceof ta){a=r,o=s,u=i;if($i(a.precondition,o)){const d=ra(a.fieldTransforms,o,u.transformResults),f=o.data;f.setAll(na(a)),f.setAll(d),o.convertToFoundDocument(u.version,f).setHasCommittedMutations()}else o.convertToUnknownDocument(u.version)}else s.convertToNoDocument(i.version).setHasCommittedMutations()}}}applyToLocalView(e,t){for(const n of this.baseMutations)n.key.isEqual(e.key)&&(t=Ji(n,e,t,this.localWriteTime));for(const r of this.mutations)r.key.isEqual(e.key)&&(t=Ji(r,e,t,this.localWriteTime));return t}applyToLocalDocumentSet(i,a){const o=ma();return this.mutations.forEach(e=>{const t=i.get(e.key),n=t.overlayedDocument;let r=this.applyToLocalView(n,t.mutatedFields);r=a.has(e.key)?null:r;var s=Xi(n,r);null!==s&&o.set(e.key,s),n.isValidDocument()||n.convertToNoDocument(S.min())}),o}keys(){return this.mutations.reduce((e,t)=>e.add(t.key),O())}isEqual(e){return this.batchId===e.batchId&&Ur(this.mutations,e.mutations,(e,t)=>Zi(e,t))&&Ur(this.baseMutations,e.baseMutations,(e,t)=>Zi(e,t))}}class xo{constructor(e,t,n,r){this.batch=e,this.commitVersion=t,this.mutationResults=n,this.docVersions=r}static from(e,t,n){y(e.mutations.length===n.length);let r=pa;var s=e.mutations;for(let e=0;e<s.length;e++)r=r.insert(s[e].key,n[e].version);return new xo(e,t,n,r)}}class Do{constructor(e,t){this.largestBatchId=e,this.mutation=t}getKey(){return this.mutation.key}isEqual(e){return null!==e&&this.mutation===e.mutation}toString(){return`Overlay{
      largestBatchId: ${this.largestBatchId},
      mutation: ${this.mutation.toString()}
    }`}}class Ao{constructor(e,t,n,r,s=S.min(),i=S.min(),a=k.EMPTY_BYTE_STRING){this.target=e,this.targetId=t,this.purpose=n,this.sequenceNumber=r,this.snapshotVersion=s,this.lastLimboFreeSnapshotVersion=i,this.resumeToken=a}withSequenceNumber(e){return new Ao(this.target,this.targetId,this.purpose,e,this.snapshotVersion,this.lastLimboFreeSnapshotVersion,this.resumeToken)}withResumeToken(e,t){return new Ao(this.target,this.targetId,this.purpose,this.sequenceNumber,t,this.lastLimboFreeSnapshotVersion,e)}withLastLimboFreeSnapshotVersion(e){return new Ao(this.target,this.targetId,this.purpose,this.sequenceNumber,this.snapshotVersion,e,this.resumeToken)}}class Co{constructor(e){this.re=e}}function No(e,t){const n=t.key,r={prefixPath:n.getCollectionPath().popLast().toArray(),collectionGroup:n.collectionGroup,documentId:n.path.lastSegment(),readTime:ko(t.readTime),hasCommittedMutations:t.hasCommittedMutations};if(t.isFoundDocument())r.document={name:Oa(s=e.re,(e=t).key),fields:e.data.value.mapValue.fields,updateTime:ka(s,e.version.toTimestamp())};else if(t.isNoDocument())r.noDocument={path:n.path.toArray(),readTime:Ro(t.version)};else{if(!t.isUnknownDocument())return E();r.unknownDocument={path:n.path.toArray(),version:Ro(t.version)}}var s;return r}function ko(e){e=e.toTimestamp();return[e.seconds,e.nanoseconds]}function Ro(e){e=e.toTimestamp();return{seconds:e.seconds,nanoseconds:e.nanoseconds}}function Lo(e){e=new h(e.seconds,e.nanoseconds);return S.fromTimestamp(e)}function Mo(t,n){const r=(n.baseMutations||[]).map(e=>ja(t.re,e));for(let e=0;e<n.mutations.length-1;++e){const r=n.mutations[e];if(e+1<n.mutations.length&&void 0!==n.mutations[e+1].transform){const s=n.mutations[e+1];r.updateTransforms=s.transform.fieldTransforms,n.mutations.splice(e+1,1),++e}}const s=n.mutations.map(e=>ja(t.re,e)),e=h.fromMillis(n.localWriteTimeMs);return new _o(n.batchId,e,r,s)}function Oo(e){var t=Lo(e.readTime),n=void 0!==e.lastLimboFreeSnapshotVersion?Lo(e.lastLimboFreeSnapshotVersion):S.min(),r=void 0!==e.query.documents?(y(1===(r=e.query).documents.length),xi(Ii(Pa(r.documents[0])))):xi(Ha(e.query));return new Ao(r,e.targetId,0,e.lastListenSequenceNumber,t,n,k.fromBase64String(e.resumeToken))}function Vo(e,t){var n=Ro(t.snapshotVersion),r=Ro(t.lastLimboFreeSnapshotVersion),e=(ti(t.target)?Qa:za)(e.re,t.target),s=t.resumeToken.toBase64();return{targetId:t.targetId,canonicalId:Zs(t.target),readTime:n,resumeToken:s,lastListenSequenceNumber:t.sequenceNumber,lastLimboFreeSnapshotVersion:r,query:e}}function Fo(e){var t=Ha({parent:e.parent,structuredQuery:e.structuredQuery});return"LAST"===e.limitType?Di(t,t.limit,"L"):t}function Po(e,t){return new Do(t.largestBatchId,ja(e.re,t.overlayMutation))}function Bo(e,t){var n=t.path.lastSegment();return[e,Xa(t.path.popLast()),n]}function Uo(e,t,n,r){return{indexId:e,uid:t.uid||"",sequenceNumber:n,readTime:Ro(r.readTime),documentKey:Xa(r.documentKey.path),largestBatchId:r.largestBatchId}}class qo{getBundleMetadata(e,t){return Ko(e).get(t).next(e=>{if(e)return{id:(e=e).bundleId,createTime:Lo(e.createTime),version:e.version}})}saveBundleMetadata(e,t){return Ko(e).put({bundleId:(e=t).id,createTime:Ro(V(e.createTime)),version:e.version})}getNamedQuery(e,t){return Go(e).get(t).next(e=>{if(e)return{name:(e=e).name,query:Fo(e.bundledQuery),readTime:Lo(e.readTime)}})}saveNamedQuery(e,t){return Go(e).put({name:t.name,readTime:Ro(V(t.readTime)),bundledQuery:t.bundledQuery})}}function Ko(e){return n(e,"bundles")}function Go(e){return n(e,"namedQueries")}class jo{constructor(e,t){this.It=e,this.userId=t}static oe(e,t){t=t.uid||"";return new jo(e,t)}getOverlay(e,t){return Qo(e).get(Bo(this.userId,t)).next(e=>e?Po(this.It,e):null)}getOverlays(e,t){const n=ma();return A.forEach(t,t=>this.getOverlay(e,t).next(e=>{null!==e&&n.set(t,e)})).next(()=>n)}saveOverlays(n,r,e){const s=[];return e.forEach((e,t)=>{t=new Do(r,t);s.push(this.ue(n,t))}),A.waitFor(s)}removeOverlaysForBatchId(t,e,n){const r=new Set,s=(e.forEach(e=>r.add(Xa(e.getCollectionPath()))),[]);return r.forEach(e=>{e=IDBKeyRange.bound([this.userId,e,n],[this.userId,e,n+1],!1,!0);s.push(Qo(t).Y("collectionPathOverlayIndex",e))}),A.waitFor(s)}getOverlaysForCollection(e,t,n){const r=ma(),s=Xa(t),i=IDBKeyRange.bound([this.userId,s,n],[this.userId,s,Number.POSITIVE_INFINITY],!0);return Qo(e).W("collectionPathOverlayIndex",i).next(e=>{for(const t of e){const e=Po(this.It,t);r.set(e.getKey(),e)}return r})}getOverlaysForCollectionGroup(e,t,n,s){const i=ma();let a;n=IDBKeyRange.bound([this.userId,t,n],[this.userId,t,Number.POSITIVE_INFINITY],!0);return Qo(e).Z({index:"collectionGroupOverlayIndex",range:n},(e,t,n)=>{const r=Po(this.It,t);i.size()<s||r.largestBatchId===a?(i.set(r.getKey(),r),a=r.largestBatchId):n.done()}).next(()=>i)}ue(e,t){return Qo(e).put(function(e,t,n){var[,r,s]=Bo(t,n.mutation.key);return{userId:t,collectionPath:r,documentId:s,collectionGroup:n.mutation.key.getCollectionGroup(),largestBatchId:n.largestBatchId,overlayMutation:Ga(e.re,n.mutation)}}(this.It,this.userId,t))}}function Qo(e){return n(e,"documentOverlays")}class zo{constructor(){}ce(e,t){this.ae(e,t),t.he()}ae(e,t){var n,r;"nullValue"in e?this.le(t,5):"booleanValue"in e?(this.le(t,10),t.fe(e.booleanValue?1:0)):"integerValue"in e?(this.le(t,15),t.fe(R(e.integerValue))):"doubleValue"in e?(n=R(e.doubleValue),isNaN(n)?this.le(t,13):(this.le(t,15),Ns(n)?t.fe(0):t.fe(n))):"timestampValue"in e?(r=e.timestampValue,this.le(t,20),"string"==typeof r?t.de(r):(t.de(""+(r.seconds||"")),t.fe(r.nanos||0))):"stringValue"in e?(this._e(e.stringValue,t),this.we(t)):"bytesValue"in e?(this.le(t,30),t.me(Ss(e.bytesValue)),this.we(t)):"referenceValue"in e?this.ge(e.referenceValue,t):"geoPointValue"in e?(r=e.geoPointValue,this.le(t,45),t.fe(r.latitude||0),t.fe(r.longitude||0)):"mapValue"in e?Hs(e)?this.le(t,Number.MAX_SAFE_INTEGER):(this.ye(e.mapValue,t),this.we(t)):"arrayValue"in e?(this.pe(e.arrayValue,t),this.we(t)):E()}_e(e,t){this.le(t,25),this.Ie(e,t)}Ie(e,t){t.de(e)}ye(e,t){var n=e.fields||{};this.le(t,55);for(const e of Object.keys(n))this._e(e,t),this.ae(n[e],t)}pe(e,t){var n=e.values||[];this.le(t,50);for(const e of n)this.ae(e,t)}ge(e,t){this.le(t,37),D.fromName(e).path.forEach(e=>{this.le(t,60),this.Ie(e,t)})}le(e,t){e.fe(t)}we(e){e.fe(2)}}function Ho(e){e=64-function(t){let n=0;for(let e=0;e<8;++e){var r=function(e){if(0===e)return 8;let t=0;return e>>4==0&&(t+=4,e<<=4),e>>6==0&&(t+=2,e<<=2),e>>7==0&&(t+=1),t}(255&t[e]);if(n+=r,8!==r)break}return n}(e);return Math.ceil(e/8)}zo.Te=new zo;class Wo{constructor(){this.buffer=new Uint8Array(1024),this.position=0}Ee(e){const t=e[Symbol.iterator]();let n=t.next();for(;!n.done;)this.Ae(n.value),n=t.next();this.Re()}be(e){const t=e[Symbol.iterator]();let n=t.next();for(;!n.done;)this.Pe(n.value),n=t.next();this.ve()}Ve(e){for(const t of e){const e=t.charCodeAt(0);if(e<128)this.Ae(e);else if(e<2048)this.Ae(960|e>>>6),this.Ae(128|63&e);else if(t<"\ud800"||"\udbff"<t)this.Ae(480|e>>>12),this.Ae(128|63&e>>>6),this.Ae(128|63&e);else{const e=t.codePointAt(0);this.Ae(240|e>>>18),this.Ae(128|63&e>>>12),this.Ae(128|63&e>>>6),this.Ae(128|63&e)}}this.Re()}Se(e){for(const t of e){const e=t.charCodeAt(0);if(e<128)this.Pe(e);else if(e<2048)this.Pe(960|e>>>6),this.Pe(128|63&e);else if(t<"\ud800"||"\udbff"<t)this.Pe(480|e>>>12),this.Pe(128|63&e>>>6),this.Pe(128|63&e);else{const e=t.codePointAt(0);this.Pe(240|e>>>18),this.Pe(128|63&e>>>12),this.Pe(128|63&e>>>6),this.Pe(128|63&e)}}this.ve()}De(t){var n=this.Ce(t),t=Ho(n);this.xe(1+t),this.buffer[this.position++]=255&t;for(let e=n.length-t;e<n.length;++e)this.buffer[this.position++]=255&n[e]}Ne(t){var n=this.Ce(t),t=Ho(n);this.xe(1+t),this.buffer[this.position++]=~(255&t);for(let e=n.length-t;e<n.length;++e)this.buffer[this.position++]=~(255&n[e])}ke(){this.Oe(255),this.Oe(255)}Me(){this.Fe(255),this.Fe(255)}reset(){this.position=0}seed(e){this.xe(e.length),this.buffer.set(e,this.position),this.position+=e.length}$e(){return this.buffer.slice(0,this.position)}Ce(e){const t=function(e){const t=new DataView(new ArrayBuffer(8));return t.setFloat64(0,e,!1),new Uint8Array(t.buffer)}(e),n=0!=(128&t[0]);t[0]^=n?255:128;for(let e=1;e<t.length;++e)t[e]^=n?255:0;return t}Ae(e){e&=255;0==e?(this.Oe(0),this.Oe(255)):255==e?(this.Oe(255),this.Oe(0)):this.Oe(e)}Pe(e){var t=255&e;0==t?(this.Fe(0),this.Fe(255)):255==t?(this.Fe(255),this.Fe(0)):this.Fe(e)}Re(){this.Oe(0),this.Oe(1)}ve(){this.Fe(0),this.Fe(1)}Oe(e){this.xe(1),this.buffer[this.position++]=e}Fe(e){this.xe(1),this.buffer[this.position++]=~e}xe(t){t+=this.position;if(!(t<=this.buffer.length)){let e=2*this.buffer.length;e<t&&(e=t);const n=new Uint8Array(e);n.set(this.buffer),this.buffer=n}}}class $o{constructor(e){this.Be=e}me(e){this.Be.Ee(e)}de(e){this.Be.Ve(e)}fe(e){this.Be.De(e)}he(){this.Be.ke()}}class Yo{constructor(e){this.Be=e}me(e){this.Be.be(e)}de(e){this.Be.Se(e)}fe(e){this.Be.Ne(e)}he(){this.Be.Me()}}class Xo{constructor(){this.Be=new Wo,this.Le=new $o(this.Be),this.Ue=new Yo(this.Be)}seed(e){this.Be.seed(e)}qe(e){return 0===e?this.Le:this.Ue}$e(){return this.Be.$e()}reset(){this.Be.reset()}}class Jo{constructor(e,t,n,r){this.indexId=e,this.documentKey=t,this.arrayValue=n,this.directionalValue=r}Ke(){const e=this.directionalValue.length,t=0===e||255===this.directionalValue[e-1]?e+1:e,n=new Uint8Array(t);return n.set(this.directionalValue,0),t!==e?n.set([0],this.directionalValue.length):++n[n.length-1],new Jo(this.indexId,this.documentKey,this.arrayValue,n)}}function Zo(e,t){let n=e.indexId-t.indexId;return 0!==n?n:0!==(n=eu(e.arrayValue,t.arrayValue))?n:0!==(n=eu(e.directionalValue,t.directionalValue))?n:D.comparator(e.documentKey,t.documentKey)}function eu(t,n){for(let e=0;e<t.length&&e<n.length;++e){var r=t[e]-n[e];if(0!=r)return r}return t.length-n.length}class tu{constructor(e){this.collectionId=null!=e.collectionGroup?e.collectionGroup:e.path.lastSegment(),this.Ge=e.orderBy,this.Qe=[];for(const t of e.filters){const e=t;e.dt()?this.je=e:this.Qe.push(e)}}We(e){var t=Qr(e);if(void 0!==t&&!this.ze(t))return!1;var n=zr(e);let r=0,s=0;for(;r<n.length&&this.ze(n[r]);++r);if(r===n.length)return!0;if(void 0!==this.je){const e=n[r];if(!this.He(this.je,e)||!this.Je(this.Ge[s++],e))return!1;++r}for(;r<n.length;++r){const e=n[r];if(s>=this.Ge.length||!this.Je(this.Ge[s++],e))return!1}return!0}ze(e){for(const t of this.Qe)if(this.He(t,e))return!0;return!1}He(e,t){if(void 0===e||!e.field.isEqual(t.fieldPath))return!1;e="array-contains"===e.op||"array-contains-any"===e.op;return 2===t.kind==e}Je(e,t){return!!e.field.isEqual(t.fieldPath)&&(0===t.kind&&"asc"===e.dir||1===t.kind&&"desc"===e.dir)}}class nu{constructor(){this.Ye=new ru}addToCollectionParentIndex(e,t){return this.Ye.add(t),A.resolve()}getCollectionParents(e,t){return A.resolve(this.Ye.getEntries(t))}addFieldIndex(e,t){return A.resolve()}deleteFieldIndex(e,t){return A.resolve()}getDocumentsMatchingTarget(e,t){return A.resolve(null)}getIndexType(e,t){return A.resolve(0)}getFieldIndexes(e,t){return A.resolve([])}getNextCollectionGroupToUpdate(e){return A.resolve(null)}getMinOffset(e,t){return A.resolve(Xr.min())}getMinOffsetFromCollectionGroup(e,t){return A.resolve(Xr.min())}updateCollectionGroup(e,t,n){return A.resolve()}updateIndexEntries(e,t){return A.resolve()}}class ru{constructor(){this.index={}}add(e){const t=e.lastSegment(),n=e.popLast(),r=this.index[t]||new N(_.comparator),s=!r.has(n);return this.index[t]=r.add(n),s}has(e){const t=e.lastSegment(),n=e.popLast(),r=this.index[t];return r&&r.has(n)}getEntries(e){return(this.index[e]||new N(_.comparator)).toArray()}}const su=new Uint8Array(0);class iu{constructor(e,t){this.user=e,this.databaseId=t,this.Xe=new ru,this.Ze=new ha(e=>Zs(e),(e,t)=>ei(e,t)),this.uid=e.uid||""}addToCollectionParentIndex(e,t){if(this.Xe.has(t))return A.resolve();var n=t.lastSegment(),r=t.popLast();return e.addOnCommittedListener(()=>{this.Xe.add(t)}),r={collectionId:n,parent:Xa(r)},au(e).put(r)}getCollectionParents(e,n){const r=[],t=IDBKeyRange.bound([n,""],[qr(n),""],!1,!0);return au(e).W(t).next(e=>{for(const t of e){if(t.collectionId!==n)break;r.push(Za(t.parent))}return r})}addFieldIndex(e,t){const n=uu(e),r={indexId:t.indexId,collectionGroup:t.collectionGroup,fields:t.fields.map(e=>[e.fieldPath.canonicalString(),e.kind])},s=(delete r.indexId,n.add(r));if(t.indexState){const n=cu(e);return s.next(e=>{n.put(Uo(e,this.user,t.indexState.sequenceNumber,t.indexState.offset))})}return s.next()}deleteFieldIndex(e,t){const n=uu(e),r=cu(e),s=ou(e);return n.delete(t.indexId).next(()=>r.delete(IDBKeyRange.bound([t.indexId],[t.indexId+1],!1,!0))).next(()=>s.delete(IDBKeyRange.bound([t.indexId],[t.indexId+1],!1,!0)))}getDocumentsMatchingTarget(e,c){const h=ou(e);let l=!0;const n=new Map;return A.forEach(this.tn(c),t=>this.en(e,t).next(e=>{l=l&&!!e,n.set(t,e)})).next(()=>{if(l){let u=O();const l=[];return A.forEach(n,(e,t)=>{f("IndexedDbIndexManager",`Using index ${o=e,`id=${o.indexId}|cg=${o.collectionGroup}|f=`+o.fields.map(e=>e.fieldPath+":"+e.kind).join(",")} to execute `+Zs(c));var n=function(e,t){var n=Qr(t);if(void 0===n)return null;for(const t of ni(e,n.fieldPath))switch(t.op){case"array-contains-any":return t.value.arrayValue.values||[];case"array-contains":return[t.value]}return null}(t,e),r=function(e,t){const n=new Map;for(const r of zr(t))for(const t of ni(e,r.fieldPath))switch(t.op){case"==":case"in":n.set(r.fieldPath.canonicalString(),t.value);break;case"not-in":case"!=":return n.set(r.fieldPath.canonicalString(),t.value),Array.from(n.values())}return null}(t,e),s=function(e,t){const n=[];let r=!0;for(const s of zr(t)){const t=(0===s.kind?ri:si)(e,s.fieldPath,e.startAt);n.push(t.value),r=r&&t.inclusive}return new gi(n,r)}(t,e),i=function(e,t){const n=[];let r=!0;for(const s of zr(t)){const t=(0===s.kind?si:ri)(e,s.fieldPath,e.endAt);n.push(t.value),r=r&&t.inclusive}return new gi(n,r)}(t,e),a=this.nn(e,t,s),o=this.nn(e,t,i),r=this.sn(e,t,r),r=this.rn(e.indexId,n,a,s.inclusive,o,i.inclusive,r);return A.forEach(r,e=>h.J(e,c.limit).next(e=>{e.forEach(e=>{e=D.fromSegments(e.documentKey);u.has(e)||(u=u.add(e),l.push(e))})}))}).next(()=>l)}return A.resolve(null)})}tn(e){return this.Ze.get(e)||(this.Ze.set(e,e=[e]),e)}rn(t,n,r,s,i,a,o){const u=(null!=n?n.length:1)*Math.max(r.length,i.length),c=u/(null!=n?n.length:1),h=[];for(let e=0;e<u;++e){const u=n?this.on(n[e/c]):su,l=this.un(t,u,r[e%c],s),d=this.cn(t,u,i[e%c],a),f=o.map(e=>this.un(t,u,e,!0));h.push(...this.createRange(l,d,f))}return h}un(e,t,n,r){const s=new Jo(e,D.empty(),t,n);return r?s:s.Ke()}cn(e,t,n,r){const s=new Jo(e,D.empty(),t,n);return r?s.Ke():s}en(e,t){const r=new tu(t),n=null!=t.collectionGroup?t.collectionGroup:t.path.lastSegment();return this.getFieldIndexes(e,n).next(e=>{let t=null;for(const n of e)r.We(n)&&(!t||n.fields.length>t.fields.length)&&(t=n);return t})}getIndexType(e,t){let n=2;return A.forEach(this.tn(t),t=>this.en(e,t).next(e=>{e?0!==n&&e.fields.length<function(e){let t=new N(x.comparator),n=!1;for(const r of e.filters){const e=r;e.field.isKeyField()||("array-contains"===e.op||"array-contains-any"===e.op?n=!0:t=t.add(e.field))}for(const n of e.orderBy)n.field.isKeyField()||(t=t.add(n.field));return t.size+(n?1:0)}(t)&&(n=1):n=0})).next(()=>n)}an(e,t){const n=new Xo;for(const s of zr(e)){const e=t.data.field(s.fieldPath);if(null==e)return null;var r=n.qe(s.kind);zo.Te.ce(e,r)}return n.$e()}on(e){const t=new Xo;return zo.Te.ce(e,t.qe(0)),t.$e()}hn(e,t){const n=new Xo;return zo.Te.ce(Us(this.databaseId,t),n.qe(0===(t=zr(e)).length?0:t[t.length-1].kind)),n.$e()}sn(e,t,n){if(null===n)return[];let r=[],s=(r.push(new Xo),0);for(const i of zr(e)){const e=n[s++];for(const n of r)if(this.ln(t,i.fieldPath)&&Ks(e))r=this.fn(r,i,e);else{const t=n.qe(i.kind);zo.Te.ce(e,t)}}return this.dn(r)}nn(e,t,n){return this.sn(e,t,n.position)}dn(t){const n=[];for(let e=0;e<t.length;++e)n[e]=t[e].$e();return n}fn(e,t,n){const r=[...e],s=[];for(const e of n.arrayValue.values||[])for(const n of r){const r=new Xo;r.seed(n.$e()),zo.Te.ce(e,r.qe(t.kind)),s.push(r)}return s}ln(e,t){return!!e.filters.find(e=>e instanceof ii&&e.field.isEqual(t)&&("in"===e.op||"not-in"===e.op))}getFieldIndexes(e,t){const n=uu(e),i=cu(e);return(t?n.W("collectionGroupIndex",IDBKeyRange.bound(t,t)):n.W()).next(e=>{const s=[];return A.forEach(e,r=>i.get([r.indexId,this.uid]).next(e=>{var t,n;s.push((t=r,e=e?new Wr(e.sequenceNumber,new Xr(Lo(e.readTime),new D(Za(e.documentKey)),e.largestBatchId)):Wr.empty(),n=t.fields.map(([e,t])=>new Hr(x.fromServerFormat(e),t)),new jr(t.indexId,t.collectionGroup,n,e)))})).next(()=>s)})}getNextCollectionGroupToUpdate(e){return this.getFieldIndexes(e).next(e=>0===e.length?null:(e.sort((e,t)=>{var n=e.indexState.sequenceNumber-t.indexState.sequenceNumber;return 0!=n?n:T(e.collectionGroup,t.collectionGroup)}),e[0].collectionGroup))}updateCollectionGroup(e,n,r){const s=uu(e),i=cu(e);return this._n(e).next(t=>s.W("collectionGroupIndex",IDBKeyRange.bound(n,n)).next(e=>A.forEach(e,e=>i.put(Uo(e.indexId,this.user,t,r)))))}updateIndexEntries(s,e){const n=new Map;return A.forEach(e,(t,r)=>{var e=n.get(t.collectionGroup);return(e?A.resolve(e):this.getFieldIndexes(s,t.collectionGroup)).next(e=>(n.set(t.collectionGroup,e),A.forEach(e,n=>this.wn(s,t,n).next(e=>{var t=this.mn(r,n);return e.isEqual(t)?A.resolve():this.gn(s,r,n,e,t)}))))})}yn(e,t,n,r){return ou(e).put({indexId:r.indexId,uid:this.uid,arrayValue:r.arrayValue,directionalValue:r.directionalValue,orderedDocumentKey:this.hn(n,t.key),documentKey:t.key.path.toArray()})}pn(e,t,n,r){return ou(e).delete([r.indexId,this.uid,r.arrayValue,r.directionalValue,this.hn(n,t.key),t.key.path.toArray()])}wn(e,n,r){const t=ou(e);let s=new N(Zo);return t.Z({index:"documentKeyIndex",range:IDBKeyRange.only([r.indexId,this.uid,this.hn(r,n)])},(e,t)=>{s=s.add(new Jo(r.indexId,n,t.arrayValue,t.directionalValue))}).next(()=>s)}mn(e,t){let n=new N(Zo);var r=this.an(t,e);if(null==r)return n;const s=Qr(t);if(null!=s){var i=e.data.field(s.fieldPath);if(Ks(i))for(const s of i.arrayValue.values||[])n=n.add(new Jo(t.indexId,e.key,this.on(s),r))}else n=n.add(new Jo(t.indexId,e.key,su,r));return n}gn(t,s,i,e,a){f("IndexedDbIndexManager","Updating index entries for document '%s'",s.key);const o=[];{var u=Zo,c=e=>{o.push(this.yn(t,s,i,e))},h=e=>{o.push(this.pn(t,s,i,e))},l=e.getIterator(),d=a.getIterator();let n=Is(l),r=Is(d);for(;n||r;){let e=!1,t=!1;if(n&&r){const c=u(n,r);c<0?t=!0:0<c&&(e=!0)}else null!=n?t=!0:e=!0;e?(c(r),r=Is(d)):t?(h(n),n=Is(l)):(n=Is(l),r=Is(d))}}return A.waitFor(o)}_n(e){let r=1;return cu(e).Z({index:"sequenceNumberIndex",reverse:!0,range:IDBKeyRange.upperBound([this.uid,Number.MAX_SAFE_INTEGER])},(e,t,n)=>{n.done(),r=t.sequenceNumber+1}).next(()=>r)}createRange(e,t,n){n=n.sort((e,t)=>Zo(e,t)).filter((e,t,n)=>!t||0!==Zo(e,n[t-1]));const r=[];r.push(e);for(const s of n){const n=Zo(s,e),i=Zo(s,t);if(0===n)r[0]=e.Ke();else if(0<n&&i<0)r.push(s),r.push(s.Ke());else if(0<i)break}r.push(t);const s=[];for(let e=0;e<r.length;e+=2)s.push(IDBKeyRange.bound([r[e].indexId,this.uid,r[e].arrayValue,r[e].directionalValue,su,[]],[r[e+1].indexId,this.uid,r[e+1].arrayValue,r[e+1].directionalValue,su,[]]));return s}getMinOffsetFromCollectionGroup(e,t){return this.getFieldIndexes(e,t).next(hu)}getMinOffset(t,e){return A.mapArray(this.tn(e),e=>this.en(t,e).next(e=>e||E())).next(hu)}}function au(e){return n(e,"collectionParents")}function ou(e){return n(e,"indexEntries")}function uu(e){return n(e,"indexConfiguration")}function cu(e){return n(e,"indexState")}function hu(t){y(0!==t.length);let n=t[0].indexState.offset,r=n.largestBatchId;for(let e=1;e<t.length;e++){var s=t[e].indexState.offset;Jr(s,n)<0&&(n=s),r<s.largestBatchId&&(r=s.largestBatchId)}return new Xr(n.readTime,n.documentKey,r)}const lu={didRun:!1,sequenceNumbersCollected:0,targetsRemoved:0,documentsRemoved:0};class du{constructor(e,t,n){this.cacheSizeCollectionThreshold=e,this.percentileToCollect=t,this.maximumSequenceNumbersToCollect=n}static withCacheSize(e){return new du(e,du.DEFAULT_COLLECTION_PERCENTILE,du.DEFAULT_MAX_SEQUENCE_NUMBERS_TO_COLLECT)}}function fu(e,t,n){const r=e.store("mutations"),s=e.store("documentMutations"),i=[],a=IDBKeyRange.only(n.batchId);let o=0;const u=r.Z({range:a},(e,t,n)=>(o++,n.delete())),c=(i.push(u.next(()=>{y(1===o)})),[]);for(const e of n.mutations){const r=no(t,e.key.path,n.batchId);i.push(s.delete(r)),c.push(e.key)}return A.waitFor(i).next(()=>c)}function gu(e){if(!e)return 0;let t;if(e.document)t=e.document;else if(e.unknownDocument)t=e.unknownDocument;else{if(!e.noDocument)throw E();t=e.noDocument}return JSON.stringify(t).length}du.DEFAULT_COLLECTION_PERCENTILE=10,du.DEFAULT_MAX_SEQUENCE_NUMBERS_TO_COLLECT=1e3,du.DEFAULT=new du(41943040,du.DEFAULT_COLLECTION_PERCENTILE,du.DEFAULT_MAX_SEQUENCE_NUMBERS_TO_COLLECT),du.DISABLED=new du(-1,0,0);class mu{constructor(e,t,n,r){this.userId=e,this.It=t,this.indexManager=n,this.referenceDelegate=r,this.In={}}static oe(e,t,n,r){y(""!==e.uid);e=e.isAuthenticated()?e.uid:"";return new mu(e,t,n,r)}checkEmpty(e){let r=!0;var t=IDBKeyRange.bound([this.userId,Number.NEGATIVE_INFINITY],[this.userId,Number.POSITIVE_INFINITY]);return yu(e).Z({index:"userMutationsIndex",range:t},(e,t,n)=>{r=!1,n.done()}).next(()=>r)}addMutationBatch(h,l,d,f){const g=vu(h),m=yu(h);return m.add({}).next(e=>{y("number"==typeof e);const t=new _o(e,l,d,f),n=(s=this.It,i=this.userId,o=(a=t).baseMutations.map(e=>Ga(s.re,e)),u=a.mutations.map(e=>Ga(s.re,e)),{userId:i,batchId:a.batchId,localWriteTimeMs:a.localWriteTime.toMillis(),baseMutations:o,mutations:u}),r=[];var s,i,a,o,u;let c=new N((e,t)=>T(e.canonicalString(),t.canonicalString()));for(const h of f){const l=no(this.userId,h.key.path,e);c=c.add(h.key.path.popLast()),r.push(m.put(n)),r.push(g.put(l,ro))}return c.forEach(e=>{r.push(this.indexManager.addToCollectionParentIndex(h,e))}),h.addOnCommittedListener(()=>{this.In[e]=t.keys()}),A.waitFor(r).next(()=>t)})}lookupMutationBatch(e,t){return yu(e).get(t).next(e=>e?(y(e.userId===this.userId),Mo(this.It,e)):null)}Tn(e,t){return this.In[t]?A.resolve(this.In[t]):this.lookupMutationBatch(e,t).next(e=>{return e?(e=e.keys(),this.In[t]=e):null})}getNextMutationBatchAfterBatchId(e,t){const r=t+1,n=IDBKeyRange.lowerBound([this.userId,r]);let s=null;return yu(e).Z({index:"userMutationsIndex",range:n},(e,t,n)=>{t.userId===this.userId&&(y(t.batchId>=r),s=Mo(this.It,t)),n.done()}).next(()=>s)}getHighestUnacknowledgedBatchId(e){var t=IDBKeyRange.upperBound([this.userId,Number.POSITIVE_INFINITY]);let r=-1;return yu(e).Z({index:"userMutationsIndex",range:t,reverse:!0},(e,t,n)=>{r=t.batchId,n.done()}).next(()=>r)}getAllMutationBatches(e){var t=IDBKeyRange.bound([this.userId,-1],[this.userId,Number.POSITIVE_INFINITY]);return yu(e).W("userMutationsIndex",t).next(e=>e.map(e=>Mo(this.It,e)))}getAllMutationBatchesAffectingDocumentKey(i,a){const e=to(this.userId,a.path),t=IDBKeyRange.lowerBound(e),o=[];return vu(i).Z({range:t},(e,t,n)=>{var[e,r,s]=e,r=Za(r);if(e===this.userId&&a.path.isEqual(r))return yu(i).get(s).next(e=>{if(!e)throw E();y(e.userId===this.userId),o.push(Mo(this.It,e))});n.done()}).next(()=>o)}getAllMutationBatchesAffectingDocumentKeys(t,e){let a=new N(T);const n=[];return e.forEach(i=>{var e=to(this.userId,i.path),e=IDBKeyRange.lowerBound(e),e=vu(t).Z({range:e},(e,t,n)=>{var[e,r,s]=e,r=Za(r);e===this.userId&&i.path.isEqual(r)?a=a.add(s):n.done()});n.push(e)}),A.waitFor(n).next(()=>this.En(t,a))}getAllMutationBatchesAffectingQuery(e,t){const i=t.path,a=i.length+1,n=to(this.userId,i),r=IDBKeyRange.lowerBound(n);let o=new N(T);return vu(e).Z({range:r},(e,t,n)=>{var[e,r,s]=e,r=Za(r);e===this.userId&&i.isPrefixOf(r)?r.length===a&&(o=o.add(s)):n.done()}).next(()=>this.En(e,o))}En(t,e){const n=[],r=[];return e.forEach(e=>{r.push(yu(t).get(e).next(e=>{if(null===e)throw E();y(e.userId===this.userId),n.push(Mo(this.It,e))}))}),A.waitFor(r).next(()=>n)}removeMutationBatch(t,n){return fu(t.ie,this.userId,n).next(e=>(t.addOnCommittedListener(()=>{this.An(n.batchId)}),A.forEach(e,e=>this.referenceDelegate.markPotentiallyOrphaned(t,e))))}An(e){delete this.In[e]}performConsistencyCheck(t){return this.checkEmpty(t).next(e=>{if(!e)return A.resolve();e=IDBKeyRange.lowerBound([this.userId]);const r=[];return vu(t).Z({range:e},(e,t,n)=>{if(e[0]===this.userId){const t=Za(e[1]);r.push(t)}else n.done()}).next(()=>{y(0===r.length)})})}containsKey(e,t){return pu(e,this.userId,t)}Rn(e){return wu(e).get(this.userId).next(e=>e||{userId:this.userId,lastAcknowledgedBatchId:-1,lastStreamToken:""})}}function pu(e,s,t){const n=to(s,t.path),i=n[1],r=IDBKeyRange.lowerBound(n);let a=!1;return vu(e).Z({range:r,X:!0},(e,t,n)=>{var[e,r]=e;e===s&&r===i&&(a=!0),n.done()}).next(()=>a)}function yu(e){return n(e,"mutations")}function vu(e){return n(e,"documentMutations")}function wu(e){return n(e,"mutationQueues")}class Iu{constructor(e){this.bn=e}next(){return this.bn+=2,this.bn}static Pn(){return new Iu(0)}static vn(){return new Iu(-1)}}class bu{constructor(e,t){this.referenceDelegate=e,this.It=t}allocateTargetId(n){return this.Vn(n).next(e=>{const t=new Iu(e.highestTargetId);return e.highestTargetId=t.next(),this.Sn(n,e).next(()=>e.highestTargetId)})}getLastRemoteSnapshotVersion(e){return this.Vn(e).next(e=>S.fromTimestamp(new h(e.lastRemoteSnapshotVersion.seconds,e.lastRemoteSnapshotVersion.nanoseconds)))}getHighestSequenceNumber(e){return this.Vn(e).next(e=>e.highestListenSequenceNumber)}setTargetsMetadata(t,n,r){return this.Vn(t).next(e=>(e.highestListenSequenceNumber=n,r&&(e.lastRemoteSnapshotVersion=r.toTimestamp()),n>e.highestListenSequenceNumber&&(e.highestListenSequenceNumber=n),this.Sn(t,e)))}addTargetData(t,n){return this.Dn(t,n).next(()=>this.Vn(t).next(e=>(e.targetCount+=1,this.Cn(n,e),this.Sn(t,e))))}updateTargetData(e,t){return this.Dn(e,t)}removeTargetData(t,e){return this.removeMatchingKeysForTargetId(t,e.targetId).next(()=>Eu(t).delete(e.targetId)).next(()=>this.Vn(t)).next(e=>(y(0<e.targetCount),--e.targetCount,this.Sn(t,e)))}removeTargets(n,r,s){let i=0;const a=[];return Eu(n).Z((e,t)=>{t=Oo(t);t.sequenceNumber<=r&&null===s.get(t.targetId)&&(i++,a.push(this.removeTargetData(n,t)))}).next(()=>A.waitFor(a)).next(()=>i)}forEachTarget(e,n){return Eu(e).Z((e,t)=>{t=Oo(t);n(t)})}Vn(e){return Tu(e).get("targetGlobalKey").next(e=>(y(null!==e),e))}Sn(e,t){return Tu(e).put("targetGlobalKey",t)}Dn(e,t){return Eu(e).put(Vo(this.It,t))}Cn(e,t){let n=!1;return e.targetId>t.highestTargetId&&(t.highestTargetId=e.targetId,n=!0),e.sequenceNumber>t.highestListenSequenceNumber&&(t.highestListenSequenceNumber=e.sequenceNumber,n=!0),n}getTargetCount(e){return this.Vn(e).next(e=>e.targetCount)}getTargetData(e,r){var t=Zs(r),t=IDBKeyRange.bound([t,Number.NEGATIVE_INFINITY],[t,Number.POSITIVE_INFINITY]);let s=null;return Eu(e).Z({range:t,index:"queryTargetsIndex"},(e,t,n)=>{t=Oo(t);ei(r,t.target)&&(s=t,n.done())}).next(()=>s)}addMatchingKeys(n,e,r){const s=[],i=Su(n);return e.forEach(e=>{var t=Xa(e.path);s.push(i.put({targetId:r,path:t})),s.push(this.referenceDelegate.addReference(n,r,e))}),A.waitFor(s)}removeMatchingKeys(n,e,r){const s=Su(n);return A.forEach(e,e=>{var t=Xa(e.path);return A.waitFor([s.delete([r,t]),this.referenceDelegate.removeReference(n,r,e)])})}removeMatchingKeysForTargetId(e,t){const n=Su(e),r=IDBKeyRange.bound([t],[t+1],!1,!0);return n.delete(r)}getMatchingKeysForTargetId(e,t){const n=IDBKeyRange.bound([t],[t+1],!1,!0),r=Su(e);let s=O();return r.Z({range:n,X:!0},(e,t,n)=>{e=Za(e[1]),e=new D(e);s=s.add(e)}).next(()=>s)}containsKey(e,t){t=Xa(t.path),t=IDBKeyRange.bound([t],[qr(t)],!1,!0);let r=0;return Su(e).Z({index:"documentTargetsIndex",X:!0,range:t},([e],t,n)=>{0!==e&&(r++,n.done())}).next(()=>0<r)}se(e,t){return Eu(e).get(t).next(e=>e?Oo(e):null)}}function Eu(e){return n(e,"targets")}function Tu(e){return n(e,"targetGlobal")}function Su(e){return n(e,"targetDocuments")}function _u([e,t],[n,r]){e=T(e,n);return 0===e?T(t,r):e}class xu{constructor(e){this.xn=e,this.buffer=new N(_u),this.Nn=0}kn(){return++this.Nn}On(e){var t=[e,this.kn()];if(this.buffer.size<this.xn)this.buffer=this.buffer.add(t);else{const e=this.buffer.last();_u(t,e)<0&&(this.buffer=this.buffer.delete(e).add(t))}}get maxValue(){return this.buffer.last()[0]}}class Du{constructor(e,t,n){this.garbageCollector=e,this.asyncQueue=t,this.localStore=n,this.Mn=null}start(){-1!==this.garbageCollector.params.cacheSizeCollectionThreshold&&this.Fn(6e4)}stop(){this.Mn&&(this.Mn.cancel(),this.Mn=null)}get started(){return null!==this.Mn}Fn(e){f("LruGarbageCollector",`Garbage collection scheduled in ${e}ms`),this.Mn=this.asyncQueue.enqueueAfterDelay("lru_garbage_collection",e,async()=>{this.Mn=null;try{await this.localStore.collectGarbage(this.garbageCollector)}catch(e){as(e)?f("LruGarbageCollector","Ignoring IndexedDB error during garbage collection: ",e):await ts(e)}await this.Fn(3e5)})}}class Au{constructor(e,t){this.$n=e,this.params=t}calculateTargetCount(e,t){return this.$n.Bn(e).next(e=>Math.floor(t/100*e))}nthSequenceNumber(e,t){if(0===t)return A.resolve(fs.at);const n=new xu(t);return this.$n.forEachTarget(e,e=>n.On(e.sequenceNumber)).next(()=>this.$n.Ln(e,e=>n.On(e))).next(()=>n.maxValue)}removeTargets(e,t,n){return this.$n.removeTargets(e,t,n)}removeOrphanedDocuments(e,t){return this.$n.removeOrphanedDocuments(e,t)}collect(t,n){return-1===this.params.cacheSizeCollectionThreshold?(f("LruGarbageCollector","Garbage collection skipped; disabled"),A.resolve(lu)):this.getCacheSize(t).next(e=>e<this.params.cacheSizeCollectionThreshold?(f("LruGarbageCollector",`Garbage collection skipped; Cache size ${e} is lower than threshold `+this.params.cacheSizeCollectionThreshold),lu):this.Un(t,n))}getCacheSize(e){return this.$n.getCacheSize(e)}Un(t,n){let r,s,i,a,o,u,c;const h=Date.now();return this.calculateTargetCount(t,this.params.percentileToCollect).next(e=>(s=e>this.params.maximumSequenceNumbersToCollect?(f("LruGarbageCollector",`Capping sequence numbers to collect down to the maximum of ${this.params.maximumSequenceNumbersToCollect} from `+e),this.params.maximumSequenceNumbersToCollect):e,a=Date.now(),this.nthSequenceNumber(t,s))).next(e=>(r=e,o=Date.now(),this.removeTargets(t,r,n))).next(e=>(i=e,u=Date.now(),this.removeOrphanedDocuments(t,r))).next(e=>(c=Date.now(),Ar()<=l.DEBUG&&f("LruGarbageCollector",`LRU Garbage Collection
	Counted targets in ${a-h}ms
	Determined least recently used ${s} in `+(o-a)+"ms\n"+`	Removed ${i} targets in `+(u-o)+"ms\n"+`	Removed ${e} documents in `+(c-u)+"ms\n"+`Total Duration: ${c-h}ms`),A.resolve({didRun:!0,sequenceNumbersCollected:s,targetsRemoved:i,documentsRemoved:e})))}}class Cu{constructor(e,t){this.db=e,this.garbageCollector=(e=this,new Au(e,t))}Bn(e){const n=this.qn(e);return this.db.getTargetCache().getTargetCount(e).next(t=>n.next(e=>t+e))}qn(e){let t=0;return this.Ln(e,e=>{t++}).next(()=>t)}forEachTarget(e,t){return this.db.getTargetCache().forEachTarget(e,t)}Ln(e,n){return this.Kn(e,(e,t)=>n(t))}addReference(e,t,n){return Nu(e,n)}removeReference(e,t,n){return Nu(e,n)}removeTargets(e,t,n){return this.db.getTargetCache().removeTargets(e,t,n)}markPotentiallyOrphaned(e,t){return Nu(e,t)}Gn(t,n){let r=!1;return wu(t).tt(e=>pu(t,e,n).next(e=>(e&&(r=!0),A.resolve(!e)))).next(()=>r)}removeOrphanedDocuments(n,r){const s=this.db.getRemoteDocumentCache().newChangeBuffer(),i=[];let a=0;return this.Kn(n,(t,e)=>{if(e<=r){const r=this.Gn(n,t).next(e=>{if(!e)return a++,s.getEntry(n,t).next(()=>(s.removeEntry(t,S.min()),Su(n).delete([0,Xa(t.path)])))});i.push(r)}}).next(()=>A.waitFor(i)).next(()=>s.apply(n)).next(()=>a)}removeTarget(e,t){t=t.withSequenceNumber(e.currentSequenceNumber);return this.db.getTargetCache().updateTargetData(e,t)}updateLimboDocument(e,t){return Nu(e,t)}Kn(e,r){const t=Su(e);let s,i=fs.at;return t.Z({index:"documentTargetsIndex"},([e],{path:t,sequenceNumber:n})=>{0===e?(i!==fs.at&&r(new D(Za(s)),i),i=n,s=t):i=fs.at}).next(()=>{i!==fs.at&&r(new D(Za(s)),i)})}getCacheSize(e){return this.db.getRemoteDocumentCache().getSize(e)}}function Nu(e,t){return Su(e).put((e=e.currentSequenceNumber,{targetId:0,path:Xa(t.path),sequenceNumber:e}))}class ku{constructor(){this.changes=new ha(e=>e.toString(),(e,t)=>e.isEqual(t)),this.changesApplied=!1}addEntry(e){this.assertNotApplied(),this.changes.set(e.key,e)}removeEntry(e,t){this.assertNotApplied(),this.changes.set(e,L.newInvalidDocument(e).setReadTime(t))}getEntry(e,t){this.assertNotApplied();var n=this.changes.get(t);return void 0!==n?A.resolve(n):this.getFromCache(e,t)}getEntries(e,t){return this.getAllFromCache(e,t)}apply(e){return this.assertNotApplied(),this.changesApplied=!0,this.applyChanges(e)}assertNotApplied(){}}class Ru{constructor(e){this.It=e}setIndexManager(e){this.indexManager=e}addEntry(e,t,n){return Vu(e).put(n)}removeEntry(e,n,t){return Vu(e).delete(function(e){const t=n.path.toArray();return[t.slice(0,t.length-2),t[t.length-2],ko(e),t[t.length-1]]}(t))}updateMetadata(t,n){return this.getMetadata(t).next(e=>(e.byteSize+=n,this.Qn(t,e)))}getEntry(e,n){let r=L.newInvalidDocument(n);return Vu(e).Z({index:"documentKeyIndex",range:IDBKeyRange.only(Fu(n))},(e,t)=>{r=this.jn(n,t)}).next(()=>r)}Wn(e,n){let r={size:0,document:L.newInvalidDocument(n)};return Vu(e).Z({index:"documentKeyIndex",range:IDBKeyRange.only(Fu(n))},(e,t)=>{r={document:this.jn(n,t),size:gu(t)}}).next(()=>r)}getEntries(e,t){let n=la;return this.zn(e,t,(e,t)=>{t=this.jn(e,t);n=n.insert(e,t)}).next(()=>n)}Hn(e,t){let r=la,s=new C(D.comparator);return this.zn(e,t,(e,t)=>{var n=this.jn(e,t);r=r.insert(e,n),s=s.insert(e,gu(t))}).next(()=>({documents:r,Jn:s}))}zn(e,t,s){if(t.isEmpty())return A.resolve();let n=new N(Bu);t.forEach(e=>n=n.add(e));const r=IDBKeyRange.bound(Fu(n.first()),Fu(n.last())),i=n.getIterator();let a=i.getNext();return Vu(e).Z({index:"documentKeyIndex",range:r},(e,t,n)=>{for(var r=D.fromSegments([...t.prefixPath,t.collectionGroup,t.documentId]);a&&Bu(a,r)<0;)s(a,null),a=i.getNext();a&&a.isEqual(r)&&(s(a,t),a=i.hasNext()?i.getNext():null),a?n.j(Fu(a)):n.done()}).next(()=>{for(;a;)s(a,null),a=i.hasNext()?i.getNext():null})}getAllFromCollection(e,t,n){n=[t.popLast().toArray(),t.lastSegment(),ko(n.readTime),n.documentKey.path.isEmpty()?"":n.documentKey.path.lastSegment()],t=[t.popLast().toArray(),t.lastSegment(),[Number.MAX_SAFE_INTEGER,Number.MAX_SAFE_INTEGER],""];return Vu(e).W(IDBKeyRange.bound(n,t,!0)).next(e=>{let t=la;for(const n of e){const e=this.jn(D.fromSegments(n.prefixPath.concat(n.collectionGroup,n.documentId)),n);t=t.insert(e.key,e)}return t})}getAllFromCollectionGroup(e,t,n,r){let s=la;n=Pu(t,n),t=Pu(t,Xr.max());return Vu(e).Z({index:"collectionGroupIndex",range:IDBKeyRange.bound(n,t,!0)},(e,t,n)=>{t=this.jn(D.fromSegments(t.prefixPath.concat(t.collectionGroup,t.documentId)),t);(s=s.insert(t.key,t)).size===r&&n.done()}).next(()=>s)}newChangeBuffer(e){return new Mu(this,!!e&&e.trackRemovals)}getSize(e){return this.getMetadata(e).next(e=>e.byteSize)}getMetadata(e){return Ou(e).get("remoteDocumentGlobalKey").next(e=>(y(!!e),e))}Qn(e,t){return Ou(e).put("remoteDocumentGlobalKey",t)}jn(e,t){if(t){const e=function(e,t){let n;if(t.document)n=Ka(e.re,t.document,!!t.hasCommittedMutations);else if(t.noDocument){const e=D.fromSegments(t.noDocument.path),r=Lo(t.noDocument.readTime);n=L.newNoDocument(e,r),t.hasCommittedMutations&&n.setHasCommittedMutations()}else{if(!t.unknownDocument)return E();{const e=D.fromSegments(t.unknownDocument.path),s=Lo(t.unknownDocument.version);n=L.newUnknownDocument(e,s)}}return t.readTime&&n.setReadTime((t=t.readTime,e=new h(t[0],t[1]),S.fromTimestamp(e))),n}(this.It,t);if(!e.isNoDocument()||!e.version.isEqual(S.min()))return e}return L.newInvalidDocument(e)}}function Lu(e){return new Ru(e)}class Mu extends ku{constructor(e,t){super(),this.Yn=e,this.trackRemovals=t,this.Xn=new ha(e=>e.toString(),(e,t)=>e.isEqual(t))}applyChanges(i){const a=[];let o=0,u=new N((e,t)=>T(e.canonicalString(),t.canonicalString()));return this.changes.forEach((e,t)=>{var n=this.Xn.get(e);if(a.push(this.Yn.removeEntry(i,e,n.readTime)),t.isValidDocument()){var r=No(this.Yn.It,t),s=(u=u.add(e.path.popLast()),gu(r));o+=s-n.size,a.push(this.Yn.addEntry(i,e,r))}else if(o-=n.size,this.trackRemovals){const o=No(this.Yn.It,t.convertToNoDocument(S.min()));a.push(this.Yn.addEntry(i,e,o))}}),u.forEach(e=>{a.push(this.Yn.indexManager.addToCollectionParentIndex(i,e))}),a.push(this.Yn.updateMetadata(i,o)),A.waitFor(a)}getFromCache(e,t){return this.Yn.Wn(e,t).next(e=>(this.Xn.set(t,{size:e.size,readTime:e.document.readTime}),e.document))}getAllFromCache(e,t){return this.Yn.Hn(e,t).next(({documents:n,Jn:e})=>(e.forEach((e,t)=>{this.Xn.set(e,{size:t,readTime:n.get(e).readTime})}),n))}}function Ou(e){return n(e,"remoteDocumentGlobal")}function Vu(e){return n(e,"remoteDocumentsV14")}function Fu(e){const t=e.path.toArray();return[t.slice(0,t.length-2),t[t.length-2],t[t.length-1]]}function Pu(e,t){const n=t.documentKey.path.toArray();return[e,ko(t.readTime),n.slice(0,n.length-2),0<n.length?n[n.length-1]:""]}function Bu(e,t){var n=e.path.toArray(),r=t.path.toArray();let s=0;for(let e=0;e<n.length-2&&e<r.length-2;++e)if(s=T(n[e],r[e]))return s;return(s=T(n.length,r.length))||((s=T(n[n.length-2],r[r.length-2]))||T(n[n.length-1],r[r.length-1]))}class Uu{constructor(e,t){this.overlayedDocument=e,this.mutatedFields=t}}class qu{constructor(e,t,n,r){this.remoteDocumentCache=e,this.mutationQueue=t,this.documentOverlayCache=n,this.indexManager=r}getDocument(t,n){let r=null;return this.documentOverlayCache.getOverlay(t,n).next(e=>(r=e,this.getBaseDocument(t,n,r))).next(e=>(null!==r&&Ji(r.mutation,e,bs.empty(),h.now()),e))}getDocuments(t,e){return this.remoteDocumentCache.getEntries(t,e).next(e=>this.getLocalViewOfDocuments(t,e,O()).next(()=>e))}getLocalViewOfDocuments(e,t,n=O()){const r=ma();return this.populateOverlays(e,r,t).next(()=>this.computeViews(e,t,r,n).next(e=>{let n=fa();return e.forEach((e,t)=>{n=n.insert(e,t.overlayedDocument)}),n}))}getOverlayedDocuments(e,t){const n=ma();return this.populateOverlays(e,n,t).next(()=>this.computeViews(e,t,n,O()))}populateOverlays(e,n,t){const r=[];return t.forEach(e=>{n.has(e)||r.push(e)}),this.documentOverlayCache.getOverlays(e,r).next(e=>{e.forEach((e,t)=>{n.set(e,t)})})}computeViews(e,t,r,s){let i=la;const a=ma(),n=ma();return t.forEach((e,t)=>{const n=r.get(t.key);s.has(t.key)&&(void 0===n||n.mutation instanceof ta)?i=i.insert(t.key,t):void 0!==n&&(a.set(t.key,n.mutation.getFieldMask()),Ji(n.mutation,t,n.mutation.getFieldMask(),h.now()))}),this.recalculateAndSaveOverlays(e,i).next(e=>(e.forEach((e,t)=>a.set(e,t)),t.forEach((e,t)=>{return n.set(e,new Uu(t,null!=(t=a.get(e))?t:null))}),n))}recalculateAndSaveOverlays(i,a){const o=ma();let u=new C((e,t)=>e-t),c=O();return this.mutationQueue.getAllMutationBatchesAffectingDocumentKeys(i,a).next(e=>{for(const r of e)r.keys().forEach(e=>{var t,n=a.get(e);null!==n&&(t=o.get(e)||bs.empty(),t=r.applyToLocalView(n,t),o.set(e,t),t=(u.get(r.batchId)||O()).add(e),u=u.insert(r.batchId,t))})}).next(()=>{const e=[],t=u.getReverseIterator();for(;t.hasNext();){const u=t.getNext(),n=u.key,r=u.value,s=ma();r.forEach(e=>{var t;c.has(e)||(null!==(t=Xi(a.get(e),o.get(e)))&&s.set(e,t),c=c.add(e))}),e.push(this.documentOverlayCache.saveOverlays(i,n,s))}return A.waitFor(e)}).next(()=>o)}recalculateAndSaveOverlaysForDocumentKeys(t,e){return this.remoteDocumentCache.getEntries(t,e).next(e=>this.recalculateAndSaveOverlays(t,e))}getDocumentsMatchingQuery(e,t,n){return r=t,D.isDocumentKey(r.path)&&null===r.collectionGroup&&0===r.filters.length?this.getDocumentsMatchingDocumentQuery(e,t.path):Si(t)?this.getDocumentsMatchingCollectionGroupQuery(e,t,n):this.getDocumentsMatchingCollectionQuery(e,t,n);var r}getNextDocuments(i,t,a,o){return this.remoteDocumentCache.getAllFromCollectionGroup(i,t,a,o).next(n=>{const e=0<o-n.size?this.documentOverlayCache.getOverlaysForCollectionGroup(i,t,a.largestBatchId,o-n.size):A.resolve(ma());let r=-1,s=n;return e.next(e=>A.forEach(e,(t,e)=>(r<e.largestBatchId&&(r=e.largestBatchId),n.get(t)?A.resolve():this.getBaseDocument(i,t,e).next(e=>{s=s.insert(t,e)}))).next(()=>this.populateOverlays(i,e,n)).next(()=>this.computeViews(i,s,e,O())).next(e=>({batchId:r,changes:ga(e)})))})}getDocumentsMatchingDocumentQuery(e,t){return this.getDocument(e,new D(t)).next(e=>{let t=fa();return t=e.isFoundDocument()?t.insert(e.key,e):t})}getDocumentsMatchingCollectionGroupQuery(n,r,s){const i=r.collectionGroup;let a=fa();return this.indexManager.getCollectionParents(n,i).next(e=>A.forEach(e,e=>{t=r,e=e.child(i);var t,e=new vi(e,null,t.explicitOrderBy.slice(),t.filters.slice(),t.limit,t.limitType,t.startAt,t.endAt);return this.getDocumentsMatchingCollectionQuery(n,e,s).next(e=>{e.forEach((e,t)=>{a=a.insert(e,t)})})}).next(()=>a))}getDocumentsMatchingCollectionQuery(t,i,n){let a;return this.remoteDocumentCache.getAllFromCollection(t,i.path,n).next(e=>(a=e,this.documentOverlayCache.getOverlaysForCollection(t,i.path,n.largestBatchId))).next(r=>{r.forEach((e,t)=>{t=t.getKey();null===a.get(t)&&(a=a.insert(t,L.newInvalidDocument(t)))});let s=fa();return a.forEach((e,t)=>{var n=r.get(e);void 0!==n&&Ji(n.mutation,t,bs.empty(),h.now()),ki(i,t)&&(s=s.insert(e,t))}),s})}getBaseDocument(e,t,n){return null===n||1===n.mutation.type?this.remoteDocumentCache.getEntry(e,t):A.resolve(L.newInvalidDocument(t))}}class Ku{constructor(e){this.It=e,this.Zn=new Map,this.ts=new Map}getBundleMetadata(e,t){return A.resolve(this.Zn.get(t))}saveBundleMetadata(e,t){return this.Zn.set(t.id,{id:t.id,version:t.version,createTime:V(t.createTime)}),A.resolve()}getNamedQuery(e,t){return A.resolve(this.ts.get(t))}saveNamedQuery(e,t){return this.ts.set(t.name,{name:t.name,query:Fo(t.bundledQuery),readTime:V(t.readTime)}),A.resolve()}}class Gu{constructor(){this.overlays=new C(D.comparator),this.es=new Map}getOverlay(e,t){return A.resolve(this.overlays.get(t))}getOverlays(e,t){const n=ma();return A.forEach(t,t=>this.getOverlay(e,t).next(e=>{null!==e&&n.set(t,e)})).next(()=>n)}saveOverlays(n,r,e){return e.forEach((e,t)=>{this.ue(n,r,t)}),A.resolve()}removeOverlaysForBatchId(e,t,n){const r=this.es.get(n);return void 0!==r&&(r.forEach(e=>this.overlays=this.overlays.remove(e)),this.es.delete(n)),A.resolve()}getOverlaysForCollection(e,t,n){const r=ma(),s=t.length+1,i=new D(t.child("")),a=this.overlays.getIteratorFrom(i);for(;a.hasNext();){const e=a.getNext().value,i=e.getKey();if(!t.isPrefixOf(i.path))break;i.path.length===s&&e.largestBatchId>n&&r.set(e.getKey(),e)}return A.resolve(r)}getOverlaysForCollectionGroup(t,e,n,r){let s=new C((e,t)=>e-t);const i=this.overlays.getIterator();for(;i.hasNext();){const t=i.getNext().value;if(t.getKey().getCollectionGroup()===e&&t.largestBatchId>n){let e=s.get(t.largestBatchId);null===e&&(e=ma(),s=s.insert(t.largestBatchId,e)),e.set(t.getKey(),t)}}const a=ma(),o=s.getIterator();for(;o.hasNext()&&(o.getNext().value.forEach((e,t)=>a.set(e,t)),!(a.size()>=r)););return A.resolve(a)}ue(e,t,n){var r=this.overlays.get(n.key);if(null!==r){const e=this.es.get(r.largestBatchId).delete(n.key);this.es.set(r.largestBatchId,e)}this.overlays=this.overlays.insert(n.key,new Do(t,n));let s=this.es.get(t);void 0===s&&(s=O(),this.es.set(t,s)),this.es.set(t,s.add(n.key))}}class ju{constructor(){this.ns=new N(a.ss),this.rs=new N(a.os)}isEmpty(){return this.ns.isEmpty()}addReference(e,t){e=new a(e,t);this.ns=this.ns.add(e),this.rs=this.rs.add(e)}us(e,t){e.forEach(e=>this.addReference(e,t))}removeReference(e,t){this.cs(new a(e,t))}hs(e,t){e.forEach(e=>this.removeReference(e,t))}ls(e){const t=new D(new _([])),n=new a(t,e),r=new a(t,e+1),s=[];return this.rs.forEachInRange([n,r],e=>{this.cs(e),s.push(e.key)}),s}fs(){this.ns.forEach(e=>this.cs(e))}cs(e){this.ns=this.ns.delete(e),this.rs=this.rs.delete(e)}ds(e){var t=new D(new _([])),n=new a(t,e),t=new a(t,e+1);let r=O();return this.rs.forEachInRange([n,t],e=>{r=r.add(e.key)}),r}containsKey(e){var t=new a(e,0);return null!==(t=this.ns.firstAfterOrEqual(t))&&e.isEqual(t.key)}}class a{constructor(e,t){this.key=e,this._s=t}static ss(e,t){return D.comparator(e.key,t.key)||T(e._s,t._s)}static os(e,t){return T(e._s,t._s)||D.comparator(e.key,t.key)}}class Qu{constructor(e,t){this.indexManager=e,this.referenceDelegate=t,this.mutationQueue=[],this.ws=1,this.gs=new N(a.ss)}checkEmpty(e){return A.resolve(0===this.mutationQueue.length)}addMutationBatch(e,t,n,r){var s=this.ws,t=(this.ws++,0<this.mutationQueue.length&&this.mutationQueue[this.mutationQueue.length-1],new _o(s,t,n,r));this.mutationQueue.push(t);for(const t of r)this.gs=this.gs.add(new a(t.key,s)),this.indexManager.addToCollectionParentIndex(e,t.key.path.popLast());return A.resolve(t)}lookupMutationBatch(e,t){return A.resolve(this.ys(t))}getNextMutationBatchAfterBatchId(e,t){t=(t=this.ps(t+1))<0?0:t;return A.resolve(this.mutationQueue.length>t?this.mutationQueue[t]:null)}getHighestUnacknowledgedBatchId(){return A.resolve(0===this.mutationQueue.length?-1:this.ws-1)}getAllMutationBatches(e){return A.resolve(this.mutationQueue.slice())}getAllMutationBatchesAffectingDocumentKey(e,t){const n=new a(t,0),r=new a(t,Number.POSITIVE_INFINITY),s=[];return this.gs.forEachInRange([n,r],e=>{e=this.ys(e._s);s.push(e)}),A.resolve(s)}getAllMutationBatchesAffectingDocumentKeys(e,t){let n=new N(T);return t.forEach(e=>{var t=new a(e,0),e=new a(e,Number.POSITIVE_INFINITY);this.gs.forEachInRange([t,e],e=>{n=n.add(e._s)})}),A.resolve(this.Is(n))}getAllMutationBatchesAffectingQuery(e,t){const n=t.path,r=n.length+1;let s=n;D.isDocumentKey(s)||(s=s.child(""));t=new a(new D(s),0);let i=new N(T);return this.gs.forEachWhile(e=>{var t=e.key.path;return!!n.isPrefixOf(t)&&(t.length===r&&(i=i.add(e._s)),!0)},t),A.resolve(this.Is(i))}Is(e){const t=[];return e.forEach(e=>{e=this.ys(e);null!==e&&t.push(e)}),t}removeMutationBatch(n,r){y(0===this.Ts(r.batchId,"removed")),this.mutationQueue.shift();let s=this.gs;return A.forEach(r.mutations,e=>{var t=new a(e.key,r.batchId);return s=s.delete(t),this.referenceDelegate.markPotentiallyOrphaned(n,e.key)}).next(()=>{this.gs=s})}An(e){}containsKey(e,t){var n=new a(t,0),n=this.gs.firstAfterOrEqual(n);return A.resolve(t.isEqual(n&&n.key))}performConsistencyCheck(e){return this.mutationQueue.length,A.resolve()}Ts(e,t){return this.ps(e)}ps(e){return 0===this.mutationQueue.length?0:e-this.mutationQueue[0].batchId}ys(e){e=this.ps(e);return e<0||e>=this.mutationQueue.length?null:this.mutationQueue[e]}}class zu{constructor(e){this.Es=e,this.docs=new C(D.comparator),this.size=0}setIndexManager(e){this.indexManager=e}addEntry(e,t){const n=t.key,r=this.docs.get(n),s=r?r.size:0,i=this.Es(t);return this.docs=this.docs.insert(n,{document:t.mutableCopy(),size:i}),this.size+=i-s,this.indexManager.addToCollectionParentIndex(e,n.path.popLast())}removeEntry(e){var t=this.docs.get(e);t&&(this.docs=this.docs.remove(e),this.size-=t.size)}getEntry(e,t){const n=this.docs.get(t);return A.resolve(n?n.document.mutableCopy():L.newInvalidDocument(t))}getEntries(e,t){let n=la;return t.forEach(e=>{const t=this.docs.get(e);n=n.insert(e,t?t.document.mutableCopy():L.newInvalidDocument(e))}),A.resolve(n)}getAllFromCollection(e,t,n){let r=la;const s=new D(t.child("")),i=this.docs.getIteratorFrom(s);for(;i.hasNext();){const{key:e,value:{document:s}}=i.getNext();if(!t.isPrefixOf(e.path))break;e.path.length>t.length+1||Jr(Yr(s),n)<=0||(r=r.insert(s.key,s.mutableCopy()))}return A.resolve(r)}getAllFromCollectionGroup(e,t,n,r){E()}As(e,t){return A.forEach(this.docs,e=>t(e))}newChangeBuffer(e){return new Hu(this)}getSize(e){return A.resolve(this.size)}}class Hu extends ku{constructor(e){super(),this.Yn=e}applyChanges(n){const r=[];return this.changes.forEach((e,t)=>{t.isValidDocument()?r.push(this.Yn.addEntry(n,t)):this.Yn.removeEntry(e)}),A.waitFor(r)}getFromCache(e,t){return this.Yn.getEntry(e,t)}getAllFromCache(e,t){return this.Yn.getEntries(e,t)}}class Wu{constructor(e){this.persistence=e,this.Rs=new ha(e=>Zs(e),ei),this.lastRemoteSnapshotVersion=S.min(),this.highestTargetId=0,this.bs=0,this.Ps=new ju,this.targetCount=0,this.vs=Iu.Pn()}forEachTarget(e,n){return this.Rs.forEach((e,t)=>n(t)),A.resolve()}getLastRemoteSnapshotVersion(e){return A.resolve(this.lastRemoteSnapshotVersion)}getHighestSequenceNumber(e){return A.resolve(this.bs)}allocateTargetId(e){return this.highestTargetId=this.vs.next(),A.resolve(this.highestTargetId)}setTargetsMetadata(e,t,n){return n&&(this.lastRemoteSnapshotVersion=n),t>this.bs&&(this.bs=t),A.resolve()}Dn(e){this.Rs.set(e.target,e);var t=e.targetId;t>this.highestTargetId&&(this.vs=new Iu(t),this.highestTargetId=t),e.sequenceNumber>this.bs&&(this.bs=e.sequenceNumber)}addTargetData(e,t){return this.Dn(t),this.targetCount+=1,A.resolve()}updateTargetData(e,t){return this.Dn(t),A.resolve()}removeTargetData(e,t){return this.Rs.delete(t.target),this.Ps.ls(t.targetId),--this.targetCount,A.resolve()}removeTargets(n,r,s){let i=0;const a=[];return this.Rs.forEach((e,t)=>{t.sequenceNumber<=r&&null===s.get(t.targetId)&&(this.Rs.delete(e),a.push(this.removeMatchingKeysForTargetId(n,t.targetId)),i++)}),A.waitFor(a).next(()=>i)}getTargetCount(e){return A.resolve(this.targetCount)}getTargetData(e,t){t=this.Rs.get(t)||null;return A.resolve(t)}addMatchingKeys(e,t,n){return this.Ps.us(t,n),A.resolve()}removeMatchingKeys(t,e,n){this.Ps.hs(e,n);const r=this.persistence.referenceDelegate,s=[];return r&&e.forEach(e=>{s.push(r.markPotentiallyOrphaned(t,e))}),A.waitFor(s)}removeMatchingKeysForTargetId(e,t){return this.Ps.ls(t),A.resolve()}getMatchingKeysForTargetId(e,t){t=this.Ps.ds(t);return A.resolve(t)}containsKey(e,t){return A.resolve(this.Ps.containsKey(t))}}class $u{constructor(e,t){this.Vs={},this.overlays={},this.Ss=new fs(0),this.Ds=!1,this.Ds=!0,this.referenceDelegate=e(this),this.Cs=new Wu(this),this.indexManager=new nu,this.remoteDocumentCache=(e=e=>this.referenceDelegate.xs(e),new zu(e)),this.It=new Co(t),this.Ns=new Ku(this.It)}start(){return Promise.resolve()}shutdown(){return this.Ds=!1,Promise.resolve()}get started(){return this.Ds}setDatabaseDeletedListener(){}setNetworkEnabled(){}getIndexManager(e){return this.indexManager}getDocumentOverlayCache(e){let t=this.overlays[e.toKey()];return t||(t=new Gu,this.overlays[e.toKey()]=t),t}getMutationQueue(e,t){let n=this.Vs[e.toKey()];return n||(n=new Qu(t,this.referenceDelegate),this.Vs[e.toKey()]=n),n}getTargetCache(){return this.Cs}getRemoteDocumentCache(){return this.remoteDocumentCache}getBundleCache(){return this.Ns}runTransaction(e,t,n){f("MemoryPersistence","Starting transaction:",e);const r=new Yu(this.Ss.next());return this.referenceDelegate.ks(),n(r).next(e=>this.referenceDelegate.Os(r).next(()=>e)).toPromise().then(e=>(r.raiseOnCommittedEvent(),e))}Ms(t,n){return A.or(Object.values(this.Vs).map(e=>()=>e.containsKey(t,n)))}}class Yu extends es{constructor(e){super(),this.currentSequenceNumber=e}}class Xu{constructor(e){this.persistence=e,this.Fs=new ju,this.$s=null}static Bs(e){return new Xu(e)}get Ls(){if(this.$s)return this.$s;throw E()}addReference(e,t,n){return this.Fs.addReference(n,t),this.Ls.delete(n.toString()),A.resolve()}removeReference(e,t,n){return this.Fs.removeReference(n,t),this.Ls.add(n.toString()),A.resolve()}markPotentiallyOrphaned(e,t){return this.Ls.add(t.toString()),A.resolve()}removeTarget(e,t){this.Fs.ls(t.targetId).forEach(e=>this.Ls.add(e.toString()));const n=this.persistence.getTargetCache();return n.getMatchingKeysForTargetId(e,t.targetId).next(e=>{e.forEach(e=>this.Ls.add(e.toString()))}).next(()=>n.removeTargetData(e,t))}ks(){this.$s=new Set}Os(n){const r=this.persistence.getRemoteDocumentCache().newChangeBuffer();return A.forEach(this.Ls,e=>{const t=D.fromPath(e);return this.Us(n,t).next(e=>{e||r.removeEntry(t,S.min())})}).next(()=>(this.$s=null,r.apply(n)))}updateLimboDocument(e,t){return this.Us(e,t).next(e=>{e?this.Ls.delete(t.toString()):this.Ls.add(t.toString())})}xs(e){return 0}Us(e,t){return A.or([()=>A.resolve(this.Fs.containsKey(t)),()=>this.persistence.getTargetCache().containsKey(e,t),()=>this.persistence.Ms(e,t)])}}class Ju{constructor(e){this.It=e}$(t,e,n,r){const i=new ns("createOrUpgrade",e);var s;n<1&&1<=r&&(t.createObjectStore("owner"),(s=t).createObjectStore("mutationQueues",{keyPath:"userId"}),s.createObjectStore("mutations",{keyPath:"batchId",autoIncrement:!0}).createIndex("userMutationsIndex",eo,{unique:!0}),s.createObjectStore("documentMutations"),Zu(t),t.createObjectStore("remoteDocuments"));let a=A.resolve();return n<3&&3<=r&&(0!==n&&((s=t).deleteObjectStore("targetDocuments"),s.deleteObjectStore("targets"),s.deleteObjectStore("targetGlobal"),Zu(t)),a=a.next(()=>{{const e=i.store("targetGlobal"),t={highestTargetId:0,highestListenSequenceNumber:0,lastRemoteSnapshotVersion:S.min().toTimestamp(),targetCount:0};return e.put("targetGlobalKey",t)}})),n<4&&4<=r&&(a=(a=0!==n?a.next(()=>{var r=t,s=i;return s.store("mutations").W().next(e=>{r.deleteObjectStore("mutations"),r.createObjectStore("mutations",{keyPath:"batchId",autoIncrement:!0}).createIndex("userMutationsIndex",eo,{unique:!0});const t=s.store("mutations"),n=e.map(e=>t.put(e));return A.waitFor(n)})}):a).next(()=>{t.createObjectStore("clientMetadata",{keyPath:"clientId"})})),n<5&&5<=r&&(a=a.next(()=>this.qs(i))),n<6&&6<=r&&(a=a.next(()=>(t.createObjectStore("remoteDocumentGlobal"),this.Ks(i)))),n<7&&7<=r&&(a=a.next(()=>this.Gs(i))),n<8&&8<=r&&(a=a.next(()=>this.Qs(t,i))),n<9&&9<=r&&(a=a.next(()=>{var e;(e=t).objectStoreNames.contains("remoteDocumentChanges")&&e.deleteObjectStore("remoteDocumentChanges")})),n<10&&10<=r&&(a=a.next(()=>this.js(i))),n<11&&11<=r&&(a=a.next(()=>{t.createObjectStore("bundles",{keyPath:"bundleId"}),t.createObjectStore("namedQueries",{keyPath:"name"})})),n<12&&12<=r&&(a=a.next(()=>{{const e=t.createObjectStore("documentOverlays",{keyPath:po});return e.createIndex("collectionPathOverlayIndex",yo,{unique:!1}),void e.createIndex("collectionGroupOverlayIndex",vo,{unique:!1})}})),n<13&&13<=r&&(a=a.next(()=>{{const e=t.createObjectStore("remoteDocumentsV14",{keyPath:so});return e.createIndex("documentKeyIndex",io),void e.createIndex("collectionGroupIndex",ao)}}).next(()=>this.Ws(t,i)).next(()=>t.deleteObjectStore("remoteDocuments"))),n<14&&14<=r&&(a=a.next(()=>this.zs(t,i))),a=n<15&&15<=r?a.next(()=>{var e=t;e.createObjectStore("indexConfiguration",{keyPath:"indexId",autoIncrement:!0}).createIndex("collectionGroupIndex","collectionGroup",{unique:!1}),e.createObjectStore("indexState",{keyPath:lo}).createIndex("sequenceNumberIndex",fo,{unique:!1}),e.createObjectStore("indexEntries",{keyPath:go}).createIndex("documentKeyIndex",mo,{unique:!1})}):a}Ks(t){let n=0;return t.store("remoteDocuments").Z((e,t)=>{n+=gu(t)}).next(()=>{var e={byteSize:n};return t.store("remoteDocumentGlobal").put("remoteDocumentGlobalKey",e)})}qs(n){const e=n.store("mutationQueues"),r=n.store("mutations");return e.W().next(e=>A.forEach(e,t=>{var e=IDBKeyRange.bound([t.userId,-1],[t.userId,t.lastAcknowledgedBatchId]);return r.W("userMutationsIndex",e).next(e=>A.forEach(e,e=>{y(e.userId===t.userId);e=Mo(this.It,e);return fu(n,t.userId,e).next(()=>{})}))}))}Gs(e){const a=e.store("targetDocuments"),t=e.store("remoteDocuments");return e.store("targetGlobal").get("targetGlobalKey").next(s=>{const i=[];return t.Z((e,t)=>{const n=new _(e),r=[0,Xa(n)];i.push(a.get(r).next(e=>e?A.resolve():(e=>a.put({targetId:0,path:Xa(e),sequenceNumber:s.highestListenSequenceNumber}))(n)))}).next(()=>A.waitFor(i))})}Qs(e,t){e.createObjectStore("collectionParents",{keyPath:ho});const n=t.store("collectionParents"),r=new ru,s=e=>{if(r.add(e)){const t=e.lastSegment(),r=e.popLast();return n.put({collectionId:t,parent:Xa(r)})}};return t.store("remoteDocuments").Z({X:!0},(e,t)=>{const n=new _(e);return s(n.popLast())}).next(()=>t.store("documentMutations").Z({X:!0},([,e],t)=>{const n=Za(e);return s(n.popLast())}))}js(e){const n=e.store("targets");return n.Z((e,t)=>{t=Oo(t),t=Vo(this.It,t);return n.put(t)})}Ws(e,i){const t=i.store("remoteDocuments"),a=[];return t.Z((e,t)=>{const n=i.store("remoteDocumentsV14"),r=((s=t).document?new D(_.fromString(s.document.name).popFirst(5)):s.noDocument?D.fromSegments(s.noDocument.path):s.unknownDocument?D.fromSegments(s.unknownDocument.path):E()).path.toArray();var s={prefixPath:r.slice(0,r.length-2),collectionGroup:r[r.length-2],documentId:r[r.length-1],readTime:t.readTime||[0,0],unknownDocument:t.unknownDocument,noDocument:t.noDocument,document:t.document,hasCommittedMutations:!!t.hasCommittedMutations};a.push(n.put(s))}).next(()=>A.waitFor(a))}zs(e,s){const t=s.store("mutations"),i=Lu(this.It),a=new $u(Xu.Bs,this.It.re);return t.W().next(e=>{const r=new Map;return e.forEach(e=>{var t;let n=null!=(t=r.get(e.userId))?t:O();Mo(this.It,e).keys().forEach(e=>n=n.add(e)),r.set(e.userId,n)}),A.forEach(r,(e,t)=>{var t=new o(t),n=jo.oe(this.It,t),r=a.getIndexManager(t),t=mu.oe(t,this.It,r,a.referenceDelegate);return new qu(i,t,n,r).recalculateAndSaveOverlaysForDocumentKeys(new So(s,fs.at),e).next()})})}}function Zu(e){e.createObjectStore("targetDocuments",{keyPath:uo}).createIndex("documentTargetsIndex",co,{unique:!0}),e.createObjectStore("targets",{keyPath:"targetId"}).createIndex("queryTargetsIndex",oo,{unique:!0}),e.createObjectStore("targetGlobal")}const ec="Failed to obtain exclusive access to the persistence layer. To allow shared access, multi-tab synchronization has to be enabled in all tabs. If you are using `experimentalForceOwningTab:true`, make sure that only one tab has persistence enabled at any given time.";class tc{constructor(e,t,n,r,s,i,a,o,u,c,h=15){if(this.allowTabSynchronization=e,this.persistenceKey=t,this.clientId=n,this.Hs=s,this.window=i,this.document=a,this.Js=u,this.Ys=c,this.Xs=h,this.Ss=null,this.Ds=!1,this.isPrimary=!1,this.networkEnabled=!0,this.Zs=null,this.inForeground=!1,this.ti=null,this.ei=null,this.ni=Number.NEGATIVE_INFINITY,this.si=e=>Promise.resolve(),!tc.C())throw new b(I.UNIMPLEMENTED,"This platform is either missing IndexedDB or is known to have an incomplete implementation. Offline persistence has been disabled.");this.referenceDelegate=new Cu(this,r),this.ii=t+"main",this.It=new Co(o),this.ri=new rs(this.ii,this.Xs,new Ju(this.It)),this.Cs=new bu(this.referenceDelegate,this.It),this.remoteDocumentCache=Lu(this.It),this.Ns=new qo,this.window&&this.window.localStorage?this.oi=this.window.localStorage:(this.oi=null,!1===c&&g("IndexedDbPersistence","LocalStorage is unavailable. As a result, persistence may not work reliably. In particular enablePersistence() could fail immediately after refreshing the page."))}start(){return this.ui().then(()=>{if(this.isPrimary||this.allowTabSynchronization)return this.ci(),this.ai(),this.hi(),this.runTransaction("getHighestListenSequenceNumber","readonly",e=>this.Cs.getHighestSequenceNumber(e));throw new b(I.FAILED_PRECONDITION,ec)}).then(e=>{this.Ss=new fs(e,this.Js)}).then(()=>{this.Ds=!0}).catch(e=>(this.ri&&this.ri.close(),Promise.reject(e)))}li(t){return this.si=async e=>{if(this.started)return t(e)},t(this.isPrimary)}setDatabaseDeletedListener(t){this.ri.L(async e=>{null===e.newVersion&&await t()})}setNetworkEnabled(e){this.networkEnabled!==e&&(this.networkEnabled=e,this.Hs.enqueueAndForget(async()=>{this.started&&await this.ui()}))}ui(){return this.runTransaction("updateClientMetadataAndTryBecomePrimary","readwrite",t=>rc(t).put({clientId:this.clientId,updateTimeMs:Date.now(),networkEnabled:this.networkEnabled,inForeground:this.inForeground}).next(()=>{if(this.isPrimary)return this.fi(t).next(e=>{e||(this.isPrimary=!1,this.Hs.enqueueRetryable(()=>this.si(!1)))})}).next(()=>this.di(t)).next(e=>this.isPrimary&&!e?this._i(t).next(()=>!1):!!e&&this.wi(t).next(()=>!0))).catch(e=>{if(as(e))return f("IndexedDbPersistence","Failed to extend owner lease: ",e),this.isPrimary;if(this.allowTabSynchronization)return f("IndexedDbPersistence","Releasing owner lease after error during lease refresh",e),!1;throw e}).then(e=>{this.isPrimary!==e&&this.Hs.enqueueRetryable(()=>this.si(e)),this.isPrimary=e})}fi(e){return nc(e).get("owner").next(e=>A.resolve(this.mi(e)))}gi(e){return rc(e).delete(this.clientId)}async yi(){if(this.isPrimary&&!this.pi(this.ni,18e5)){this.ni=Date.now();var e=await this.runTransaction("maybeGarbageCollectMultiClientState","readwrite-primary",e=>{const r=n(e,"clientMetadata");return r.W().next(e=>{const t=this.Ii(e,18e5),n=e.filter(e=>-1===t.indexOf(e));return A.forEach(n,e=>r.delete(e.clientId)).next(()=>n)})}).catch(()=>[]);if(this.oi)for(const t of e)this.oi.removeItem(this.Ti(t.clientId))}}hi(){this.ei=this.Hs.enqueueAfterDelay("client_metadata_refresh",4e3,()=>this.ui().then(()=>this.yi()).then(()=>this.hi()))}mi(e){return!!e&&e.ownerId===this.clientId}di(t){return this.Ys?A.resolve(!0):nc(t).get("owner").next(e=>{if(null!==e&&this.pi(e.leaseTimestampMs,5e3)&&!this.Ei(e.ownerId)){if(this.mi(e)&&this.networkEnabled)return!0;if(!this.mi(e)){if(e.allowTabSynchronization)return!1;throw new b(I.FAILED_PRECONDITION,ec)}}return!(!this.networkEnabled||!this.inForeground)||rc(t).W().next(e=>void 0===this.Ii(e,5e3).find(e=>{if(this.clientId!==e.clientId){var t=!this.networkEnabled&&e.networkEnabled,n=!this.inForeground&&e.inForeground,e=this.networkEnabled===e.networkEnabled;if(t||n&&e)return!0}return!1}))}).next(e=>(this.isPrimary!==e&&f("IndexedDbPersistence",`Client ${e?"is":"is not"} eligible for a primary lease.`),e))}async shutdown(){this.Ds=!1,this.Ai(),this.ei&&(this.ei.cancel(),this.ei=null),this.Ri(),this.bi(),await this.ri.runTransaction("shutdown","readwrite",["owner","clientMetadata"],e=>{const t=new So(e,fs.at);return this._i(t).next(()=>this.gi(t))}),this.ri.close(),this.Pi()}Ii(e,t){return e.filter(e=>this.pi(e.updateTimeMs,t)&&!this.Ei(e.clientId))}vi(){return this.runTransaction("getActiveClients","readonly",e=>rc(e).W().next(e=>this.Ii(e,18e5).map(e=>e.clientId)))}get started(){return this.Ds}getMutationQueue(e,t){return mu.oe(e,this.It,t,this.referenceDelegate)}getTargetCache(){return this.Cs}getRemoteDocumentCache(){return this.remoteDocumentCache}getIndexManager(e){return new iu(e,this.It.re.databaseId)}getDocumentOverlayCache(e){return jo.oe(this.It,e)}getBundleCache(){return this.Ns}runTransaction(t,n,r){f("IndexedDbPersistence","Starting transaction:",t);var e="readonly"===n?"readonly":"readwrite",s=15===(s=this.Xs)?To:14===s?Eo:13===s?bo:12===s?Io:11===s?wo:void E();let i;return this.ri.runTransaction(t,e,s,e=>(i=new So(e,this.Ss?this.Ss.next():fs.at),"readwrite-primary"===n?this.fi(i).next(e=>!!e||this.di(i)).next(e=>{if(e)return r(i);throw g(`Failed to obtain primary lease for action '${t}'.`),this.isPrimary=!1,this.Hs.enqueueRetryable(()=>this.si(!1)),new b(I.FAILED_PRECONDITION,Zr)}).next(e=>this.wi(i).next(()=>e)):this.Vi(i).next(()=>r(i)))).then(e=>(i.raiseOnCommittedEvent(),e))}Vi(e){return nc(e).get("owner").next(e=>{if(null!==e&&this.pi(e.leaseTimestampMs,5e3)&&!this.Ei(e.ownerId)&&!this.mi(e)&&!(this.Ys||this.allowTabSynchronization&&e.allowTabSynchronization))throw new b(I.FAILED_PRECONDITION,ec)})}wi(e){var t={ownerId:this.clientId,allowTabSynchronization:this.allowTabSynchronization,leaseTimestampMs:Date.now()};return nc(e).put("owner",t)}static C(){return rs.C()}_i(e){const t=nc(e);return t.get("owner").next(e=>this.mi(e)?(f("IndexedDbPersistence","Releasing primary lease."),t.delete("owner")):A.resolve())}pi(e,t){var n=Date.now();return!(e<n-t||n<e&&(g(`Detected an update time that is in the future: ${e} > `+n),1))}ci(){null!==this.document&&"function"==typeof this.document.addEventListener&&(this.ti=()=>{this.Hs.enqueueAndForget(()=>(this.inForeground="visible"===this.document.visibilityState,this.ui()))},this.document.addEventListener("visibilitychange",this.ti),this.inForeground="visible"===this.document.visibilityState)}Ri(){this.ti&&(this.document.removeEventListener("visibilitychange",this.ti),this.ti=null)}ai(){var e;"function"==typeof(null==(e=this.window)?void 0:e.addEventListener)&&(this.Zs=()=>{this.Ai(),!function(){try{return"[object process]"===Object.prototype.toString.call(global.process)}catch(e){return}}()&&navigator.userAgent.includes("Safari")&&!navigator.userAgent.includes("Chrome")&&navigator.appVersion.match(/Version\/1[45]/)&&this.Hs.enterRestrictedMode(!0),this.Hs.enqueueAndForget(()=>this.shutdown())},this.window.addEventListener("pagehide",this.Zs))}bi(){this.Zs&&(this.window.removeEventListener("pagehide",this.Zs),this.Zs=null)}Ei(e){var t;try{var n=null!==(null==(t=this.oi)?void 0:t.getItem(this.Ti(e)));return f("IndexedDbPersistence",`Client '${e}' ${n?"is":"is not"} zombied in LocalStorage`),n}catch(e){return g("IndexedDbPersistence","Failed to get zombied client id.",e),!1}}Ai(){if(this.oi)try{this.oi.setItem(this.Ti(this.clientId),String(Date.now()))}catch(e){g("Failed to set zombie client id.",e)}}Pi(){if(this.oi)try{this.oi.removeItem(this.Ti(this.clientId))}catch(e){}}Ti(e){return`firestore_zombie_${this.persistenceKey}_`+e}}function nc(e){return n(e,"owner")}function rc(e){return n(e,"clientMetadata")}function sc(e,t){let n=e.projectId;return e.isDefaultDatabase||(n+="."+e.database),"firestore/"+t+"/"+n+"/"}class ic{constructor(e,t,n,r){this.targetId=e,this.fromCache=t,this.Si=n,this.Di=r}static Ci(e,t){let n=O(),r=O();for(const e of t.docChanges)switch(e.type){case 0:n=n.add(e.doc.key);break;case 1:r=r.add(e.doc.key)}return new ic(e,t.fromCache,n,r)}}class ac{constructor(){this.xi=!1}initialize(e,t){this.Ni=e,this.indexManager=t,this.xi=!0}getDocumentsMatchingQuery(t,n,r,s){return this.ki(t,n).next(e=>e||this.Oi(t,n,s,r)).next(e=>e||this.Mi(t,n))}ki(s,i){if(bi(i))return A.resolve(null);let t=xi(i);return this.indexManager.getIndexType(s,t).next(e=>0===e?null:(null!==i.limit&&1===e&&(i=Di(i,null,"F"),t=xi(i)),this.indexManager.getDocumentsMatchingTarget(s,t).next(e=>{const r=O(...e);return this.Ni.getDocuments(s,r).next(n=>this.indexManager.getMinOffset(s,t).next(e=>{var t=this.Fi(i,n);return this.$i(i,t,r,e.readTime)?this.ki(s,Di(i,null,"F")):this.Bi(s,t,i,e)}))})))}Oi(t,n,r,s){return bi(n)||s.isEqual(S.min())?this.Mi(t,n):this.Ni.getDocuments(t,r).next(e=>{e=this.Fi(n,e);return this.$i(n,e,r,s)?this.Mi(t,n):(Ar()<=l.DEBUG&&f("QueryEngine","Re-using previous result from %s to execute query: %s",s.toString(),Ni(n)),this.Bi(t,e,n,$r(s,-1)))})}Fi(n,e){let r=new N(Li(n));return e.forEach((e,t)=>{ki(n,t)&&(r=r.add(t))}),r}$i(e,t,n,r){if(null===e.limit)return!1;if(n.size!==t.size)return!0;const s="F"===e.limitType?t.last():t.first();return!!s&&(s.hasPendingWrites||0<s.version.compareTo(r))}Mi(e,t){return Ar()<=l.DEBUG&&f("QueryEngine","Using full collection scan to execute query:",Ni(t)),this.Ni.getDocumentsMatchingQuery(e,t,Xr.min())}Bi(e,n,t,r){return this.Ni.getDocumentsMatchingQuery(e,t,r).next(t=>(n.forEach(e=>{t=t.insert(e.key,e)}),t))}}class oc{constructor(e,t,n,r){this.persistence=e,this.Li=t,this.It=r,this.Ui=new C(T),this.qi=new ha(e=>Zs(e),ei),this.Ki=new Map,this.Gi=e.getRemoteDocumentCache(),this.Cs=e.getTargetCache(),this.Ns=e.getBundleCache(),this.Qi(n)}Qi(e){this.documentOverlayCache=this.persistence.getDocumentOverlayCache(e),this.indexManager=this.persistence.getIndexManager(e),this.mutationQueue=this.persistence.getMutationQueue(e,this.indexManager),this.localDocuments=new qu(this.Gi,this.mutationQueue,this.documentOverlayCache,this.indexManager),this.Gi.setIndexManager(this.indexManager),this.Li.initialize(this.localDocuments,this.indexManager)}collectGarbage(t){return this.persistence.runTransaction("Collect garbage","readwrite-primary",e=>t.collect(e,this.Ui))}}function uc(e,t,n,r){return new oc(e,t,n,r)}async function cc(e,t){const a=e;return a.persistence.runTransaction("Handle user change","readonly",s=>{let i;return a.mutationQueue.getAllMutationBatches(s).next(e=>(i=e,a.Qi(t),a.mutationQueue.getAllMutationBatches(s))).next(e=>{const t=[],n=[];let r=O();for(const s of i){t.push(s.batchId);for(const e of s.mutations)r=r.add(e.key)}for(const s of e){n.push(s.batchId);for(const e of s.mutations)r=r.add(e.key)}return a.localDocuments.getDocuments(s,r).next(e=>({ji:e,removedBatchIds:t,addedBatchIds:n}))})})}function hc(e){const t=e;return t.persistence.runTransaction("Get last remote snapshot version","readonly",e=>t.Cs.getLastRemoteSnapshotVersion(e))}function lc(e,i,t){let n=O(),a=O();return t.forEach(e=>n=n.add(e)),i.getEntries(e,n).next(r=>{let s=la;return t.forEach((e,t)=>{const n=r.get(e);t.isFoundDocument()!==n.isFoundDocument()&&(a=a.add(e)),t.isNoDocument()&&t.version.isEqual(S.min())?(i.removeEntry(e,t.readTime),s=s.insert(e,t)):!n.isValidDocument()||0<t.version.compareTo(n.version)||0===t.version.compareTo(n.version)&&n.hasPendingWrites?(i.addEntry(t),s=s.insert(e,t)):f("LocalStore","Ignoring outdated watch update for ",e,". Current version:",n.version," Watch version:",t.version)}),{Wi:s,zi:a}})}function dc(e,r){const s=e;return s.persistence.runTransaction("Allocate target","readwrite",t=>{let n;return s.Cs.getTargetData(t,r).next(e=>e?(n=e,A.resolve(n)):s.Cs.allocateTargetId(t).next(e=>(n=new Ao(r,e,0,t.currentSequenceNumber),s.Cs.addTargetData(t,n).next(()=>n))))}).then(e=>{var t=s.Ui.get(e.targetId);return(null===t||0<e.snapshotVersion.compareTo(t.snapshotVersion))&&(s.Ui=s.Ui.insert(e.targetId,e),s.qi.set(r,e.targetId)),e})}async function fc(e,t,n){const r=e,s=r.Ui.get(t),i=n?"readwrite":"readwrite-primary";try{n||await r.persistence.runTransaction("Release target",i,e=>r.persistence.referenceDelegate.removeTarget(e,s))}catch(e){if(!as(e))throw e;f("LocalStore",`Failed to update sequence numbers for target ${t}: `+e)}r.Ui=r.Ui.remove(t),r.qi.delete(s.target)}function gc(e,n,r){const s=e;let i=S.min(),a=O();return s.persistence.runTransaction("Execute query","readonly",t=>function(e,t,n){const r=e,s=r.qi.get(n);return void 0!==s?A.resolve(r.Ui.get(s)):r.Cs.getTargetData(t,n)}(s,t,xi(n)).next(e=>{if(e)return i=e.lastLimboFreeSnapshotVersion,s.Cs.getMatchingKeysForTargetId(t,e.targetId).next(e=>{a=e})}).next(()=>s.Li.getDocumentsMatchingQuery(t,n,r?i:S.min(),r?a:O())).next(e=>(yc(s,Ri(n),e),{documents:e,Hi:a})))}function mc(e,t){const n=e,r=n.Cs,s=n.Ui.get(t);return s?Promise.resolve(s.target):n.persistence.runTransaction("Get target data","readonly",e=>r.se(e,t).next(e=>e?e.target:null))}function pc(e,t){const n=e,r=n.Ki.get(t)||S.min();return n.persistence.runTransaction("Get new document changes","readonly",e=>n.Gi.getAllFromCollectionGroup(e,t,$r(r,-1),Number.MAX_SAFE_INTEGER)).then(e=>(yc(n,t,e),e))}function yc(e,t,n){let r=e.Ki.get(t)||S.min();n.forEach((e,t)=>{0<t.readTime.compareTo(r)&&(r=t.readTime)}),e.Ki.set(t,r)}function vc(e,t){return`firestore_clients_${e}_`+t}function wc(e,t,n){let r=`firestore_mutations_${e}_`+n;return t.isAuthenticated()&&(r+="_"+t.uid),r}function Ic(e,t){return`firestore_targets_${e}_`+t}class bc{constructor(e,t,n,r){this.user=e,this.batchId=t,this.state=n,this.error=r}static Zi(e,t,n){var r=JSON.parse(n);let s,i="object"==typeof r&&-1!==["pending","acknowledged","rejected"].indexOf(r.state)&&(void 0===r.error||"object"==typeof r.error);return i&&r.error&&((i="string"==typeof r.error.message&&"string"==typeof r.error.code)&&(s=new b(r.error.code,r.error.message))),i?new bc(e,t,r.state,s):(g("SharedClientState",`Failed to parse mutation state for ID '${t}': `+n),null)}tr(){const e={state:this.state,updateTimeMs:Date.now()};return this.error&&(e.error={code:this.error.code,message:this.error.message}),JSON.stringify(e)}}class Ec{constructor(e,t,n){this.targetId=e,this.state=t,this.error=n}static Zi(e,t){var n=JSON.parse(t);let r,s="object"==typeof n&&-1!==["not-current","current","rejected"].indexOf(n.state)&&(void 0===n.error||"object"==typeof n.error);return s&&n.error&&((s="string"==typeof n.error.message&&"string"==typeof n.error.code)&&(r=new b(n.error.code,n.error.message))),s?new Ec(e,n.state,r):(g("SharedClientState",`Failed to parse target state for ID '${e}': `+t),null)}tr(){const e={state:this.state,updateTimeMs:Date.now()};return this.error&&(e.error={code:this.error.code,message:this.error.message}),JSON.stringify(e)}}class Tc{constructor(e,t){this.clientId=e,this.activeTargetIds=t}static Zi(e,t){var n=JSON.parse(t);let r="object"==typeof n&&n.activeTargetIds instanceof Array,s=va;for(let e=0;r&&e<n.activeTargetIds.length;++e)r=ks(n.activeTargetIds[e]),s=s.add(n.activeTargetIds[e]);return r?new Tc(e,s):(g("SharedClientState",`Failed to parse client data for instance '${e}': `+t),null)}}class Sc{constructor(e,t){this.clientId=e,this.onlineState=t}static Zi(e){var t=JSON.parse(e);return"object"==typeof t&&-1!==["Unknown","Online","Offline"].indexOf(t.onlineState)&&"string"==typeof t.clientId?new Sc(t.clientId,t.onlineState):(g("SharedClientState","Failed to parse online state: "+e),null)}}class _c{constructor(){this.activeTargetIds=va}er(e){this.activeTargetIds=this.activeTargetIds.add(e)}nr(e){this.activeTargetIds=this.activeTargetIds.delete(e)}tr(){var e={activeTargetIds:this.activeTargetIds.toArray(),updateTimeMs:Date.now()};return JSON.stringify(e)}}class xc{constructor(e,t,n,r,s){this.window=e,this.Hs=t,this.persistenceKey=n,this.sr=r,this.syncEngine=null,this.onlineStateHandler=null,this.sequenceNumberHandler=null,this.ir=this.rr.bind(this),this.ur=new C(T),this.started=!1,this.cr=[];e=n.replace(/[.*+?^${}()|[\]\\]/g,"\\$&");this.storage=this.window.localStorage,this.currentUser=s,this.ar=vc(this.persistenceKey,this.sr),this.hr="firestore_sequence_number_"+this.persistenceKey,this.ur=this.ur.insert(this.sr,new _c),this.lr=new RegExp(`^firestore_clients_${e}_([^_]*)$`),this.dr=new RegExp(`^firestore_mutations_${e}_(\\d+)(?:_(.*))?$`),this._r=new RegExp(`^firestore_targets_${e}_(\\d+)$`),this.wr="firestore_online_state_"+this.persistenceKey,this.mr="firestore_bundle_loaded_v2_"+this.persistenceKey,this.window.addEventListener("storage",this.ir)}static C(e){return!(!e||!e.localStorage)}async start(){const e=await this.syncEngine.vi();for(const n of e)if(n!==this.sr){const e=this.getItem(vc(this.persistenceKey,n));var t;e&&(t=Tc.Zi(n,e))&&(this.ur=this.ur.insert(t.clientId,t))}this.gr();const n=this.storage.getItem(this.wr);if(n){const e=this.yr(n);e&&this.pr(e)}for(const e of this.cr)this.rr(e);this.cr=[],this.window.addEventListener("pagehide",()=>this.shutdown()),this.started=!0}writeSequenceNumber(e){this.setItem(this.hr,JSON.stringify(e))}getAllActiveQueryTargets(){return this.Ir(this.ur)}isActiveQueryTarget(n){let r=!1;return this.ur.forEach((e,t)=>{t.activeTargetIds.has(n)&&(r=!0)}),r}addPendingMutation(e){this.Tr(e,"pending")}updateMutationState(e,t,n){this.Tr(e,t,n),this.Er(e)}addLocalQueryTarget(e){let t="not-current";var n;return!this.isActiveQueryTarget(e)||(n=this.storage.getItem(Ic(this.persistenceKey,e)))&&(n=Ec.Zi(e,n))&&(t=n.state),this.Ar.er(e),this.gr(),t}removeLocalQueryTarget(e){this.Ar.nr(e),this.gr()}isLocalQueryTarget(e){return this.Ar.activeTargetIds.has(e)}clearQueryState(e){this.removeItem(Ic(this.persistenceKey,e))}updateQueryState(e,t,n){this.Rr(e,t,n)}handleUserChange(e,t,n){t.forEach(e=>{this.Er(e)}),this.currentUser=e,n.forEach(e=>{this.addPendingMutation(e)})}setOnlineState(e){this.br(e)}notifyBundleLoaded(e){this.Pr(e)}shutdown(){this.started&&(this.window.removeEventListener("storage",this.ir),this.removeItem(this.ar),this.started=!1)}getItem(e){var t=this.storage.getItem(e);return f("SharedClientState","READ",e,t),t}setItem(e,t){f("SharedClientState","SET",e,t),this.storage.setItem(e,t)}removeItem(e){f("SharedClientState","REMOVE",e),this.storage.removeItem(e)}rr(e){const s=e;s.storageArea===this.storage&&(f("SharedClientState","EVENT",s.key,s.newValue),s.key!==this.ar?this.Hs.enqueueRetryable(async()=>{var e;if(this.started){if(null!==s.key){if(this.lr.test(s.key))return null==s.newValue?(e=this.vr(s.key),this.Vr(e,null)):(e=this.Sr(s.key,s.newValue))?this.Vr(e.clientId,e):void 0;if(this.dr.test(s.key)){if(null!==s.newValue){var t=this.Dr(s.key,s.newValue);if(t)return this.Cr(t)}}else if(this._r.test(s.key)){if(null!==s.newValue&&(t=this.Nr(s.key,s.newValue)))return this.kr(t)}else if(s.key===this.wr){if(null!==s.newValue){var n=this.yr(s.newValue);if(n)return this.pr(n)}}else if(s.key===this.hr)(n=function(e){let t=fs.at;if(null!=e)try{var n=JSON.parse(e);y("number"==typeof n),t=n}catch(e){g("SharedClientState","Failed to read sequence number from WebStorage",e)}return t}(s.newValue))!==fs.at&&this.sequenceNumberHandler(n);else if(s.key===this.mr){const r=this.Or(s.newValue);await Promise.all(r.map(e=>this.syncEngine.Mr(e)))}}}else this.cr.push(s)}):g("Received WebStorage notification for local change. Another client might have garbage-collected our state"))}get Ar(){return this.ur.get(this.sr)}gr(){this.setItem(this.ar,this.Ar.tr())}Tr(e,t,n){const r=new bc(this.currentUser,e,t,n),s=wc(this.persistenceKey,this.currentUser,e);this.setItem(s,r.tr())}Er(e){e=wc(this.persistenceKey,this.currentUser,e);this.removeItem(e)}br(e){e={clientId:this.sr,onlineState:e};this.storage.setItem(this.wr,JSON.stringify(e))}Rr(e,t,n){const r=Ic(this.persistenceKey,e),s=new Ec(e,t,n);this.setItem(r,s.tr())}Pr(e){e=JSON.stringify(Array.from(e));this.setItem(this.mr,e)}vr(e){e=this.lr.exec(e);return e?e[1]:null}Sr(e,t){e=this.vr(e);return Tc.Zi(e,t)}Dr(e,t){var e=this.dr.exec(e),n=Number(e[1]),e=void 0!==e[2]?e[2]:null;return bc.Zi(new o(e),n,t)}Nr(e,t){e=this._r.exec(e),e=Number(e[1]);return Ec.Zi(e,t)}yr(e){return Sc.Zi(e)}Or(e){return JSON.parse(e)}async Cr(e){if(e.user.uid===this.currentUser.uid)return this.syncEngine.Fr(e.batchId,e.state,e.error);f("SharedClientState","Ignoring mutation for non-active user "+e.user.uid)}kr(e){return this.syncEngine.$r(e.targetId,e.state,e.error)}Vr(e,t){const n=t?this.ur.insert(e,t):this.ur.remove(e),r=this.Ir(this.ur),s=this.Ir(n),i=[],a=[];return s.forEach(e=>{r.has(e)||i.push(e)}),r.forEach(e=>{s.has(e)||a.push(e)}),this.syncEngine.Br(i,a).then(()=>{this.ur=n})}pr(e){this.ur.get(e.clientId)&&this.onlineStateHandler(e.onlineState)}Ir(e){let n=va;return e.forEach((e,t)=>{n=n.unionWith(t.activeTargetIds)}),n}}class Dc{constructor(){this.Lr=new _c,this.Ur={},this.onlineStateHandler=null,this.sequenceNumberHandler=null}addPendingMutation(e){}updateMutationState(e,t,n){}addLocalQueryTarget(e){return this.Lr.er(e),this.Ur[e]||"not-current"}updateQueryState(e,t,n){this.Ur[e]=t}removeLocalQueryTarget(e){this.Lr.nr(e)}isLocalQueryTarget(e){return this.Lr.activeTargetIds.has(e)}clearQueryState(e){delete this.Ur[e]}getAllActiveQueryTargets(){return this.Lr.activeTargetIds}isActiveQueryTarget(e){return this.Lr.activeTargetIds.has(e)}start(){return this.Lr=new _c,Promise.resolve()}handleUserChange(e,t,n){}setOnlineState(e){}shutdown(){}writeSequenceNumber(e){}notifyBundleLoaded(e){}}class Ac{qr(e){}shutdown(){}}class Cc{constructor(){this.Kr=()=>this.Gr(),this.Qr=()=>this.jr(),this.Wr=[],this.zr()}qr(e){this.Wr.push(e)}shutdown(){window.removeEventListener("online",this.Kr),window.removeEventListener("offline",this.Qr)}zr(){window.addEventListener("online",this.Kr),window.addEventListener("offline",this.Qr)}Gr(){f("ConnectivityMonitor","Network connectivity changed: AVAILABLE");for(const e of this.Wr)e(0)}jr(){f("ConnectivityMonitor","Network connectivity changed: UNAVAILABLE");for(const e of this.Wr)e(1)}static C(){return"undefined"!=typeof window&&void 0!==window.addEventListener&&void 0!==window.removeEventListener}}const Nc={BatchGetDocuments:"batchGet",Commit:"commit",RunQuery:"runQuery",RunAggregationQuery:"runAggregationQuery"};class kc{constructor(e){this.Hr=e.Hr,this.Jr=e.Jr}Yr(e){this.Xr=e}Zr(e){this.eo=e}onMessage(e){this.no=e}close(){this.Jr()}send(e){this.Hr(e)}so(){this.Xr()}io(e){this.eo(e)}ro(e){this.no(e)}}class Rc extends class{constructor(e){this.databaseInfo=e,this.databaseId=e.databaseId;var t=e.ssl?"https":"http";this.oo=t+"://"+e.host,this.uo="projects/"+this.databaseId.projectId+"/databases/"+this.databaseId.database+"/documents"}get co(){return!1}ao(t,e,n,r,s){const i=this.ho(t,e);f("RestConnection","Sending: ",i,n);e={};return this.lo(e,r,s),this.fo(t,i,e,n).then(e=>(f("RestConnection","Received: ",e),e),e=>{throw Cr("RestConnection",t+" failed with error: ",e,"url: ",i,"request:",n),e})}_o(e,t,n,r,s,i){return this.ao(e,t,n,r,s)}lo(n,e,t){n["X-Goog-Api-Client"]="gl-js/ fire/"+xr,n["Content-Type"]="text/plain",this.databaseInfo.appId&&(n["X-Firebase-GMPID"]=this.databaseInfo.appId),e&&e.headers.forEach((e,t)=>n[t]=e),t&&t.headers.forEach((e,t)=>n[t]=e)}ho(e,t){e=Nc[e];return this.oo+`/v1/${t}:`+e}}{constructor(e){super(e),this.forceLongPolling=e.forceLongPolling,this.autoDetectLongPolling=e.autoDetectLongPolling,this.useFetchStreams=e.useFetchStreams}fo(u,t,n,r){return new Promise((i,a)=>{const o=new _r;o.setWithCredentials(!0),o.listenOnce(br.COMPLETE,()=>{var t,n;try{switch(o.getLastErrorCode()){case Ir.NO_ERROR:var e=o.getResponseJson();f("Connection","XHR received:",JSON.stringify(e)),i(e);break;case Ir.TIMEOUT:f("Connection",'RPC "'+u+'" timed out'),a(new b(I.DEADLINE_EXCEEDED,"Request time out"));break;case Ir.HTTP_ERROR:var r=o.getStatus();if(f("Connection",'RPC "'+u+'" failed with status:',r,"response text:",o.getResponseText()),0<r){let e=o.getResponseJson();var s=null==(t=e=Array.isArray(e)?e[0]:e)?void 0:t.error;if(s&&s.status&&s.message){n=s.status.toLowerCase().replace(/_/g,"-");const u=0<=Object.values(I).indexOf(n)?n:I.UNKNOWN;a(new b(u,s.message))}else a(new b(I.UNKNOWN,"Server responded with status "+o.getStatus()))}else a(new b(I.UNAVAILABLE,"Connection failed."));break;default:E()}}finally{f("Connection",'RPC "'+u+'" completed.')}});var e=JSON.stringify(r);o.send(t,"POST",e,n,15)})}wo(e,t,n){const r=[this.oo,"/","google.firestore.v1.Firestore","/",e,"/channel"],s=new fr,i=wr(),a={httpSessionIdParam:"gsessionid",initMessageHeaders:{},messageUrlParams:{database:`projects/${this.databaseId.projectId}/databases/`+this.databaseId.database},sendRawJson:!0,supportsCrossDomainXhr:!0,internalChannelParams:{forwardChannelRequestTimeoutMs:6e5},forceLongPolling:this.forceLongPolling,detectBufferingProxy:this.autoDetectLongPolling};this.useFetchStreams&&(a.xmlHttpFactory=new Tr({})),this.lo(a.initMessageHeaders,t,n),a.encodeInitMessageHeaders=!0;e=r.join("");f("Connection","Creating WebChannel: "+e,a);const o=s.createWebChannel(e,a);let u=!1,c=!1;const h=new kc({Hr:e=>{c?f("Connection","Not sending because WebChannel is closed:",e):(u||(f("Connection","Opening WebChannel transport."),o.open(),u=!0),f("Connection","WebChannel sending:",e),o.send(e))},Jr:()=>o.close()}),l=(e,t,n)=>{e.listen(t,e=>{try{n(e)}catch(e){setTimeout(()=>{throw e},0)}})};return l(o,Sr.EventType.OPEN,()=>{c||f("Connection","WebChannel transport opened.")}),l(o,Sr.EventType.CLOSE,()=>{c||(c=!0,f("Connection","WebChannel transport closed"),h.io())}),l(o,Sr.EventType.ERROR,e=>{c||(c=!0,Cr("Connection","WebChannel transport errored:",e),h.io(new b(I.UNAVAILABLE,"The operation could not be completed")))}),l(o,Sr.EventType.MESSAGE,n=>{if(!c){var n=n.data[0],r=(y(!!n),n.error||(null==(r=n[0])?void 0:r.error));if(r){f("Connection","WebChannel received error:",r);const n=r.status;let e=function(e){e=d[e];if(void 0!==e)return ca(e)}(n),t=r.message;void 0===e&&(e=I.INTERNAL,t="Unknown error status: "+n+" with message "+r.message),c=!0,h.io(new b(e,t)),o.close()}else f("Connection","WebChannel received:",n),h.ro(n)}}),l(i,Er.STAT_EVENT,e=>{10===e.stat?f("Connection","Detected buffering proxy"):11===e.stat&&f("Connection","Detected no buffering proxy")}),setTimeout(()=>{h.so()},0),h}}function Lc(){return"undefined"!=typeof window?window:null}function Mc(){return"undefined"!=typeof document?document:null}function Oc(e){return new Na(e,!0)}class Vc{constructor(e,t,n=1e3,r=1.5,s=6e4){this.Hs=e,this.timerId=t,this.mo=n,this.yo=r,this.po=s,this.Io=0,this.To=null,this.Eo=Date.now(),this.reset()}reset(){this.Io=0}Ao(){this.Io=this.po}Ro(e){this.cancel();var t=Math.floor(this.Io+this.bo()),n=Math.max(0,Date.now()-this.Eo),r=Math.max(0,t-n);0<r&&f("ExponentialBackoff",`Backing off for ${r} ms (base delay: ${this.Io} ms, delay with jitter: ${t} ms, last attempt: ${n} ms ago)`),this.To=this.Hs.enqueueAfterDelay(this.timerId,r,()=>(this.Eo=Date.now(),e())),this.Io*=this.yo,this.Io<this.mo&&(this.Io=this.mo),this.Io>this.po&&(this.Io=this.po)}Po(){null!==this.To&&(this.To.skipDelay(),this.To=null)}cancel(){null!==this.To&&(this.To.cancel(),this.To=null)}bo(){return(Math.random()-.5)*this.Io}}class Fc{constructor(e,t,n,r,s,i,a,o){this.Hs=e,this.vo=n,this.Vo=r,this.connection=s,this.authCredentialsProvider=i,this.appCheckCredentialsProvider=a,this.listener=o,this.state=0,this.So=0,this.Do=null,this.Co=null,this.stream=null,this.xo=new Vc(e,t)}No(){return 1===this.state||5===this.state||this.ko()}ko(){return 2===this.state||3===this.state}start(){4!==this.state?this.auth():this.Oo()}async stop(){this.No()&&await this.close(0)}Mo(){this.state=0,this.xo.reset()}Fo(){this.ko()&&null===this.Do&&(this.Do=this.Hs.enqueueAfterDelay(this.vo,6e4,()=>this.$o()))}Bo(e){this.Lo(),this.stream.send(e)}async $o(){if(this.ko())return this.close(0)}Lo(){this.Do&&(this.Do.cancel(),this.Do=null)}Uo(){this.Co&&(this.Co.cancel(),this.Co=null)}async close(e,t){this.Lo(),this.Uo(),this.xo.cancel(),this.So++,4!==e?this.xo.reset():t&&t.code===I.RESOURCE_EXHAUSTED?(g(t.toString()),g("Using maximum backoff delay to prevent overloading the backend."),this.xo.Ao()):t&&t.code===I.UNAUTHENTICATED&&3!==this.state&&(this.authCredentialsProvider.invalidateToken(),this.appCheckCredentialsProvider.invalidateToken()),null!==this.stream&&(this.qo(),this.stream.close(),this.stream=null),this.state=e,await this.listener.Zr(t)}qo(){}auth(){this.state=1;const e=this.Ko(this.So),n=this.So;Promise.all([this.authCredentialsProvider.getToken(),this.appCheckCredentialsProvider.getToken()]).then(([e,t])=>{this.So===n&&this.Go(e,t)},t=>{e(()=>{var e=new b(I.UNKNOWN,"Fetching auth token failed: "+t.message);return this.Qo(e)})})}Go(e,t){const n=this.Ko(this.So);this.stream=this.jo(e,t),this.stream.Yr(()=>{n(()=>(this.state=2,this.Co=this.Hs.enqueueAfterDelay(this.Vo,1e4,()=>(this.ko()&&(this.state=3),Promise.resolve())),this.listener.Yr()))}),this.stream.Zr(e=>{n(()=>this.Qo(e))}),this.stream.onMessage(e=>{n(()=>this.onMessage(e))})}Oo(){this.state=5,this.xo.Ro(async()=>{this.state=0,this.start()})}Qo(e){return f("PersistentStream","close with error: "+e),this.stream=null,this.close(4,e)}Ko(t){return e=>{this.Hs.enqueueAndForget(()=>this.So===t?e():(f("PersistentStream","stream callback skipped by getCloseGuardedDispatcher."),Promise.resolve()))}}}class Pc extends Fc{constructor(e,t,n,r,s,i){super(e,"listen_stream_connection_backoff","listen_stream_idle","health_check_timeout",t,n,r,i),this.It=s}jo(e,t){return this.connection.wo("Listen",e,t)}onMessage(e){this.xo.reset();var t=function(e,t){let n;if("targetChange"in t){t.targetChange;var r="NO_CHANGE"===(f=t.targetChange.targetChangeType||"NO_CHANGE")?0:"ADD"===f?1:"REMOVE"===f?2:"CURRENT"===f?3:"RESET"===f?4:E(),s=t.targetChange.targetIds||[],i=(f=t.targetChange.resumeToken,e.gt?(y(void 0===f||"string"==typeof f),k.fromBase64String(f||"")):(y(void 0===f||f instanceof Uint8Array),k.fromUint8Array(f||new Uint8Array))),a=t.targetChange.cause,o=a&&(o=void 0===(f=a).code?I.UNKNOWN:ca(f.code),new b(o,f.message||""));n=new Ta(r,s,i,o||null)}else if("documentChange"in t){t.documentChange;(h=t.documentChange).document,h.document.name,h.document.updateTime;var o=Va(e,h.document.name),u=V(h.document.updateTime),c=new Ys({mapValue:{fields:h.document.fields}}),u=L.newFoundDocument(o,u,c),c=h.targetIds||[],h=h.removedTargetIds||[];n=new ba(c,h,u.key,u)}else if("documentDelete"in t)t.documentDelete,(c=t.documentDelete).document,h=Va(e,c.document),u=c.readTime?V(c.readTime):S.min(),u=L.newNoDocument(h,u),c=c.removedTargetIds||[],n=new ba([],c,u.key,u);else if("documentRemove"in t){t.documentRemove;(d=t.documentRemove).document;var l=Va(e,d.document),d=d.removedTargetIds||[];n=new ba([],d,l,null)}else{if(!("filter"in t))return E();{t.filter;const e=t.filter;e.targetId,d=e.count||0,l=new oa(d),d=e.targetId,n=new Ea(d,l)}}var f;return n}(this.It,e),e=function(e){if(!("targetChange"in e))return S.min();e=e.targetChange;return e.targetIds&&e.targetIds.length||!e.readTime?S.min():V(e.readTime)}(e);return this.listener.Wo(t,e)}zo(e){const t={};t.database=Ba(this.It),t.addTarget=function(e,t){let n;var r=t.target;return(n=ti(r)?{documents:Qa(e,r)}:{query:za(e,r)}).targetId=t.targetId,0<t.resumeToken.approximateByteSize()?n.resumeToken=Ra(e,t.resumeToken):0<t.snapshotVersion.compareTo(S.min())&&(n.readTime=ka(e,t.snapshotVersion.toTimestamp())),n}(this.It,e);this.It,n=e;var n,e=null==(e=function(){switch(n.purpose){case 0:return null;case 1:return"existence-filter-mismatch";case 2:return"limbo-document";default:return E()}}())?null:{"goog-listen-tags":e};e&&(t.labels=e),this.Bo(t)}Ho(e){const t={};t.database=Ba(this.It),t.removeTarget=e,this.Bo(t)}}class Bc extends Fc{constructor(e,t,n,r,s,i){super(e,"write_stream_connection_backoff","write_stream_idle","health_check_timeout",t,n,r,i),this.It=s,this.Jo=!1}get Yo(){return this.Jo}start(){this.Jo=!1,this.lastStreamToken=void 0,super.start()}qo(){this.Jo&&this.Xo([])}jo(e,t){return this.connection.wo("Write",e,t)}onMessage(e){var t,n,r;return y(!!e.streamToken),this.lastStreamToken=e.streamToken,this.Jo?(this.xo.reset(),n=e.writeResults,r=e.commitTime,n=n&&0<n.length?(y(void 0!==r),n.map(t=>{{var n=r;let e=t.updateTime?V(t.updateTime):V(n);return e.isEqual(S.min())&&(e=V(n)),new Wi(e,t.transformResults||[])}})):[],t=V(e.commitTime),this.listener.Zo(t,n)):(y(!e.writeResults||0===e.writeResults.length),this.Jo=!0,this.listener.tu())}eu(){const e={};e.database=Ba(this.It),this.Bo(e)}Xo(e){e={streamToken:this.lastStreamToken,writes:e.map(e=>Ga(this.It,e))};this.Bo(e)}}class Uc extends class{}{constructor(e,t,n,r){super(),this.authCredentials=e,this.appCheckCredentials=t,this.connection=n,this.It=r,this.nu=!1}su(){if(this.nu)throw new b(I.FAILED_PRECONDITION,"The client has already been terminated.")}ao(n,r,s){return this.su(),Promise.all([this.authCredentials.getToken(),this.appCheckCredentials.getToken()]).then(([e,t])=>this.connection.ao(n,r,s,e,t)).catch(e=>{throw"FirebaseError"===e.name?(e.code===I.UNAUTHENTICATED&&(this.authCredentials.invalidateToken(),this.appCheckCredentials.invalidateToken()),e):new b(I.UNKNOWN,e.toString())})}_o(n,r,s,i){return this.su(),Promise.all([this.authCredentials.getToken(),this.appCheckCredentials.getToken()]).then(([e,t])=>this.connection._o(n,r,s,e,t,i)).catch(e=>{throw"FirebaseError"===e.name?(e.code===I.UNAUTHENTICATED&&(this.authCredentials.invalidateToken(),this.appCheckCredentials.invalidateToken()),e):new b(I.UNKNOWN,e.toString())})}terminate(){this.nu=!0}}class qc{constructor(e,t){this.asyncQueue=e,this.onlineStateHandler=t,this.state="Unknown",this.iu=0,this.ru=null,this.ou=!0}uu(){0===this.iu&&(this.cu("Unknown"),this.ru=this.asyncQueue.enqueueAfterDelay("online_state_timeout",1e4,()=>(this.ru=null,this.au("Backend didn't respond within 10 seconds."),this.cu("Offline"),Promise.resolve())))}hu(e){"Online"===this.state?this.cu("Unknown"):(this.iu++,1<=this.iu&&(this.lu(),this.au("Connection failed 1 times. Most recent error: "+e.toString()),this.cu("Offline")))}set(e){this.lu(),this.iu=0,"Online"===e&&(this.ou=!1),this.cu(e)}cu(e){e!==this.state&&(this.state=e,this.onlineStateHandler(e))}au(e){e=`Could not reach Cloud Firestore backend. ${e}
This typically indicates that your device does not have a healthy Internet connection at the moment. The client will operate in offline mode until it is able to successfully connect to the backend.`;this.ou?(g(e),this.ou=!1):f("OnlineStateTracker",e)}lu(){null!==this.ru&&(this.ru.cancel(),this.ru=null)}}class Kc{constructor(e,t,n,r,s){this.localStore=e,this.datastore=t,this.asyncQueue=n,this.remoteSyncer={},this.fu=[],this.du=new Map,this._u=new Set,this.wu=[],this.mu=s,this.mu.qr(e=>{n.enqueueAndForget(async()=>{if(Xc(this)){f("RemoteStore","Restarting streams for network reachability change.");{var e;const t=this;t._u.add(4),await jc(t),t.gu.set("Unknown"),t._u.delete(4),await Gc(t)}}})}),this.gu=new qc(n,r)}}async function Gc(e){if(Xc(e))for(const t of e.wu)await t(!0)}async function jc(e){for(const t of e.wu)await t(!1)}function Qc(e,t){const n=e;n.du.has(t.targetId)||(n.du.set(t.targetId,t),Yc(n)?$c(n):ah(n).ko()&&Hc(n,t))}function zc(e,t){const n=e,r=ah(n);n.du.delete(t),r.ko()&&Wc(n,t),0===n.du.size&&(r.ko()?r.Fo():Xc(n)&&n.gu.set("Unknown"))}function Hc(e,t){e.yu.Mt(t.targetId),ah(e).zo(t)}function Wc(e,t){e.yu.Mt(t),ah(e).Ho(t)}function $c(t){t.yu=new _a({getRemoteKeysForTarget:e=>t.remoteSyncer.getRemoteKeysForTarget(e),se:e=>t.du.get(e)||null}),ah(t).start(),t.gu.uu()}function Yc(e){return Xc(e)&&!ah(e).No()&&0<e.du.size}function Xc(e){return 0===e._u.size}function Jc(e){e.yu=void 0}async function Zc(e,t,n){if(!as(t))throw t;e._u.add(1),await jc(e),e.gu.set("Offline"),n=n||(()=>hc(e.localStore)),e.asyncQueue.enqueueRetryable(async()=>{f("RemoteStore","Retrying IndexedDB access"),await n(),e._u.delete(1),await Gc(e)})}function eh(t,n){return n().catch(e=>Zc(t,e,n))}async function th(e){const t=e,n=oh(t);let r=0<t.fu.length?t.fu[t.fu.length-1].batchId:-1;for(;Xc(a=t)&&a.fu.length<10;)try{const e=await function(e,t){const n=e;return n.persistence.runTransaction("Get next mutation batch","readonly",e=>(void 0===t&&(t=-1),n.mutationQueue.getNextMutationBatchAfterBatchId(e,t)))}(t.localStore,r);if(null===e){0===t.fu.length&&n.Fo();break}r=e.batchId;{var s=t;var i=e;s.fu.push(i);const o=oh(s);o.ko()&&o.Yo&&o.Xo(i.mutations)}}catch(e){await Zc(t,e)}var a;nh(t)&&rh(t)}function nh(e){return Xc(e)&&!oh(e).No()&&0<e.fu.length}function rh(e){oh(e).start()}async function sh(e,t){const n=e;n.asyncQueue.verifyOperationInProgress(),f("RemoteStore","RemoteStore received new credentials");e=Xc(n);n._u.add(3),await jc(n),e&&n.gu.set("Unknown"),await n.remoteSyncer.handleCredentialChange(t),n._u.delete(3),await Gc(n)}async function ih(e,t){const n=e;t?(n._u.delete(2),await Gc(n)):(n._u.add(2),await jc(n),n.gu.set("Unknown"))}function ah(t){return t.pu||(t.pu=function(e,t,n){const r=e;return r.su(),new Pc(t,r.connection,r.authCredentials,r.appCheckCredentials,r.It,n)}(t.datastore,t.asyncQueue,{Yr:async function(n){n.du.forEach((e,t)=>{Hc(n,e)})}.bind(null,t),Zr:async function(e,t){Jc(e),Yc(e)?(e.gu.hu(t),$c(e)):e.gu.set("Unknown")}.bind(null,t),Wo:async function(e,t,n){if(e.gu.set("Online"),t instanceof Ta&&2===t.state&&t.cause)try{var r=e,s=t.cause;for(const o of t.targetIds)r.du.has(o)&&(await r.remoteSyncer.rejectListen(o,s),r.du.delete(o),r.yu.removeTarget(o))}catch(n){f("RemoteStore","Failed to remove targets %s: %s ",t.targetIds.join(","),n),await Zc(e,n)}else if(t instanceof ba?e.yu.Gt(t):t instanceof Ea?e.yu.Yt(t):e.yu.Wt(t),!n.isEqual(S.min()))try{const t=await hc(e.localStore);if(0<=n.compareTo(t)){var i=e,a=n;const u=i.yu.te(a);void await(u.targetChanges.forEach((e,t)=>{if(0<e.resumeToken.approximateByteSize()){const n=i.du.get(t);n&&i.du.set(t,n.withResumeToken(e.resumeToken,a))}}),u.targetMismatches.forEach(e=>{const t=i.du.get(e);t&&(i.du.set(e,t.withResumeToken(k.EMPTY_BYTE_STRING,t.snapshotVersion)),Wc(i,e),e=new Ao(t.target,e,1,t.sequenceNumber),Hc(i,e))}),i.remoteSyncer.applyRemoteEvent(u))}}catch(t){f("RemoteStore","Failed to raise snapshot:",t),await Zc(e,t)}}.bind(null,t)}),t.wu.push(async e=>{e?(t.pu.Mo(),Yc(t)?$c(t):t.gu.set("Unknown")):(await t.pu.stop(),Jc(t))})),t.pu}function oh(t){return t.Iu||(t.Iu=function(e,t,n){const r=e;return r.su(),new Bc(t,r.connection,r.authCredentials,r.appCheckCredentials,r.It,n)}(t.datastore,t.asyncQueue,{Yr:async function(e){oh(e).eu()}.bind(null,t),Zr:async function(e,t){if(t&&oh(e).Yo){var n=e,r=t,s;if(ua(s=r.code)&&s!==I.ABORTED){const s=n.fu.shift();oh(n).Mo(),await eh(n,()=>n.remoteSyncer.rejectFailedWrite(s.batchId,r)),await th(n)}await 0}nh(e)&&rh(e)}.bind(null,t),tu:async function(e){const t=oh(e);for(const n of e.fu)t.Xo(n.mutations)}.bind(null,t),Zo:async function(e,t,n){const r=e.fu.shift(),s=xo.from(r,t,n);await eh(e,()=>e.remoteSyncer.applySuccessfulWrite(s)),await th(e)}.bind(null,t)}),t.wu.push(async e=>{e?(t.Iu.Mo(),await th(t)):(await t.Iu.stop(),0<t.fu.length&&(f("RemoteStore",`Stopping write stream with ${t.fu.length} pending writes`),t.fu=[]))})),t.Iu}class uh{constructor(e,t,n,r,s){this.asyncQueue=e,this.timerId=t,this.targetTimeMs=n,this.op=r,this.removalCallback=s,this.deferred=new m,this.then=this.deferred.promise.then.bind(this.deferred.promise),this.deferred.promise.catch(e=>{})}static createAndSchedule(e,t,n,r,s){const i=Date.now()+n,a=new uh(e,t,i,r,s);return a.start(n),a}start(e){this.timerHandle=setTimeout(()=>this.handleDelayElapsed(),e)}skipDelay(){return this.handleDelayElapsed()}cancel(e){null!==this.timerHandle&&(this.clearTimeout(),this.deferred.reject(new b(I.CANCELLED,"Operation cancelled"+(e?": "+e:""))))}handleDelayElapsed(){this.asyncQueue.enqueueAndForget(()=>null!==this.timerHandle?(this.clearTimeout(),this.op().then(e=>this.deferred.resolve(e))):Promise.resolve())}clearTimeout(){null!==this.timerHandle&&(this.removalCallback(this),clearTimeout(this.timerHandle),this.timerHandle=null)}}function ch(e,t){if(g("AsyncQueue",t+": "+e),as(e))return new b(I.UNAVAILABLE,t+": "+e);throw e}class hh{constructor(n){this.comparator=n?(e,t)=>n(e,t)||D.comparator(e.key,t.key):(e,t)=>D.comparator(e.key,t.key),this.keyedMap=fa(),this.sortedSet=new C(this.comparator)}static emptySet(e){return new hh(e.comparator)}has(e){return null!=this.keyedMap.get(e)}get(e){return this.keyedMap.get(e)}first(){return this.sortedSet.minKey()}last(){return this.sortedSet.maxKey()}isEmpty(){return this.sortedSet.isEmpty()}indexOf(e){e=this.keyedMap.get(e);return e?this.sortedSet.indexOf(e):-1}get size(){return this.sortedSet.size}forEach(n){this.sortedSet.inorderTraversal((e,t)=>(n(e),!1))}add(e){const t=this.delete(e.key);return t.copy(t.keyedMap.insert(e.key,e),t.sortedSet.insert(e,null))}delete(e){var t=this.get(e);return t?this.copy(this.keyedMap.remove(e),this.sortedSet.remove(t)):this}isEqual(e){if(!(e instanceof hh))return!1;if(this.size!==e.size)return!1;const t=this.sortedSet.getIterator(),n=e.sortedSet.getIterator();for(;t.hasNext();){const e=t.getNext().key,r=n.getNext().key;if(!e.isEqual(r))return!1}return!0}toString(){const t=[];return this.forEach(e=>{t.push(e.toString())}),0===t.length?"DocumentSet ()":"DocumentSet (\n  "+t.join("  \n")+"\n)"}copy(e,t){const n=new hh;return n.comparator=this.comparator,n.keyedMap=e,n.sortedSet=t,n}}class lh{constructor(){this.Tu=new C(D.comparator)}track(e){var t=e.doc.key,n=this.Tu.get(t);!n||0!==e.type&&3===n.type?this.Tu=this.Tu.insert(t,e):3===e.type&&1!==n.type?this.Tu=this.Tu.insert(t,{type:n.type,doc:e.doc}):2===e.type&&2===n.type?this.Tu=this.Tu.insert(t,{type:2,doc:e.doc}):2===e.type&&0===n.type?this.Tu=this.Tu.insert(t,{type:0,doc:e.doc}):1===e.type&&0===n.type?this.Tu=this.Tu.remove(t):1===e.type&&2===n.type?this.Tu=this.Tu.insert(t,{type:1,doc:n.doc}):0===e.type&&1===n.type?this.Tu=this.Tu.insert(t,{type:2,doc:e.doc}):E()}Eu(){const n=[];return this.Tu.inorderTraversal((e,t)=>{n.push(t)}),n}}class dh{constructor(e,t,n,r,s,i,a,o,u){this.query=e,this.docs=t,this.oldDocs=n,this.docChanges=r,this.mutatedKeys=s,this.fromCache=i,this.syncStateChanged=a,this.excludesMetadataChanges=o,this.hasCachedResults=u}static fromInitialDocuments(e,t,n,r,s){const i=[];return t.forEach(e=>{i.push({type:0,doc:e})}),new dh(e,t,hh.emptySet(t),i,n,r,!0,!1,s)}get hasPendingWrites(){return!this.mutatedKeys.isEmpty()}isEqual(e){if(!(this.fromCache===e.fromCache&&this.hasCachedResults===e.hasCachedResults&&this.syncStateChanged===e.syncStateChanged&&this.mutatedKeys.isEqual(e.mutatedKeys)&&Ai(this.query,e.query)&&this.docs.isEqual(e.docs)&&this.oldDocs.isEqual(e.oldDocs)))return!1;const t=this.docChanges,n=e.docChanges;if(t.length!==n.length)return!1;for(let e=0;e<t.length;e++)if(t[e].type!==n[e].type||!t[e].doc.isEqual(n[e].doc))return!1;return!0}}class fh{constructor(){this.Au=void 0,this.listeners=[]}}class gh{constructor(){this.queries=new ha(e=>Ci(e),Ai),this.onlineState="Unknown",this.Ru=new Set}}async function mh(e,t){const n=e,r=t.query;let s=!1,i=n.queries.get(r);if(i||(s=!0,i=new fh),s)try{i.Au=await n.onListen(r)}catch(e){const n=ch(e,`Initialization of query '${Ni(t.query)}' failed`);return void t.onError(n)}n.queries.set(r,i),i.listeners.push(t),t.bu(n.onlineState),i.Au&&t.Pu(i.Au)&&yh(n)}async function ph(e,t){const n=e,r=t.query;let s=!1;const i=n.queries.get(r);if(i){const e=i.listeners.indexOf(t);0<=e&&(i.listeners.splice(e,1),s=0===i.listeners.length)}if(s)return n.queries.delete(r),n.onUnlisten(r)}function yh(e){e.Ru.forEach(e=>{e.next()})}class vh{constructor(e,t,n){this.query=e,this.vu=t,this.Vu=!1,this.Su=null,this.onlineState="Unknown",this.options=n||{}}Pu(e){if(!this.options.includeMetadataChanges){const t=[];for(const n of e.docChanges)3!==n.type&&t.push(n);e=new dh(e.query,e.docs,e.oldDocs,t,e.mutatedKeys,e.fromCache,e.syncStateChanged,!0,e.hasCachedResults)}let t=!1;return this.Vu?this.Du(e)&&(this.vu.next(e),t=!0):this.Cu(e,this.onlineState)&&(this.xu(e),t=!0),this.Su=e,t}onError(e){this.vu.error(e)}bu(e){this.onlineState=e;let t=!1;return this.Su&&!this.Vu&&this.Cu(this.Su,e)&&(this.xu(this.Su),t=!0),t}Cu(e,t){return!e.fromCache||(!this.options.Nu||!("Offline"!==t))&&(!e.docs.isEmpty()||e.hasCachedResults||"Offline"===t)}Du(e){if(0<e.docChanges.length)return!0;var t=this.Su&&this.Su.hasPendingWrites!==e.hasPendingWrites;return!(!e.syncStateChanged&&!t)&&!0===this.options.includeMetadataChanges}xu(e){e=dh.fromInitialDocuments(e.query,e.docs,e.mutatedKeys,e.fromCache,e.hasCachedResults),this.Vu=!0,this.vu.next(e)}}class wh{constructor(e,t){this.ku=e,this.byteLength=t}Ou(){return"metadata"in this.ku}}class Ih{constructor(e){this.It=e}Ji(e){return Va(this.It,e)}Yi(e){return e.metadata.exists?Ka(this.It,e.document,!1):L.newNoDocument(this.Ji(e.metadata.name),this.Xi(e.metadata.readTime))}Xi(e){return V(e)}}class bh{constructor(e,t,n){this.Mu=e,this.localStore=t,this.It=n,this.queries=[],this.documents=[],this.collectionGroups=new Set,this.progress=Eh(e)}Fu(e){this.progress.bytesLoaded+=e.byteLength;let t=this.progress.documentsLoaded;if(e.ku.namedQuery)this.queries.push(e.ku.namedQuery);else if(e.ku.documentMetadata){this.documents.push({metadata:e.ku.documentMetadata}),e.ku.documentMetadata.exists||++t;const n=_.fromString(e.ku.documentMetadata.name);this.collectionGroups.add(n.get(n.length-2))}else e.ku.document&&(this.documents[this.documents.length-1].document=e.ku.document,++t);return t!==this.progress.documentsLoaded?(this.progress.documentsLoaded=t,Object.assign({},this.progress)):null}$u(e){const t=new Map,n=new Ih(this.It);for(const s of e)if(s.metadata.queries){const e=n.Ji(s.metadata.name);for(const n of s.metadata.queries){var r=(t.get(n)||O()).add(e);t.set(n,r)}}return t}async complete(){const e=await async function(e,t,n,r){const s=e;let i=O(),a=la;for(const e of n){const n=t.Ji(e.metadata.name),c=(e.document&&(i=i.add(n)),t.Yi(e));c.setReadTime(t.Xi(e.metadata.readTime)),a=a.insert(n,c)}const o=s.Gi.newChangeBuffer({trackRemovals:!0}),u=await dc(s,xi(Ii(_.fromString("__bundle__/docs/"+r))));return s.persistence.runTransaction("Apply bundle documents","readwrite",t=>lc(t,o,a).next(e=>(o.apply(t),e)).next(e=>s.Cs.removeMatchingKeysForTargetId(t,u.targetId).next(()=>s.Cs.addMatchingKeys(t,i,u.targetId)).next(()=>s.localDocuments.getLocalViewOfDocuments(t,e.Wi,e.zi)).next(()=>e.Wi)))}(this.localStore,new Ih(this.It),this.documents,this.Mu.id),t=this.$u(this.documents);for(const e of this.queries)await async function(e,n,r=O()){const s=await dc(e,xi(Fo(n.bundledQuery))),i=e;return i.persistence.runTransaction("Save named query","readwrite",e=>{var t=V(n.readTime);return 0<=s.snapshotVersion.compareTo(t)?i.Ns.saveNamedQuery(e,n):(t=s.withResumeToken(k.EMPTY_BYTE_STRING,t),i.Ui=i.Ui.insert(t.targetId,t),i.Cs.updateTargetData(e,t).next(()=>i.Cs.removeMatchingKeysForTargetId(e,s.targetId)).next(()=>i.Cs.addMatchingKeys(e,r,s.targetId)).next(()=>i.Ns.saveNamedQuery(e,n)))})}(this.localStore,e,t.get(e.name));return this.progress.taskState="Success",{progress:this.progress,Bu:this.collectionGroups,Lu:e}}}function Eh(e){return{taskState:"Running",documentsLoaded:0,bytesLoaded:0,totalDocuments:e.totalDocuments,totalBytes:e.totalBytes}}class Th{constructor(e){this.key=e}}class Sh{constructor(e){this.key=e}}class _h{constructor(e,t){this.query=e,this.Uu=t,this.qu=null,this.hasCachedResults=!1,this.current=!1,this.Ku=O(),this.mutatedKeys=O(),this.Gu=Li(e),this.Qu=new hh(this.Gu)}get ju(){return this.Uu}Wu(e,t){const o=t?t.zu:new lh,u=(t||this).Qu;let c=(t||this).mutatedKeys,h=u,l=!1;const d="F"===this.query.limitType&&u.size===this.query.limit?u.last():null,f="L"===this.query.limitType&&u.size===this.query.limit?u.first():null;if(e.inorderTraversal((e,t)=>{const n=u.get(e),r=ki(this.query,t)?t:null,s=!!n&&this.mutatedKeys.has(n.key),i=!!r&&(r.hasLocalMutations||this.mutatedKeys.has(r.key)&&r.hasCommittedMutations);let a=!1;n&&r?n.data.isEqual(r.data)?s!==i&&(o.track({type:3,doc:r}),a=!0):this.Hu(n,r)||(o.track({type:2,doc:r}),a=!0,(d&&0<this.Gu(r,d)||f&&this.Gu(r,f)<0)&&(l=!0)):!n&&r?(o.track({type:0,doc:r}),a=!0):n&&!r&&(o.track({type:1,doc:n}),a=!0,(d||f)&&(l=!0)),a&&(c=r?(h=h.add(r),i?c.add(e):c.delete(e)):(h=h.delete(e),c.delete(e)))}),null!==this.query.limit)for(;h.size>this.query.limit;){const e="F"===this.query.limitType?h.last():h.first();h=h.delete(e.key),c=c.delete(e.key),o.track({type:1,doc:e})}return{Qu:h,zu:o,$i:l,mutatedKeys:c}}Hu(e,t){return e.hasLocalMutations&&t.hasCommittedMutations&&!t.hasLocalMutations}applyChanges(e,t,n){var r=this.Qu;this.Qu=e.Qu,this.mutatedKeys=e.mutatedKeys;const s=e.zu.Eu();s.sort((e,t)=>function(e,t){var n=e=>{switch(e){case 0:return 1;case 2:case 3:return 2;case 1:return 0;default:return E()}};return n(e)-n(t)}(e.type,t.type)||this.Gu(e.doc,t.doc)),this.Ju(n);var t=t?this.Yu():[],i=0===this.Ku.size&&this.current?1:0,a=i!==this.qu;return this.qu=i,0!==s.length||a?{snapshot:new dh(this.query,e.Qu,r,s,e.mutatedKeys,0==i,a,!1,!!n&&0<n.resumeToken.approximateByteSize()),Xu:t}:{Xu:t}}bu(e){return this.current&&"Offline"===e?(this.current=!1,this.applyChanges({Qu:this.Qu,zu:new lh,mutatedKeys:this.mutatedKeys,$i:!1},!1)):{Xu:[]}}Zu(e){return!this.Uu.has(e)&&!!this.Qu.has(e)&&!this.Qu.get(e).hasLocalMutations}Ju(e){e&&(e.addedDocuments.forEach(e=>this.Uu=this.Uu.add(e)),e.modifiedDocuments.forEach(e=>{}),e.removedDocuments.forEach(e=>this.Uu=this.Uu.delete(e)),this.current=e.current)}Yu(){if(!this.current)return[];const t=this.Ku,n=(this.Ku=O(),this.Qu.forEach(e=>{this.Zu(e.key)&&(this.Ku=this.Ku.add(e.key))}),[]);return t.forEach(e=>{this.Ku.has(e)||n.push(new Sh(e))}),this.Ku.forEach(e=>{t.has(e)||n.push(new Th(e))}),n}tc(e){this.Uu=e.Hi,this.Ku=O();e=this.Wu(e.documents);return this.applyChanges(e,!0)}ec(){return dh.fromInitialDocuments(this.query,this.Qu,this.mutatedKeys,0===this.qu,this.hasCachedResults)}}class xh{constructor(e,t,n){this.query=e,this.targetId=t,this.view=n}}class Dh{constructor(e){this.key=e,this.nc=!1}}class Ah{constructor(e,t,n,r,s,i){this.localStore=e,this.remoteStore=t,this.eventManager=n,this.sharedClientState=r,this.currentUser=s,this.maxConcurrentLimboResolutions=i,this.sc={},this.ic=new ha(e=>Ci(e),Ai),this.rc=new Map,this.oc=new Set,this.uc=new C(D.comparator),this.cc=new Map,this.ac=new ju,this.hc={},this.lc=new Map,this.fc=Iu.vn(),this.onlineState="Unknown",this.dc=void 0}get isPrimaryClient(){return!0===this.dc}}async function Ch(n,e,t,r,s){n._c=(e,s,t)=>async function(e,t,n){let r=t.view.Wu(s);r.$i&&(r=await gc(e.localStore,t.query,!1).then(({documents:e})=>t.view.Wu(e,r)));n=n&&n.targetChanges.get(t.targetId),n=t.view.applyChanges(r,e.isPrimaryClient,n);return Vh(e,t.targetId,n.Xu),n.snapshot}(n,e,t);const i=await gc(n.localStore,e,!0),a=new _h(e,i.Hi),o=a.Wu(i.documents),u=Ia.createSynthesizedTargetChangeForCurrentChange(t,r&&"Offline"!==n.onlineState,s),c=a.applyChanges(o,n.isPrimaryClient,u);Vh(n,t,c.Xu);r=new xh(e,t,a);return n.ic.set(e,r),n.rc.has(t)?n.rc.get(t).push(e):n.rc.set(t,[e]),c.snapshot}async function Nh(e,t){const r=e;try{const e=await function(e,c){const h=e,l=c.snapshotVersion;let d=h.Ui;return h.persistence.runTransaction("Apply remote event","readwrite-primary",o=>{const e=h.Gi.newChangeBuffer({trackRemovals:!0}),u=(d=h.Ui,[]);c.targetChanges.forEach((t,n)=>{const r=d.get(n);if(r){u.push(h.Cs.removeMatchingKeys(o,t.removedDocuments,n).next(()=>h.Cs.addMatchingKeys(o,t.addedDocuments,n)));let e=r.withSequenceNumber(o.currentSequenceNumber);var s,i,a;c.targetMismatches.has(n)?e=e.withResumeToken(k.EMPTY_BYTE_STRING,S.min()).withLastLimboFreeSnapshotVersion(S.min()):0<t.resumeToken.approximateByteSize()&&(e=e.withResumeToken(t.resumeToken,l)),d=d.insert(n,e),s=r,i=e,a=t,0!==s.resumeToken.approximateByteSize()&&!(3e8<=i.snapshotVersion.toMicroseconds()-s.snapshotVersion.toMicroseconds()||0<a.addedDocuments.size+a.modifiedDocuments.size+a.removedDocuments.size)||u.push(h.Cs.updateTargetData(o,e))}});let t=la,n=O();if(c.documentUpdates.forEach(e=>{c.resolvedLimboDocuments.has(e)&&u.push(h.persistence.referenceDelegate.updateLimboDocument(o,e))}),u.push(lc(o,e,c.documentUpdates).next(e=>{t=e.Wi,n=e.zi})),!l.isEqual(S.min())){const c=h.Cs.getLastRemoteSnapshotVersion(o).next(e=>h.Cs.setTargetsMetadata(o,o.currentSequenceNumber,l));u.push(c)}return A.waitFor(u).next(()=>e.apply(o)).next(()=>h.localDocuments.getLocalViewOfDocuments(o,t,n)).next(()=>t)}).then(e=>(h.Ui=d,e))}(r.localStore,t);t.targetChanges.forEach((e,t)=>{const n=r.cc.get(t);n&&(y(e.addedDocuments.size+e.modifiedDocuments.size+e.removedDocuments.size<=1),0<e.addedDocuments.size?n.nc=!0:0<e.modifiedDocuments.size?y(n.nc):0<e.removedDocuments.size&&(y(n.nc),n.nc=!1))}),await Ph(r,e,t)}catch(e){await ts(e)}}function kh(n,r,e){const t=n;if(t.isPrimaryClient&&0===e||!t.isPrimaryClient&&1===e){const n=[];t.ic.forEach((e,t)=>{t=t.view.bu(r);t.snapshot&&n.push(t.snapshot)});{e=t.eventManager;var s=r;const i=e;i.onlineState=s;let n=!1;i.queries.forEach((e,t)=>{for(const e of t.listeners)e.bu(s)&&(n=!0)}),n&&yh(i)}n.length&&t.sc.Wo(n),t.onlineState=r,t.isPrimaryClient&&t.sharedClientState.setOnlineState(r)}}function Rh(e,t){(e.lc.get(t)||[]).forEach(e=>{e.resolve()}),e.lc.delete(t)}function Lh(e,t,n){const r=e;let s=r.hc[r.currentUser.toKey()];if(s){const e=s.get(t);e&&(n?e.reject(n):e.resolve(),s=s.remove(t)),r.hc[r.currentUser.toKey()]=s}}function Mh(t,e,n=null){t.sharedClientState.removeLocalQueryTarget(e);for(const r of t.rc.get(e))t.ic.delete(r),n&&t.sc.wc(r,n);t.rc.delete(e),t.isPrimaryClient&&t.ac.ls(e).forEach(e=>{t.ac.containsKey(e)||Oh(t,e)})}function Oh(e,t){e.oc.delete(t.path.canonicalString());var n=e.uc.get(t);null!==n&&(zc(e.remoteStore,n),e.uc=e.uc.remove(t),e.cc.delete(n),Fh(e))}function Vh(e,t,n){for(const s of n)if(s instanceof Th){e.ac.addReference(s.key,t);{var r=e;const i=s.key,a=i.path.canonicalString();r.uc.get(i)||r.oc.has(a)||(f("SyncEngine","New document in limbo: "+i),r.oc.add(a),Fh(r))}}else s instanceof Sh?(f("SyncEngine","Document no longer in limbo: "+s.key),e.ac.removeReference(s.key,t),e.ac.containsKey(s.key)||Oh(e,s.key)):E()}function Fh(e){for(;0<e.oc.size&&e.uc.size<e.maxConcurrentLimboResolutions;){var t=e.oc.values().next().value,n=(e.oc.delete(t),new D(_.fromString(t))),t=e.fc.next();e.cc.set(t,new Dh(n)),e.uc=e.uc.insert(n,t),Qc(e.remoteStore,new Ao(xi(Ii(n.path)),t,2,fs.at))}}async function Ph(e,n,r){const s=e,i=[],a=[],o=[];if(!s.ic.isEmpty()){s.ic.forEach((e,t)=>{o.push(s._c(t,n,r).then(e=>{(e||r)&&s.isPrimaryClient&&s.sharedClientState.updateQueryState(t.targetId,null!=e&&e.fromCache?"not-current":"current"),e&&(i.push(e),e=ic.Ci(t.targetId,e),a.push(e))}))}),await Promise.all(o),s.sc.Wo(i);{var t=s.localStore,u=a;const c=t;try{await c.persistence.runTransaction("notifyLocalViewChanges","readwrite",n=>A.forEach(u,t=>A.forEach(t.Si,e=>c.persistence.referenceDelegate.addReference(n,t.targetId,e)).next(()=>A.forEach(t.Di,e=>c.persistence.referenceDelegate.removeReference(n,t.targetId,e)))))}catch(t){if(!as(t))throw t;f("LocalStore","Failed to update sequence numbers: "+t)}for(const t of u){const u=t.targetId;if(!t.fromCache){const t=c.Ui.get(u),h=t.snapshotVersion,l=t.withLastLimboFreeSnapshotVersion(h);c.Ui=c.Ui.insert(u,l)}}}}}async function Bh(t,n){const r=t,s=[],i=[];for(const t of n){let e;var a=r.rc.get(t);if(a&&0!==a.length){e=await dc(r.localStore,xi(a[0]));for(const t of a){const n=r.ic.get(t),h=(o=n,0,c=await gc((u=r).localStore,o.query,!0),c=o.view.tc(c),u.isPrimaryClient&&Vh(u,o.targetId,c.Xu),await c);h.snapshot&&i.push(h.snapshot)}}else{a=await mc(r.localStore,t);e=await dc(r.localStore,a),await Ch(r,Uh(a),t,!1,e.resumeToken)}s.push(e)}var o,u,c;return r.sc.Wo(i),s}function Uh(e){return wi(e.path,e.collectionGroup,e.orderBy,e.filters,e.limit,"F",e.startAt,e.endAt)}function qh(e){const t=e;return t.remoteStore.remoteSyncer.applyRemoteEvent=Nh.bind(null,t),t.remoteStore.remoteSyncer.getRemoteKeysForTarget=function(e,t){const n=e,r=n.cc.get(t);if(r&&r.nc)return O().add(r.key);{let e=O();const r=n.rc.get(t);if(!r)return e;for(const t of r){const r=n.ic.get(t);e=e.unionWith(r.view.ju)}return e}}.bind(null,t),t.remoteStore.remoteSyncer.rejectListen=async function(e,t,n){const r=e,s=(r.sharedClientState.updateQueryState(t,"rejected",n),r.cc.get(t)),i=s&&s.key;if(i){let e=new C(D.comparator);e=e.insert(i,L.newNoDocument(i,S.min()));const n=O().add(i),s=new wa(S.min(),new Map,new N(T),e,n);await Nh(r,s),r.uc=r.uc.remove(i),r.cc.delete(t),Fh(r)}else await fc(r.localStore,t,!1).then(()=>Mh(r,t,n)).catch(ts)}.bind(null,t),t.sc.Wo=function(e,t){const n=e;let r=!1;for(const e of t){const t=e.query,s=n.queries.get(t);if(s){for(const t of s.listeners)t.Pu(e)&&(r=!0);s.Au=e}}r&&yh(n)}.bind(null,t.eventManager),t.sc.wc=function(e,t,n){const r=e,s=r.queries.get(t);if(s)for(const e of s.listeners)e.onError(n);r.queries.delete(t)}.bind(null,t.eventManager),t}function Kh(e){const t=e;return t.remoteStore.remoteSyncer.applySuccessfulWrite=async function(e,t){const n=e,r=t.batch.batchId;try{const e=await function(e,r){const s=e;return s.persistence.runTransaction("Acknowledge batch","readwrite-primary",e=>{const t=r.batch.keys(),n=s.Gi.newChangeBuffer({trackRemovals:!0});return function(e,t,r,s){const i=r.batch,n=i.keys();let a=A.resolve();return n.forEach(n=>{a=a.next(()=>s.getEntry(t,n)).next(e=>{var t=r.docVersions.get(n);y(null!==t),e.version.compareTo(t)<0&&(i.applyToRemoteDocument(e,r),e.isValidDocument()&&(e.setReadTime(r.commitVersion),s.addEntry(e)))})}),a.next(()=>e.mutationQueue.removeMutationBatch(t,i))}(s,e,r,n).next(()=>n.apply(e)).next(()=>s.mutationQueue.performConsistencyCheck(e)).next(()=>s.documentOverlayCache.removeOverlaysForBatchId(e,t,r.batch.batchId)).next(()=>s.localDocuments.recalculateAndSaveOverlaysForDocumentKeys(e,function(t){let n=O();for(let e=0;e<t.mutationResults.length;++e)0<t.mutationResults[e].transformResults.length&&(n=n.add(t.batch.mutations[e].key));return n}(r))).next(()=>s.localDocuments.getDocuments(e,t))})}(n.localStore,t);Lh(n,r,null),Rh(n,r),n.sharedClientState.updateMutationState(r,"acknowledged"),await Ph(n,e)}catch(e){await ts(e)}}.bind(null,t),t.remoteStore.remoteSyncer.rejectFailedWrite=async function(e,t,n){const r=e;try{const e=await function(e,r){const s=e;return s.persistence.runTransaction("Reject batch","readwrite-primary",t=>{let n;return s.mutationQueue.lookupMutationBatch(t,r).next(e=>(y(null!==e),n=e.keys(),s.mutationQueue.removeMutationBatch(t,e))).next(()=>s.mutationQueue.performConsistencyCheck(t)).next(()=>s.documentOverlayCache.removeOverlaysForBatchId(t,n,r)).next(()=>s.localDocuments.recalculateAndSaveOverlaysForDocumentKeys(t,n)).next(()=>s.localDocuments.getDocuments(t,n))})}(r.localStore,t);Lh(r,t,n),Rh(r,t),r.sharedClientState.updateMutationState(t,"rejected",n),await Ph(r,e)}catch(n){await ts(n)}}.bind(null,t),t}class Gh{constructor(){this.synchronizeTabs=!1}async initialize(e){this.It=Oc(e.databaseInfo.databaseId),this.sharedClientState=this.gc(e),this.persistence=this.yc(e),await this.persistence.start(),this.localStore=this.Ic(e),this.gcScheduler=this.Tc(e,this.localStore),this.indexBackfillerScheduler=this.Ec(e,this.localStore)}Tc(e,t){return null}Ec(e,t){return null}Ic(e){return uc(this.persistence,new ac,e.initialUser,this.It)}yc(e){return new $u(Xu.Bs,this.It)}gc(e){return new Dc}async terminate(){this.gcScheduler&&this.gcScheduler.stop(),await this.sharedClientState.shutdown(),await this.persistence.shutdown()}}class jh extends Gh{constructor(e,t,n){super(),this.Ac=e,this.cacheSizeBytes=t,this.forceOwnership=n,this.synchronizeTabs=!1}async initialize(e){await super.initialize(e),await this.Ac.initialize(this,e),await Kh(this.Ac.syncEngine),await th(this.Ac.remoteStore),await this.persistence.li(()=>(this.gcScheduler&&!this.gcScheduler.started&&this.gcScheduler.start(),this.indexBackfillerScheduler&&!this.indexBackfillerScheduler.started&&this.indexBackfillerScheduler.start(),Promise.resolve()))}Ic(e){return uc(this.persistence,new ac,e.initialUser,this.It)}Tc(e,t){var n=this.persistence.referenceDelegate.garbageCollector;return new Du(n,e.asyncQueue,t)}Ec(e,t){t=new ds(t,this.persistence);return new ls(e.asyncQueue,t)}yc(e){var t=sc(e.databaseInfo.databaseId,e.databaseInfo.persistenceKey),n=void 0!==this.cacheSizeBytes?du.withCacheSize(this.cacheSizeBytes):du.DEFAULT;return new tc(this.synchronizeTabs,t,e.clientId,n,e.asyncQueue,Lc(),Mc(),this.It,this.sharedClientState,!!this.forceOwnership)}gc(e){return new Dc}}class Qh extends jh{constructor(e,t){super(e,t,!1),this.Ac=e,this.cacheSizeBytes=t,this.synchronizeTabs=!0}async initialize(e){await super.initialize(e);e=this.Ac.syncEngine;this.sharedClientState instanceof xc&&(this.sharedClientState.syncEngine={Fr:async function(e,t,n,r){var s=await function(e,n){const r=e,s=r.mutationQueue;return r.persistence.runTransaction("Lookup mutation documents","readonly",t=>s.Tn(t,n).next(e=>e?r.localDocuments.getDocuments(t,e):A.resolve(null)))}(e.localStore,t);null!==s?("pending"===n?await th(e.remoteStore):"acknowledged"===n||"rejected"===n?(Lh(e,t,r||null),Rh(e,t),e.localStore.mutationQueue.An(t)):E(),await Ph(e,s)):f("SyncEngine","Cannot apply mutation batch with id: "+t)}.bind(null,e),$r:async function(e,t,n,r){const s=e;if(s.dc)f("SyncEngine","Ignoring unexpected query state notification.");else{var i=s.rc.get(t);if(i&&0<i.length)switch(n){case"current":case"not-current":{const e=await pc(s.localStore,Ri(i[0])),r=wa.createSynthesizedRemoteEventForCurrentChange(t,"current"===n,k.EMPTY_BYTE_STRING);await Ph(s,e,r);break}case"rejected":await fc(s.localStore,t,!0),Mh(s,t,r);break;default:E()}}}.bind(null,e),Br:async function(e,t,n){const r=qh(e);if(r.dc){for(const e of t)if(r.rc.has(e))f("SyncEngine","Adding an already active target "+e);else{const t=await mc(r.localStore,e),n=await dc(r.localStore,t);await Ch(r,Uh(t),n.targetId,!1,n.resumeToken),Qc(r.remoteStore,n)}for(const e of n)r.rc.has(e)&&await fc(r.localStore,e,!1).then(()=>{zc(r.remoteStore,e),Mh(r,e)}).catch(ts)}}.bind(null,e),vi:function(e){return e.localStore.persistence.vi()}.bind(null,e),Mr:async function(e,t){const n=e;return pc(n.localStore,t).then(e=>Ph(n,e))}.bind(null,e)},await this.sharedClientState.start()),await this.persistence.li(async e=>{{var r=this.Ac.syncEngine,t=e;const s=r;if(qh(s),Kh(s),!0===t&&!0!==s.dc){const r=s.sharedClientState.getAllActiveQueryTargets(),t=await Bh(s,r.toArray());s.dc=!0,await ih(s.remoteStore,!0);for(const r of t)Qc(s.remoteStore,r)}else if(!1===t&&!1!==s.dc){const r=[];let n=Promise.resolve();s.rc.forEach((e,t)=>{s.sharedClientState.isLocalQueryTarget(t)?r.push(t):n=n.then(()=>(Mh(s,t),fc(s.localStore,t,!0))),zc(s.remoteStore,t)}),await n,await Bh(s,r);{const i=s;i.cc.forEach((e,t)=>{zc(i.remoteStore,t)}),i.ac.fs(),i.cc=new Map,i.uc=new C(D.comparator)}s.dc=!1,await ih(s.remoteStore,!1)}}await 0,this.gcScheduler&&(e&&!this.gcScheduler.started?this.gcScheduler.start():e||this.gcScheduler.stop()),this.indexBackfillerScheduler&&(e&&!this.indexBackfillerScheduler.started?this.indexBackfillerScheduler.start():e||this.indexBackfillerScheduler.stop())})}gc(e){var t=Lc();if(!xc.C(t))throw new b(I.UNIMPLEMENTED,"IndexedDB persistence is only available on platforms that support LocalStorage.");var n=sc(e.databaseInfo.databaseId,e.databaseInfo.persistenceKey);return new xc(t,e.asyncQueue,n,e.clientId,e.initialUser)}}class zh{async initialize(e,t){this.localStore||(this.localStore=e.localStore,this.sharedClientState=e.sharedClientState,this.datastore=this.createDatastore(t),this.remoteStore=this.createRemoteStore(t),this.eventManager=this.createEventManager(t),this.syncEngine=this.createSyncEngine(t,!e.synchronizeTabs),this.sharedClientState.onlineStateHandler=e=>kh(this.syncEngine,e,1),this.remoteStore.remoteSyncer.handleCredentialChange=async function(e,t){const n=e;var r;n.currentUser.isEqual(t)||(f("SyncEngine","User change. New user:",t.toKey()),r=await cc(n.localStore,t),n.currentUser=t,(e=n).lc.forEach(e=>{e.forEach(e=>{e.reject(new b(I.CANCELLED,"'waitForPendingWrites' promise is rejected due to a user change."))})}),e.lc.clear(),n.sharedClientState.handleUserChange(t,r.removedBatchIds,r.addedBatchIds),await Ph(n,r.ji))}.bind(null,this.syncEngine),await ih(this.remoteStore,this.syncEngine.isPrimaryClient))}createEventManager(e){return new gh}createDatastore(e){var t=Oc(e.databaseInfo.databaseId),n=(n=e.databaseInfo,new Rc(n)),r=e.authCredentials,s=e.appCheckCredentials;return e=t,new Uc(r,s,n,e)}createRemoteStore(e){return t=this.localStore,n=this.datastore,e=e.asyncQueue,r=e=>kh(this.syncEngine,e,0),s=new(Cc.C()?Cc:Ac),new Kc(t,n,e,r,s);var t,n,r,s}createSyncEngine(e,t){{var n=this.localStore,r=this.remoteStore,s=this.eventManager,i=this.sharedClientState,a=e.initialUser;e=e.maxConcurrentLimboResolutions;const o=new Ah(n,r,s,i,a,e);return t&&(o.dc=!0),o}}terminate(){return async function(e){const t=e;f("RemoteStore","RemoteStore shutting down."),t._u.add(5),await jc(t),t.mu.shutdown(),t.gu.set("Unknown")}(this.remoteStore)}}function Hh(e,t,n){if(!n)throw new b(I.INVALID_ARGUMENT,`Function ${e}() cannot be called with an empty ${t}.`)}function Wh(e,t,n,r){if(!0===t&&!0===r)throw new b(I.INVALID_ARGUMENT,e+` and ${n} cannot be used together.`)}function $h(e){if(!D.isDocumentKey(e))throw new b(I.INVALID_ARGUMENT,`Invalid document reference. Document references must have an even number of segments, but ${e} has ${e.length}.`)}function Yh(e){if(D.isDocumentKey(e))throw new b(I.INVALID_ARGUMENT,`Invalid collection reference. Collection references must have an odd number of segments, but ${e} has ${e.length}.`)}function Xh(e){if(void 0===e)return"undefined";if(null===e)return"null";if("string"==typeof e)return 20<e.length&&(e=e.substring(0,20)+"..."),JSON.stringify(e);if("number"==typeof e||"boolean"==typeof e)return""+e;if("object"!=typeof e)return"function"==typeof e?"a function":E();if(e instanceof Array)return"an array";e=e.constructor?e.constructor.name:null;return e?`a custom ${e} object`:"an object"}function F(e,t){if((e="_delegate"in e?e._delegate:e)instanceof t)return e;if(t.name===e.constructor.name)throw new b(I.INVALID_ARGUMENT,"Type does not match the expected instance. Did you pass a reference from a different Firestore SDK?");e=Xh(e);throw new b(I.INVALID_ARGUMENT,`Expected type '${t.name}', but it was: `+e)}function Jh(e,t){if(t<=0)throw new b(I.INVALID_ARGUMENT,`Function ${e}() requires a positive number, but it was: ${t}.`)}const Zh=new Map;class el{constructor(e){var t;if(void 0===e.host){if(void 0!==e.ssl)throw new b(I.INVALID_ARGUMENT,"Can't provide ssl option if host option is not set");this.host="firestore.googleapis.com",this.ssl=!0}else this.host=e.host,this.ssl=null==(t=e.ssl)||t;if(this.credentials=e.credentials,this.ignoreUndefinedProperties=!!e.ignoreUndefinedProperties,void 0===e.cacheSizeBytes)this.cacheSizeBytes=41943040;else{if(-1!==e.cacheSizeBytes&&e.cacheSizeBytes<1048576)throw new b(I.INVALID_ARGUMENT,"cacheSizeBytes must be at least 1048576");this.cacheSizeBytes=e.cacheSizeBytes}this.experimentalForceLongPolling=!!e.experimentalForceLongPolling,this.experimentalAutoDetectLongPolling=!!e.experimentalAutoDetectLongPolling,this.useFetchStreams=!!e.useFetchStreams,Wh("experimentalForceLongPolling",e.experimentalForceLongPolling,"experimentalAutoDetectLongPolling",e.experimentalAutoDetectLongPolling)}isEqual(e){return this.host===e.host&&this.ssl===e.ssl&&this.credentials===e.credentials&&this.cacheSizeBytes===e.cacheSizeBytes&&this.experimentalForceLongPolling===e.experimentalForceLongPolling&&this.experimentalAutoDetectLongPolling===e.experimentalAutoDetectLongPolling&&this.ignoreUndefinedProperties===e.ignoreUndefinedProperties&&this.useFetchStreams===e.useFetchStreams}}class tl{constructor(e,t,n,r){this._authCredentials=e,this._appCheckCredentials=t,this._databaseId=n,this._app=r,this.type="firestore-lite",this._persistenceKey="(lite)",this._settings=new el({}),this._settingsFrozen=!1}get app(){if(this._app)return this._app;throw new b(I.FAILED_PRECONDITION,"Firestore was not initialized using the Firebase SDK. 'app' is not available")}get _initialized(){return this._settingsFrozen}get _terminated(){return void 0!==this._terminateTask}_setSettings(e){if(this._settingsFrozen)throw new b(I.FAILED_PRECONDITION,"Firestore has already been started and its settings can no longer be changed. You can only modify settings before calling any other methods on a Firestore object.");this._settings=new el(e),void 0!==e.credentials&&(this._authCredentials=function(e){if(!e)return new Rr;switch(e.type){case"gapi":var t=e.client;return new Vr(t,e.sessionIndex||"0",e.iamToken||null,e.authTokenFactory||null);case"provider":return e.client;default:throw new b(I.INVALID_ARGUMENT,"makeAuthCredentialsProvider failed due to invalid credential type")}}(e.credentials))}_getSettings(){return this._settings}_freezeSettings(){return this._settingsFrozen=!0,this._settings}_delete(){return this._terminateTask||(this._terminateTask=this._terminate()),this._terminateTask}toJSON(){return{app:this._app,databaseId:this._databaseId,settings:this._settings}}_terminate(){{var e=this;const t=Zh.get(e);t&&(f("ComponentProvider","Removing Datastore"),Zh.delete(e),t.terminate())}return Promise.resolve()}}class P{constructor(e,t,n){this.converter=t,this._key=n,this.type="document",this.firestore=e}get _path(){return this._key.path}get id(){return this._key.path.lastSegment()}get path(){return this._key.path.canonicalString()}get parent(){return new rl(this.firestore,this.converter,this._key.path.popLast())}withConverter(e){return new P(this.firestore,e,this._key)}}class nl{constructor(e,t,n){this.converter=t,this._query=n,this.type="query",this.firestore=e}withConverter(e){return new nl(this.firestore,e,this._query)}}class rl extends nl{constructor(e,t,n){super(e,t,Ii(n)),this._path=n,this.type="collection"}get id(){return this._query.path.lastSegment()}get path(){return this._query.path.canonicalString()}get parent(){const e=this._path.popLast();return e.isEmpty()?null:new P(this.firestore,null,new D(e))}withConverter(e){return new rl(this.firestore,e,this._path)}}function sl(e,t,...n){var r;if(e=v(e),Hh("collection","path",t),e instanceof tl)return Yh(r=_.fromString(t,...n)),new rl(e,null,r);if(e instanceof P||e instanceof rl)return Yh(r=e._path.child(_.fromString(t,...n))),new rl(e.firestore,null,r);throw new b(I.INVALID_ARGUMENT,"Expected first argument to collection() to be a CollectionReference, a DocumentReference or FirebaseFirestore")}function il(e,t,...n){var r;if(e=v(e),Hh("doc","path",t=1===arguments.length?Br.R():t),e instanceof tl)return $h(r=_.fromString(t,...n)),new P(e,null,new D(r));if(e instanceof P||e instanceof rl)return $h(r=e._path.child(_.fromString(t,...n))),new P(e.firestore,e instanceof rl?e.converter:null,new D(r));throw new b(I.INVALID_ARGUMENT,"Expected first argument to collection() to be a CollectionReference, a DocumentReference or FirebaseFirestore")}function al(e,t){return e=v(e),t=v(t),(e instanceof P||e instanceof rl)&&(t instanceof P||t instanceof rl)&&e.firestore===t.firestore&&e.path===t.path&&e.converter===t.converter}function ol(e,t){return e=v(e),t=v(t),e instanceof nl&&t instanceof nl&&e.firestore===t.firestore&&Ai(e._query,t._query)&&e.converter===t.converter}function ul(t,n=10240){let r=0;return{async read(){var e;return r<t.byteLength?(e={value:t.slice(r,r+n),done:!1},r+=n,e):{done:!0}},async cancel(){},releaseLock(){},closed:Promise.reject("unimplemented")}}class cl{constructor(e){this.observer=e,this.muted=!1}next(e){this.observer.next&&this.Rc(this.observer.next,e)}error(e){this.observer.error?this.Rc(this.observer.error,e):g("Uncaught Error in snapshot listener:",e.toString())}bc(){this.muted=!0}Rc(e,t){this.muted||setTimeout(()=>{this.muted||e(t)},0)}}class hl{constructor(e,t){this.Pc=e,this.It=t,this.metadata=new m,this.buffer=new Uint8Array,this.vc=new TextDecoder("utf-8"),this.Vc().then(e=>{e&&e.Ou()?this.metadata.resolve(e.ku.metadata):this.metadata.reject(new Error(`The first element of the bundle is not a metadata, it is
             `+JSON.stringify(null==e?void 0:e.ku)))},e=>this.metadata.reject(e))}close(){return this.Pc.cancel()}async getMetadata(){return this.metadata.promise}async mc(){return await this.getMetadata(),this.Vc()}async Vc(){var e=await this.Sc();if(null===e)return null;var t=this.vc.decode(e),n=Number(t);return isNaN(n)&&this.Dc(`length string (${t}) is not valid number`),t=await this.Cc(n),new wh(JSON.parse(t),e.length+n)}xc(){return this.buffer.findIndex(e=>e==="{".charCodeAt(0))}async Sc(){for(;this.xc()<0&&!await this.Nc(););if(0===this.buffer.length)return null;var e=this.xc(),t=(e<0&&this.Dc("Reached the end of bundle when a length string is expected."),this.buffer.slice(0,e));return this.buffer=this.buffer.slice(e),t}async Cc(e){for(;this.buffer.length<e;)await this.Nc()&&this.Dc("Reached the end of bundle when more is expected.");var t=this.vc.decode(this.buffer.slice(0,e));return this.buffer=this.buffer.slice(e),t}Dc(e){throw this.Pc.cancel(),new Error("Invalid bundle format: "+e)}async Nc(){var e=await this.Pc.read();if(!e.done){const t=new Uint8Array(this.buffer.length+e.value.length);t.set(this.buffer),t.set(e.value,this.buffer.length),this.buffer=t}return e.done}}class ll{constructor(e){this.datastore=e,this.readVersions=new Map,this.mutations=[],this.committed=!1,this.lastWriteError=null,this.writtenDocs=new Set}async lookup(e){if(this.ensureCommitNotCalled(),0<this.mutations.length)throw new b(I.INVALID_ARGUMENT,"Firestore transactions require all reads to be executed before all writes.");const t=await async function(e,t){const a=e,n=Ba(a.It)+"/documents",r={documents:t.map(e=>Oa(a.It,e))},s=await a._o("BatchGetDocuments",n,r,t.length),o=new Map,i=(s.forEach(e=>{i=a.It;const t="found"in e?(n=i,y(!!(r=e).found),r.found.name,r.found.updateTime,n=Va(n,r.found.name),s=V(r.found.updateTime),r=new Ys({mapValue:{fields:r.found.fields}}),L.newFoundDocument(n,s,r)):"missing"in e?function(e,t){y(!!t.missing),y(!!t.readTime);e=Va(e,t.missing),t=V(t.readTime);return L.newNoDocument(e,t)}(i,e):E();var n,r,s,i;o.set(t.key.toString(),t)}),[]);return t.forEach(e=>{e=o.get(e.toString());y(!!e),i.push(e)}),i}(this.datastore,e);return t.forEach(e=>this.recordVersion(e)),t}set(e,t){this.write(t.toMutation(e,this.precondition(e))),this.writtenDocs.add(e.toString())}update(e,t){try{this.write(t.toMutation(e,this.preconditionForUpdate(e)))}catch(e){this.lastWriteError=e}this.writtenDocs.add(e.toString())}delete(e){this.write(new ia(e,this.precondition(e))),this.writtenDocs.add(e.toString())}async commit(){if(this.ensureCommitNotCalled(),this.lastWriteError)throw this.lastWriteError;const t=this.readVersions;this.mutations.forEach(e=>{t.delete(e.key.toString())}),t.forEach((e,t)=>{t=D.fromPath(t);this.mutations.push(new aa(t,this.precondition(t)))});{var e=this.datastore,n=this.mutations;const r=e,s=Ba(r.It)+"/documents",i={writes:n.map(e=>Ga(r.It,e))};await r.ao("Commit",s,i)}await 0,this.committed=!0}recordVersion(e){let t;if(e.isFoundDocument())t=e.version;else{if(!e.isNoDocument())throw E();t=S.min()}var n=this.readVersions.get(e.key.toString());if(n){if(!t.isEqual(n))throw new b(I.ABORTED,"Document version changed between two reads.")}else this.readVersions.set(e.key.toString(),t)}precondition(e){const t=this.readVersions.get(e.toString());return!this.writtenDocs.has(e.toString())&&t?t.isEqual(S.min())?M.exists(!1):M.updateTime(t):M.none()}preconditionForUpdate(e){const t=this.readVersions.get(e.toString());if(this.writtenDocs.has(e.toString())||!t)return M.exists(!0);if(t.isEqual(S.min()))throw new b(I.INVALID_ARGUMENT,"Can't update a document that doesn't exist.");return M.updateTime(t)}write(e){this.ensureCommitNotCalled(),this.mutations.push(e)}ensureCommitNotCalled(){}}class dl{constructor(e,t,n,r,s){this.asyncQueue=e,this.datastore=t,this.options=n,this.updateFunction=r,this.deferred=s,this.kc=n.maxAttempts,this.xo=new Vc(this.asyncQueue,"transaction_retry")}run(){--this.kc,this.Oc()}Oc(){this.xo.Ro(async()=>{const t=new ll(this.datastore),e=this.Mc(t);e&&e.then(e=>{this.asyncQueue.enqueueAndForget(()=>t.commit().then(()=>{this.deferred.resolve(e)}).catch(e=>{this.Fc(e)}))}).catch(e=>{this.Fc(e)})})}Mc(e){try{var t=this.updateFunction(e);return!Cs(t)&&t.catch&&t.then?t:(this.deferred.reject(Error("Transaction callback must return a Promise")),null)}catch(e){return this.deferred.reject(e),null}}Fc(e){0<this.kc&&this.$c(e)?(--this.kc,this.asyncQueue.enqueueAndForget(()=>(this.Oc(),Promise.resolve()))):this.deferred.reject(e)}$c(e){if("FirebaseError"!==e.name)return!1;e=e.code;return"aborted"===e||"failed-precondition"===e||"already-exists"===e||!ua(e)}}class fl{constructor(e,t,n,r){this.authCredentials=e,this.appCheckCredentials=t,this.asyncQueue=n,this.databaseInfo=r,this.user=o.UNAUTHENTICATED,this.clientId=Br.R(),this.authCredentialListener=()=>Promise.resolve(),this.appCheckCredentialListener=()=>Promise.resolve(),this.authCredentials.start(n,async e=>{f("FirestoreClient","Received user=",e.uid),await this.authCredentialListener(e),this.user=e}),this.appCheckCredentials.start(n,e=>(f("FirestoreClient","Received new app check token=",e),this.appCheckCredentialListener(e,this.user)))}async getConfiguration(){return{asyncQueue:this.asyncQueue,databaseInfo:this.databaseInfo,clientId:this.clientId,authCredentials:this.authCredentials,appCheckCredentials:this.appCheckCredentials,initialUser:this.user,maxConcurrentLimboResolutions:100}}setCredentialChangeListener(e){this.authCredentialListener=e}setAppCheckTokenChangeListener(e){this.appCheckCredentialListener=e}verifyNotTerminated(){if(this.asyncQueue.isShuttingDown)throw new b(I.FAILED_PRECONDITION,"The client has already been terminated.")}terminate(){this.asyncQueue.enterRestrictedMode();const n=new m;return this.asyncQueue.enqueueAndForgetEvenWhileRestricted(async()=>{try{this.onlineComponents&&await this.onlineComponents.terminate(),this.offlineComponents&&await this.offlineComponents.terminate(),this.authCredentials.shutdown(),this.appCheckCredentials.shutdown(),n.resolve()}catch(e){var t=ch(e,"Failed to shutdown persistence");n.reject(t)}}),n.promise}}async function gl(e,t){e.asyncQueue.verifyOperationInProgress(),f("FirestoreClient","Initializing OfflineComponentProvider");var n=await e.getConfiguration();await t.initialize(n);let r=n.initialUser;e.setCredentialChangeListener(async e=>{r.isEqual(e)||(await cc(t.localStore,e),r=e)}),t.persistence.setDatabaseDeletedListener(()=>e.terminate()),e.offlineComponents=t}async function ml(e,n){e.asyncQueue.verifyOperationInProgress();var t=await pl(e),r=(f("FirestoreClient","Initializing OnlineComponentProvider"),await e.getConfiguration());await n.initialize(t,r),e.setCredentialChangeListener(e=>sh(n.remoteStore,e)),e.setAppCheckTokenChangeListener((e,t)=>sh(n.remoteStore,t)),e.onlineComponents=n}async function pl(e){return e.offlineComponents||(f("FirestoreClient","Using default OfflineComponentProvider"),await gl(e,new Gh)),e.offlineComponents}async function yl(e){return e.onlineComponents||(f("FirestoreClient","Using default OnlineComponentProvider"),await ml(e,new zh)),e.onlineComponents}function vl(e){return pl(e).then(e=>e.persistence)}function wl(e){return pl(e).then(e=>e.localStore)}function Il(e){return yl(e).then(e=>e.remoteStore)}function bl(e){return yl(e).then(e=>e.syncEngine)}async function El(e){const t=await yl(e),n=t.eventManager;return n.onListen=async function(e,t){const n=qh(e);let r,s;const i=n.ic.get(t);if(i)r=i.targetId,n.sharedClientState.addLocalQueryTarget(r),s=i.view.ec();else{const e=await dc(n.localStore,xi(t)),i=(n.isPrimaryClient&&Qc(n.remoteStore,e),n.sharedClientState.addLocalQueryTarget(e.targetId));r=e.targetId,s=await Ch(n,t,r,"current"===i,e.resumeToken)}return s}.bind(null,t.syncEngine),n.onUnlisten=async function(e,t){const n=e,r=n.ic.get(t),s=n.rc.get(r.targetId);if(1<s.length)return n.rc.set(r.targetId,s.filter(e=>!Ai(e,t))),void n.ic.delete(t);n.isPrimaryClient?(n.sharedClientState.removeLocalQueryTarget(r.targetId),n.sharedClientState.isActiveQueryTarget(r.targetId)||await fc(n.localStore,r.targetId,!1).then(()=>{n.sharedClientState.clearQueryState(r.targetId),zc(n.remoteStore,r.targetId),Mh(n,r.targetId)}).catch(ts)):(Mh(n,r.targetId),await fc(n.localStore,r.targetId,!0))}.bind(null,t.syncEngine),n}function Tl(t,u,c={}){const h=new m;return t.asyncQueue.enqueueAndForget(async()=>{{var n=await El(t),r=t.asyncQueue,s=u,i=c,a=h;const e=new cl({next:e=>{r.enqueueAndForget(()=>ph(n,o));var t=e.docs.has(s);!t&&e.fromCache?a.reject(new b(I.UNAVAILABLE,"Failed to get document because the client is offline.")):t&&e.fromCache&&i&&"server"===i.source?a.reject(new b(I.UNAVAILABLE,'Failed to get document from server. (However, this document does exist in the local cache. Run again without setting source to "server" to retrieve the cached document.)')):a.resolve(e)},error:e=>a.reject(e)}),o=new vh(Ii(s.path),e,{includeMetadataChanges:!0,Nu:!0});return mh(n,o)}}),h.promise}function Sl(o,u,c={}){const h=new m;return o.asyncQueue.enqueueAndForget(async()=>{{var t=await El(o),n=o.asyncQueue,e=u,r=c,s=h;const i=new cl({next:e=>{n.enqueueAndForget(()=>ph(t,a)),e.fromCache&&"server"===r.source?s.reject(new b(I.UNAVAILABLE,'Failed to get documents from server. (However, these documents may exist in the local cache. Run again without setting source to "server" to retrieve the cached documents.)')):s.resolve(e)},error:e=>s.reject(e)}),a=new vh(e,i,{includeMetadataChanges:!0,Nu:!0});return mh(t,a)}}),h.promise}function _l(r,e,t,s){e=Oc(e),t=function(e){if(e instanceof Uint8Array)return ul(e,void 0);if(e instanceof ArrayBuffer)return ul(new Uint8Array(e),void 0);if(e instanceof ReadableStream)return e.getReader();throw new Error("Source of `toByteStreamReader` has to be a ArrayBuffer or ReadableStream")}("string"==typeof t?(new TextEncoder).encode(t):t);const i=new hl(t,e);r.asyncQueue.enqueueAndForget(async()=>{{var e=await bl(r),t=i;const n=e;return void async function(t,n,r){try{var s=await n.getMetadata();if(await function(e,t){const n=e,r=V(t.createTime);return n.persistence.runTransaction("hasNewerBundle","readonly",e=>n.Ns.getBundleMetadata(e,t.id)).then(e=>!!e&&0<=e.createTime.compareTo(r))}(t.localStore,s))return await n.close(),r._completeWith({taskState:"Success",documentsLoaded:s.totalDocuments,bytesLoaded:s.totalBytes,totalDocuments:s.totalDocuments,totalBytes:s.totalBytes}),Promise.resolve(new Set);r._updateProgress(Eh(s));const a=new bh(s,t.localStore,n.It);let e=await n.mc();for(;e;){const t=await a.Fu(e);t&&r._updateProgress(t),e=await n.mc()}var i=await a.complete();return await Ph(t,i.Lu,void 0),await function(e,t){const n=e;return n.persistence.runTransaction("Save bundle","readwrite",e=>n.Ns.saveBundleMetadata(e,t))}(t.localStore,s),r._completeWith(i.progress),Promise.resolve(i.Bu)}catch(t){return Cr("SyncEngine","Loading bundle failed with "+t),r._failWith(t),Promise.resolve(new Set)}}(n,t,s).then(e=>{n.sharedClientState.notifyBundleLoaded(e)})}})}class xl{constructor(){this.Bc=Promise.resolve(),this.Lc=[],this.Uc=!1,this.qc=[],this.Kc=null,this.Gc=!1,this.Qc=!1,this.jc=[],this.xo=new Vc(this,"async_queue_retry"),this.Wc=()=>{var e=Mc();e&&f("AsyncQueue","Visibility state changed to "+e.visibilityState),this.xo.Po()};const e=Mc();e&&"function"==typeof e.addEventListener&&e.addEventListener("visibilitychange",this.Wc)}get isShuttingDown(){return this.Uc}enqueueAndForget(e){this.enqueue(e)}enqueueAndForgetEvenWhileRestricted(e){this.zc(),this.Hc(e)}enterRestrictedMode(e){if(!this.Uc){this.Uc=!0,this.Qc=e||!1;const t=Mc();t&&"function"==typeof t.removeEventListener&&t.removeEventListener("visibilitychange",this.Wc)}}enqueue(e){if(this.zc(),this.Uc)return new Promise(()=>{});const t=new m;return this.Hc(()=>this.Uc&&this.Qc?Promise.resolve():(e().then(t.resolve,t.reject),t.promise)).then(()=>t.promise)}enqueueRetryable(e){this.enqueueAndForget(()=>(this.Lc.push(e),this.Jc()))}async Jc(){if(0!==this.Lc.length){try{await this.Lc[0](),this.Lc.shift(),this.xo.reset()}catch(e){if(!as(e))throw e;f("AsyncQueue","Operation failed with retryable error: "+e)}0<this.Lc.length&&this.xo.Ro(()=>this.Jc())}}Hc(e){var t=this.Bc.then(()=>(this.Gc=!0,e().catch(e=>{throw this.Kc=e,this.Gc=!1,g("INTERNAL UNHANDLED ERROR: ",function(e){let t=e.message||"";return t=e.stack?e.stack.includes(e.message)?e.stack:e.message+"\n"+e.stack:t}(e)),e}).then(e=>(this.Gc=!1,e))));return this.Bc=t}enqueueAfterDelay(e,t,n){this.zc(),-1<this.jc.indexOf(e)&&(t=0);e=uh.createAndSchedule(this,e,t,n,e=>this.Yc(e));return this.qc.push(e),e}zc(){this.Kc&&E()}verifyOperationInProgress(){}async Xc(){for(var e;await(e=this.Bc),e!==this.Bc;);}Zc(e){for(const t of this.qc)if(t.timerId===e)return!0;return!1}ta(t){return this.Xc().then(()=>{this.qc.sort((e,t)=>e.targetTimeMs-t.targetTimeMs);for(const e of this.qc)if(e.skipDelay(),"all"!==t&&e.timerId===t)break;return this.Xc()})}ea(e){this.jc.push(e)}Yc(e){e=this.qc.indexOf(e);this.qc.splice(e,1)}}function Dl(e){var t=e;if("object"==typeof t&&null!==t){var n=t;for(const t of["next","error","complete"])if(t in n&&"function"==typeof n[t])return 1}}class Al{constructor(){this._progressObserver={},this._taskCompletionResolver=new m,this._lastProgress={taskState:"Running",totalBytes:0,totalDocuments:0,bytesLoaded:0,documentsLoaded:0}}onProgress(e,t,n){this._progressObserver={next:e,error:t,complete:n}}catch(e){return this._taskCompletionResolver.promise.catch(e)}then(e,t){return this._taskCompletionResolver.promise.then(e,t)}_completeWith(e){this._updateProgress(e),this._progressObserver.complete&&this._progressObserver.complete(),this._taskCompletionResolver.resolve(e)}_failWith(e){this._lastProgress.taskState="Error",this._progressObserver.next&&this._progressObserver.next(this._lastProgress),this._progressObserver.error&&this._progressObserver.error(e),this._taskCompletionResolver.reject(e)}_updateProgress(e){this._lastProgress=e,this._progressObserver.next&&this._progressObserver.next(e)}}class B extends tl{constructor(e,t,n,r){super(e,t,n,r),this.type="firestore",this._queue=new xl,this._persistenceKey=(null==r?void 0:r.name)||"[DEFAULT]"}_terminate(){return this._firestoreClient||Nl(this),this._firestoreClient.terminate()}}function Cl(e){return e._firestoreClient||Nl(e),e._firestoreClient.verifyNotTerminated(),e._firestoreClient}function Nl(e){var t,n,r,s,i=e._freezeSettings(),i=(t=e._databaseId,n=(null==(n=e._app)?void 0:n.options.appId)||"",r=e._persistenceKey,s=i,new Ds(t,n,r,s.host,s.ssl,s.experimentalForceLongPolling,s.experimentalAutoDetectLongPolling,s.useFetchStreams));e._firestoreClient=new fl(e._authCredentials,e._appCheckCredentials,e._queue,i)}function kl(e,n,r){const s=new m;return e.asyncQueue.enqueue(async()=>{try{await gl(e,r),await ml(e,n),s.resolve()}catch(e){const n=e;if(!("FirebaseError"===(t=n).name?t.code===I.FAILED_PRECONDITION||t.code===I.UNIMPLEMENTED:!("undefined"!=typeof DOMException&&t instanceof DOMException)||22===t.code||20===t.code||11===t.code))throw n;Cr("Error enabling offline persistence. Falling back to persistence disabled: "+n),s.reject(n)}var t}).then(()=>s.promise)}function Rl(e){return(r=Cl(e=F(e,B))).asyncQueue.enqueue(async()=>{const e=await vl(r),t=await Il(r);e.setNetworkEnabled(!0);{const n=t;return n._u.delete(0),Gc(n)}});var r}function Ll(t,e){return r=Cl(t=F(t,B)),s=e,r.asyncQueue.enqueue(async()=>{{var e=await wl(r),t=s;const n=e;return n.persistence.runTransaction("Get named query","readonly",e=>n.Ns.getNamedQuery(e,t))}}).then(e=>e?new nl(t,null,e.query):null);var r,s}function Ml(e){if(e._initialized||e._terminated)throw new b(I.FAILED_PRECONDITION,"Firestore has already been started and persistence can no longer be enabled. You can only enable persistence before calling any other methods on a Firestore object.")}class Ol{constructor(e){this._byteString=e}static fromBase64String(e){try{return new Ol(k.fromBase64String(e))}catch(e){throw new b(I.INVALID_ARGUMENT,"Failed to construct data from Base64 string: "+e)}}static fromUint8Array(e){return new Ol(k.fromUint8Array(e))}toBase64(){return this._byteString.toBase64()}toUint8Array(){return this._byteString.toUint8Array()}toString(){return"Bytes(base64: "+this.toBase64()+")"}isEqual(e){return this._byteString.isEqual(e._byteString)}}class Vl{constructor(...t){for(let e=0;e<t.length;++e)if(0===t[e].length)throw new b(I.INVALID_ARGUMENT,"Invalid field name at argument $(i + 1). Field names must not be empty.");this._internalPath=new x(t)}isEqual(e){return this._internalPath.isEqual(e._internalPath)}}class Fl{constructor(e){this._methodName=e}}class Pl{constructor(e,t){if(!isFinite(e)||e<-90||90<e)throw new b(I.INVALID_ARGUMENT,"Latitude must be a number between -90 and 90, but was: "+e);if(!isFinite(t)||t<-180||180<t)throw new b(I.INVALID_ARGUMENT,"Longitude must be a number between -180 and 180, but was: "+t);this._lat=e,this._long=t}get latitude(){return this._lat}get longitude(){return this._long}isEqual(e){return this._lat===e._lat&&this._long===e._long}toJSON(){return{latitude:this._lat,longitude:this._long}}_compareTo(e){return T(this._lat,e._lat)||T(this._long,e._long)}}const Bl=/^__.*__$/;class Ul{constructor(e,t,n){this.data=e,this.fieldMask=t,this.fieldTransforms=n}toMutation(e,t){return null!==this.fieldMask?new ta(e,this.data,this.fieldMask,t,this.fieldTransforms):new ea(e,this.data,t,this.fieldTransforms)}}class ql{constructor(e,t,n){this.data=e,this.fieldMask=t,this.fieldTransforms=n}toMutation(e,t){return new ta(e,this.data,this.fieldMask,t,this.fieldTransforms)}}function Kl(e){switch(e){case 0:case 2:case 1:return 1;case 3:case 4:return;default:throw E()}}class Gl{constructor(e,t,n,r,s,i){this.settings=e,this.databaseId=t,this.It=n,this.ignoreUndefinedProperties=r,void 0===s&&this.na(),this.fieldTransforms=s||[],this.fieldMask=i||[]}get path(){return this.settings.path}get sa(){return this.settings.sa}ia(e){return new Gl(Object.assign(Object.assign({},this.settings),e),this.databaseId,this.It,this.ignoreUndefinedProperties,this.fieldTransforms,this.fieldMask)}ra(e){var t;const n=null==(t=this.path)?void 0:t.child(e),r=this.ia({path:n,oa:!1});return r.ua(e),r}ca(e){var t;const n=null==(t=this.path)?void 0:t.child(e),r=this.ia({path:n,oa:!1});return r.na(),r}aa(e){return this.ia({path:void 0,oa:!0})}ha(e){return cd(e,this.settings.methodName,this.settings.la||!1,this.path,this.settings.fa)}contains(t){return void 0!==this.fieldMask.find(e=>t.isPrefixOf(e))||void 0!==this.fieldTransforms.find(e=>t.isPrefixOf(e.field))}na(){if(this.path)for(let e=0;e<this.path.length;e++)this.ua(this.path.get(e))}ua(e){if(0===e.length)throw this.ha("Document fields must not be empty");if(Kl(this.sa)&&Bl.test(e))throw this.ha('Document fields cannot begin and end with "__"')}}class jl{constructor(e,t,n){this.databaseId=e,this.ignoreUndefinedProperties=t,this.It=n||Oc(e)}da(e,t,n,r=!1){return new Gl({sa:e,methodName:t,fa:n,path:x.emptyPath(),oa:!1,la:r},this.databaseId,this.It,this.ignoreUndefinedProperties)}}function Ql(e){var t=e._freezeSettings(),n=Oc(e._databaseId);return new jl(e._databaseId,!!t.ignoreUndefinedProperties,n)}function zl(e,t,n,r,s,i={}){const a=e.da(i.merge||i.mergeFields?2:0,t,n,s);id("Data must be an object, but it was:",a,r);e=rd(r,a);let o,u;if(i.merge)o=new bs(a.fieldMask),u=a.fieldTransforms;else if(i.mergeFields){const e=[];for(const r of i.mergeFields){const s=ad(t,r,n);if(!a.contains(s))throw new b(I.INVALID_ARGUMENT,`Field '${s}' is specified in your field mask but missing from your input data.`);hd(e,s)||e.push(s)}o=new bs(e),u=a.fieldTransforms.filter(e=>o.covers(e.field))}else o=null,u=a.fieldTransforms;return new Ul(new Ys(e),o,u)}class Hl extends Fl{_toFieldTransform(e){if(2!==e.sa)throw 1===e.sa?e.ha(this._methodName+"() can only appear at the top level of your update data"):e.ha(this._methodName+"() cannot be used with set() unless you pass {merge:true}");return e.fieldMask.push(e.path),null}isEqual(e){return e instanceof Hl}}function Wl(e,t,n){return new Gl({sa:3,fa:t.settings.fa,methodName:e._methodName,oa:n},t.databaseId,t.It,t.ignoreUndefinedProperties)}class $l extends Fl{_toFieldTransform(e){return new Hi(e.path,new Bi)}isEqual(e){return e instanceof $l}}class Yl extends Fl{constructor(e,t){super(e),this._a=t}_toFieldTransform(e){const t=Wl(this,e,!0),n=this._a.map(e=>nd(e,t)),r=new Ui(n);return new Hi(e.path,r)}isEqual(e){return this===e}}class Xl extends Fl{constructor(e,t){super(e),this._a=t}_toFieldTransform(e){const t=Wl(this,e,!0),n=this._a.map(e=>nd(e,t)),r=new Ki(n);return new Hi(e.path,r)}isEqual(e){return this===e}}class Jl extends Fl{constructor(e,t){super(e),this.wa=t}_toFieldTransform(e){var t=new ji(e.It,Vi(e.It,this.wa));return new Hi(e.path,t)}isEqual(e){return this===e}}function Zl(e,s,i,t){const a=e.da(1,s,i),o=(id("Data must be an object, but it was:",a,t),[]),u=Ys.empty();ms(t,(e,t)=>{var n=ud(s,e,i),r=(t=v(t),a.ca(n));if(t instanceof Hl)o.push(n);else{const e=nd(t,r);null!=e&&(o.push(n),u.set(n,e))}});e=new bs(o);return new ql(u,e,a.fieldTransforms)}function ed(t,n,e,r,s,i){const a=t.da(1,n,e),o=[ad(n,r,e)],u=[s];if(i.length%2!=0)throw new b(I.INVALID_ARGUMENT,`Function ${n}() needs to be called with an even number of arguments that alternate between field names and values.`);for(let e=0;e<i.length;e+=2)o.push(ad(n,i[e])),u.push(i[e+1]);const c=[],h=Ys.empty();for(let e=o.length-1;0<=e;--e)if(!hd(c,o[e])){const n=o[e];var l=v(u[e]);const r=a.ca(n);if(l instanceof Hl)c.push(n);else{const t=nd(l,r);null!=t&&(c.push(n),h.set(n,t))}}t=new bs(c);return new ql(h,t,a.fieldTransforms)}function td(e,t,n,r=!1){return nd(n,e.da(r?4:3,t))}function nd(e,n){if(sd(e=v(e)))return id("Unsupported field value:",n,e),rd(e,n);if(e instanceof Fl){{var t=e;var r=n;if(!Kl(r.sa))throw r.ha(t._methodName+"() can only be used with update() and set()");if(!r.path)throw r.ha(t._methodName+"() is not currently supported inside arrays");t=t._toFieldTransform(r);t&&r.fieldTransforms.push(t)}return null}if(void 0===e&&n.ignoreUndefinedProperties)return null;if(n.path&&n.fieldMask.push(n.path),e instanceof Array){if(n.settings.oa&&4!==n.sa)throw n.ha("Nested arrays are not supported");{var s=n;const a=[];let t=0;for(const o of e){let e=nd(o,s.aa(t));null==e&&(e={nullValue:"NULL_VALUE"}),a.push(e),t++}return{arrayValue:{values:a}}}}var i,r=0,t=n;if(null===(r=v(e)))return{nullValue:"NULL_VALUE"};if("number"==typeof r)return Vi(t.It,r);if("boolean"==typeof r)return{booleanValue:r};if("string"==typeof r)return{stringValue:r};if(r instanceof Date)return i=h.fromDate(r),{timestampValue:ka(t.It,i)};if(r instanceof h)return i=new h(r.seconds,1e3*Math.floor(r.nanoseconds/1e3)),{timestampValue:ka(t.It,i)};if(r instanceof Pl)return{geoPointValue:{latitude:r.latitude,longitude:r.longitude}};if(r instanceof Ol)return{bytesValue:Ra(t.It,r._byteString)};if(r instanceof P){const u=t.databaseId,c=r.firestore._databaseId;if(c.isEqual(u))return{referenceValue:La(r.firestore._databaseId||t.databaseId,r._key.path)};throw t.ha(`Document reference is for database ${c.projectId}/${c.database} but should be for database ${u.projectId}/`+u.database)}throw t.ha("Unsupported field value: "+Xh(r))}function rd(e,n){const r={};return ps(e)?n.path&&0<n.path.length&&n.fieldMask.push(n.path):ms(e,(e,t)=>{t=nd(t,n.ra(e));null!=t&&(r[e]=t)}),{mapValue:{fields:r}}}function sd(e){return!("object"!=typeof e||null===e||e instanceof Array||e instanceof Date||e instanceof h||e instanceof Pl||e instanceof Ol||e instanceof P||e instanceof Fl)}function id(e,t,n){var r;if(!sd(n)||"object"!=typeof(r=n)||null===r||Object.getPrototypeOf(r)!==Object.prototype&&null!==Object.getPrototypeOf(r))throw"an object"===(r=Xh(n))?t.ha(e+" a custom object"):t.ha(e+" "+r)}function ad(e,t,n){if((t=v(t))instanceof Vl)return t._internalPath;if("string"==typeof t)return ud(e,t);throw cd("Field path arguments must be of type string or ",e,!1,void 0,n)}const od=new RegExp("[~\\*/\\[\\]]");function ud(t,n,r){if(0<=n.search(od))throw cd(`Invalid field path (${n}). Paths must not contain '~', '*', '/', '[', or ']'`,t,!1,void 0,r);try{return new Vl(...n.split("."))._internalPath}catch(e){throw cd(`Invalid field path (${n}). Paths must not be empty, begin with '.', end with '.', or contain '..'`,t,!1,void 0,r)}}function cd(e,t,n,r,s){var i=r&&!r.isEmpty(),a=void 0!==s;let o=`Function ${t}() called with invalid data`,u=(n&&(o+=" (via `toFirestore()`)"),o+=". ","");return(i||a)&&(u+=" (found",i&&(u+=" in field "+r),a&&(u+=" in document "+s),u+=")"),new b(I.INVALID_ARGUMENT,o+e+u)}function hd(e,t){return e.some(e=>e.isEqual(t))}class ld{constructor(e,t,n,r,s){this._firestore=e,this._userDataWriter=t,this._key=n,this._document=r,this._converter=s}get id(){return this._key.path.lastSegment()}get ref(){return new P(this._firestore,this._converter,this._key)}exists(){return null!==this._document}data(){var e;if(this._document)return this._converter?(e=new dd(this._firestore,this._userDataWriter,this._key,this._document,null),this._converter.fromFirestore(e)):this._userDataWriter.convertValue(this._document.data.value)}get(e){if(this._document){e=this._document.data.field(fd("DocumentSnapshot.get",e));if(null!==e)return this._userDataWriter.convertValue(e)}}}class dd extends ld{data(){return super.data()}}function fd(e,t){return"string"==typeof t?ud(e,t):(t instanceof Vl?t:t._delegate)._internalPath}function gd(e){if("L"===e.limitType&&0===e.explicitOrderBy.length)throw new b(I.UNIMPLEMENTED,"limitToLast() queries require specifying at least one orderBy() clause")}class md{}function pd(e,...t){for(const n of t)e=n._apply(e);return e}class yd extends md{constructor(e,t,n){super(),this.ma=e,this.ga=t,this.ya=n,this.type="where"}_apply(e){var t=Ql(e.firestore),t=function(e,t,n,r,s,i,a){let o;if(s.isKeyField()){if("array-contains"===i||"array-contains-any"===i)throw new b(I.INVALID_ARGUMENT,`Invalid Query. You can't perform '${i}' queries on documentId().`);if("in"===i||"not-in"===i){Sd(a,i);const t=[];for(const n of a)t.push(Td(r,e,n));o={arrayValue:{values:t}}}else o=Td(r,e,a)}else"in"!==i&&"not-in"!==i&&"array-contains-any"!==i||Sd(a,i),o=td(n,t,a,"in"===i||"not-in"===i);n=ii.create(s,i,o);{t=e;var u=n;if(u.dt()){const c=Ti(t);if(null!==c&&!c.isEqual(u.field))throw new b(I.INVALID_ARGUMENT,`Invalid query. All where filters with an inequality (<, <=, !=, not-in, >, or >=) must be on the same field. But you have inequality filters on '${c.toString()}' and '${u.field.toString()}'`);a=Ei(t);null!==a&&_d(0,u.field,a)}const c=function(e,t){for(const n of e.filters)if(0<=t.indexOf(n.op))return n.op;return null}(t,function(){switch(u.op){case"!=":return["!=","not-in"];case"array-contains":return["array-contains","array-contains-any","not-in"];case"in":return["array-contains-any","in","not-in"];case"array-contains-any":return["array-contains","array-contains-any","in","not-in"];case"not-in":return["array-contains","array-contains-any","in","not-in","!="];default:return[]}}());if(null!==c)throw c===u.op?new b(I.INVALID_ARGUMENT,`Invalid query. You cannot use more than one '${u.op.toString()}' filter.`):new b(I.INVALID_ARGUMENT,`Invalid query. You cannot use '${u.op.toString()}' filters with '${c.toString()}' filters.`)}return n}(e._query,"where",t,e.firestore._databaseId,this.ma,this.ga,this.ya);return new nl(e.firestore,e.converter,(t=(e=e._query).filters.concat([t]),new vi(e.path,e.collectionGroup,e.explicitOrderBy.slice(),t,e.limit,e.limitType,e.startAt,e.endAt)))}}class vd extends md{constructor(e,t){super(),this.ma=e,this.pa=t,this.type="orderBy"}_apply(e){var t=function(e,t,n){if(null!==e.startAt)throw new b(I.INVALID_ARGUMENT,"Invalid query. You must not call startAt() or startAfter() before calling orderBy().");if(null!==e.endAt)throw new b(I.INVALID_ARGUMENT,"Invalid query. You must not call endAt() or endBefore() before calling orderBy().");t=new mi(t,n);return n=t,null===Ei(e)&&null!==(e=Ti(e))&&_d(0,e,n.field),t}(e._query,this.ma,this.pa);return new nl(e.firestore,e.converter,(t=(e=e._query).explicitOrderBy.concat([t]),new vi(e.path,e.collectionGroup,t,e.filters.slice(),e.limit,e.limitType,e.startAt,e.endAt)))}}class wd extends md{constructor(e,t,n){super(),this.type=e,this.Ia=t,this.Ta=n}_apply(e){return new nl(e.firestore,e.converter,Di(e._query,this.Ia,this.Ta))}}class Id extends md{constructor(e,t,n){super(),this.type=e,this.Ea=t,this.Aa=n}_apply(e){var t,n=Ed(e,this.type,this.Ea,this.Aa);return new nl(e.firestore,e.converter,(t=e._query,e=n,new vi(t.path,t.collectionGroup,t.explicitOrderBy.slice(),t.filters.slice(),t.limit,t.limitType,e,t.endAt)))}}class bd extends md{constructor(e,t,n){super(),this.type=e,this.Ea=t,this.Aa=n}_apply(e){var t,n=Ed(e,this.type,this.Ea,this.Aa);return new nl(e.firestore,e.converter,(t=e._query,e=n,new vi(t.path,t.collectionGroup,t.explicitOrderBy.slice(),t.filters.slice(),t.limit,t.limitType,t.startAt,e)))}}function Ed(e,t,n,r){if(n[0]=v(n[0]),n[0]instanceof ld){var s=e._query,i=e.firestore._databaseId,a=t,o=n[0]._document,u=r;if(!o)throw new b(I.NOT_FOUND,`Can't use a DocumentSnapshot that doesn't exist for ${a}().`);const g=[];for(const a of _i(s))if(a.field.isKeyField())g.push(Us(i,o.key));else{const s=o.data.field(a.field);if(_s(s))throw new b(I.INVALID_ARGUMENT,'Invalid query. You are trying to start or end a query using a document for which the field "'+a.field+'" is an uncommitted server timestamp. (Since the value of this field is unknown, you cannot start/end a query with it.)');if(null===s){const s=a.field.canonicalString();throw new b(I.INVALID_ARGUMENT,`Invalid query. You are trying to start or end a query using a document for which the field '${s}' (used as the orderBy) does not exist.`)}g.push(s)}return new gi(g,u)}a=Ql(e.firestore);{var c=e._query,h=e.firestore._databaseId,l=a,d=t,f=n,s=r;const m=c.explicitOrderBy;if(f.length>m.length)throw new b(I.INVALID_ARGUMENT,`Too many arguments provided to ${d}(). The number of arguments must be less than or equal to the number of orderBy() clauses`);const p=[];for(let e=0;e<f.length;e++){const y=f[e];if(m[e].field.isKeyField()){if("string"!=typeof y)throw new b(I.INVALID_ARGUMENT,`Invalid query. Expected a string for document ID in ${d}(), but got a `+typeof y);if(!Si(c)&&-1!==y.indexOf("/"))throw new b(I.INVALID_ARGUMENT,`Invalid query. When querying a collection and ordering by documentId(), the value passed to ${d}() must be a plain document ID, but '${y}' contains a slash.`);const l=c.path.child(_.fromString(y));if(!D.isDocumentKey(l))throw new b(I.INVALID_ARGUMENT,`Invalid query. When querying a collection group and ordering by documentId(), the value passed to ${d}() must result in a valid document path, but '${l}' is not because it contains an odd number of segments.`);const f=new D(l);p.push(Us(h,f))}else{const c=td(l,d,y);p.push(c)}}return new gi(p,s)}}function Td(e,t,n){if("string"==typeof(n=v(n))){if(""===n)throw new b(I.INVALID_ARGUMENT,"Invalid query. When querying with documentId(), you must provide a valid document ID, but it was an empty string.");if(!Si(t)&&-1!==n.indexOf("/"))throw new b(I.INVALID_ARGUMENT,`Invalid query. When querying a collection by documentId(), you must provide a plain document ID, but '${n}' contains a '/' character.`);t=t.path.child(_.fromString(n));if(D.isDocumentKey(t))return Us(e,new D(t));throw new b(I.INVALID_ARGUMENT,`Invalid query. When querying a collection group by documentId(), the value provided must result in a valid document path, but '${t}' is not because it has an odd number of segments (${t.length}).`)}if(n instanceof P)return Us(e,n._key);throw new b(I.INVALID_ARGUMENT,`Invalid query. When querying with documentId(), you must provide a valid string or a DocumentReference, but it was: ${Xh(n)}.`)}function Sd(e,t){if(!Array.isArray(e)||0===e.length)throw new b(I.INVALID_ARGUMENT,`Invalid Query. A non-empty array is required for '${t.toString()}' filters.`);if(10<e.length)throw new b(I.INVALID_ARGUMENT,`Invalid Query. '${t.toString()}' filters support a maximum of 10 elements in the value array.`)}function _d(e,t,n){if(!n.isEqual(t))throw new b(I.INVALID_ARGUMENT,`Invalid query. You have a where filter with an inequality (<, <=, !=, not-in, >, or >=) on field '${t.toString()}' and so you must also use '${t.toString()}' as your first argument to orderBy(), but your first orderBy() is on field '${n.toString()}' instead.`)}class xd{convertValue(e,t="none"){switch(Ms(e)){case 0:return null;case 1:return e.booleanValue;case 2:return R(e.integerValue||e.doubleValue);case 3:return this.convertTimestamp(e.timestampValue);case 4:return this.convertServerTimestamp(e,t);case 5:return e.stringValue;case 6:return this.convertBytes(Ss(e.bytesValue));case 7:return this.convertReference(e.referenceValue);case 8:return this.convertGeoPoint(e.geoPointValue);case 9:return this.convertArray(e.arrayValue,t);case 10:return this.convertObject(e.mapValue,t);default:throw E()}}convertObject(e,n){const r={};return ms(e.fields,(e,t)=>{r[e]=this.convertValue(t,n)}),r}convertGeoPoint(e){return new Pl(R(e.latitude),R(e.longitude))}convertArray(e,t){return(e.values||[]).map(e=>this.convertValue(e,t))}convertServerTimestamp(e,t){switch(t){case"previous":var n=function e(t){t=t.mapValue.fields.__previous_value__;return _s(t)?e(t):t}(e);return null==n?null:this.convertValue(n,t);case"estimate":return this.convertTimestamp(xs(e));default:return null}}convertTimestamp(e){e=Ts(e);return new h(e.seconds,e.nanos)}convertDocumentKey(e,t){const n=_.fromString(e),r=(y(Ya(n)),new As(n.get(1),n.get(3))),s=new D(n.popFirst(5));return r.isEqual(t)||g(`Document ${s} contains a document reference within a different database (${r.projectId}/${r.database}) which is not supported. It will be treated as a reference in the current database (${t.projectId}/${t.database}) instead.`),s}}function Dd(e,t,n){return e?n&&(n.merge||n.mergeFields)?e.toFirestore(t,n):e.toFirestore(t):t}class Ad extends xd{constructor(e){super(),this.firestore=e}convertBytes(e){return new Ol(e)}convertReference(e){e=this.convertDocumentKey(e,this.firestore._databaseId);return new P(this.firestore,null,e)}}class Cd{constructor(e,t){this.hasPendingWrites=e,this.fromCache=t}isEqual(e){return this.hasPendingWrites===e.hasPendingWrites&&this.fromCache===e.fromCache}}class Nd extends ld{constructor(e,t,n,r,s,i){super(e,t,n,r,i),this._firestore=e,this._firestoreImpl=e,this.metadata=s}exists(){return super.exists()}data(e={}){var t;if(this._document)return this._converter?(t=new kd(this._firestore,this._userDataWriter,this._key,this._document,this.metadata,null),this._converter.fromFirestore(t,e)):this._userDataWriter.convertValue(this._document.data.value,e.serverTimestamps)}get(e,t={}){if(this._document){e=this._document.data.field(fd("DocumentSnapshot.get",e));if(null!==e)return this._userDataWriter.convertValue(e,t.serverTimestamps)}}}class kd extends Nd{data(e={}){return super.data(e)}}class Rd{constructor(e,t,n,r){this._firestore=e,this._userDataWriter=t,this._snapshot=r,this.metadata=new Cd(r.hasPendingWrites,r.fromCache),this.query=n}get docs(){const t=[];return this.forEach(e=>t.push(e)),t}get size(){return this._snapshot.docs.size}get empty(){return 0===this.size}forEach(t,n){this._snapshot.docs.forEach(e=>{t.call(n,new kd(this._firestore,this._userDataWriter,e.key,e,new Cd(this._snapshot.mutatedKeys.has(e.key),this._snapshot.fromCache),this.query.converter))})}docChanges(e={}){e=!!e.includeMetadataChanges;if(e&&this._snapshot.excludesMetadataChanges)throw new b(I.INVALID_ARGUMENT,"To include metadata changes with your document changes, you must also pass { includeMetadataChanges:true } to onSnapshot().");return this._cachedChanges&&this._cachedChangesIncludeMetadataChanges===e||(this._cachedChanges=function(i,t){if(i._snapshot.oldDocs.isEmpty()){let n=0;return i._snapshot.docChanges.map(e=>{var t=new kd(i._firestore,i._userDataWriter,e.doc.key,e.doc,new Cd(i._snapshot.mutatedKeys.has(e.doc.key),i._snapshot.fromCache),i.query.converter);return e.doc,{type:"added",doc:t,oldIndex:-1,newIndex:n++}})}{let s=i._snapshot.oldDocs;return i._snapshot.docChanges.filter(e=>t||3!==e.type).map(e=>{var t=new kd(i._firestore,i._userDataWriter,e.doc.key,e.doc,new Cd(i._snapshot.mutatedKeys.has(e.doc.key),i._snapshot.fromCache),i.query.converter);let n=-1,r=-1;return 0!==e.type&&(n=s.indexOf(e.doc.key),s=s.delete(e.doc.key)),1!==e.type&&(s=s.add(e.doc),r=s.indexOf(e.doc.key)),{type:function(){switch(e.type){case 0:return"added";case 2:case 3:return"modified";case 1:return"removed";default:return E()}}(),doc:t,oldIndex:n,newIndex:r}})}}(this,e),this._cachedChangesIncludeMetadataChanges=e),this._cachedChanges}}function Ld(e,t){return e instanceof Nd&&t instanceof Nd?e._firestore===t._firestore&&e._key.isEqual(t._key)&&(null===e._document?null===t._document:e._document.isEqual(t._document))&&e._converter===t._converter:e instanceof Rd&&t instanceof Rd&&e._firestore===t._firestore&&ol(e.query,t.query)&&e.metadata.isEqual(t.metadata)&&e._snapshot.isEqual(t._snapshot)}class Md extends xd{constructor(e){super(),this.firestore=e}convertBytes(e){return new Ol(e)}convertReference(e){e=this.convertDocumentKey(e,this.firestore._databaseId);return new P(this.firestore,null,e)}}function Od(e,t,n){e=F(e,P);var r=F(e.firestore,B),t=Dd(e.converter,t,n);return Bd(r,[zl(Ql(r),"setDoc",e._key,t,null!==e.converter,n).toMutation(e._key,M.none())])}function Vd(e,t,n,...r){e=F(e,P);var s=F(e.firestore,B),i=Ql(s);let a;return Bd(s,[(a="string"==typeof(t=v(t))||t instanceof Vl?ed(i,"updateDoc",e._key,t,n,r):Zl(i,"updateDoc",e._key,t)).toMutation(e._key,M.exists(!0))])}function Fd(t,...n){t=v(t);let e={includeMetadataChanges:!1},r=0;"object"!=typeof n[r]||Dl(n[r])||(e=n[r],r++);var s={includeMetadataChanges:e.includeMetadataChanges};if(Dl(n[r])){const t=n[r];n[r]=null==(c=t.next)?void 0:c.bind(t),n[r+1]=null==(c=t.error)?void 0:c.bind(t),n[r+2]=null==(c=t.complete)?void 0:c.bind(t)}let i,a,o;if(t instanceof P)a=F(t.firestore,B),o=Ii(t._key.path),i={next:e=>{n[r]&&n[r](Ud(a,t,e))},error:n[r+1],complete:n[r+2]};else{const l=F(t,nl),d=(a=F(l.firestore,B),o=l._query,new Md(a));i={next:e=>{n[r]&&n[r](new Rd(a,d,l,e))},error:n[r+1],complete:n[r+2]},gd(t._query)}{var u=Cl(a),c=o,h=i;const f=new cl(h),g=new vh(c,f,s);return u.asyncQueue.enqueueAndForget(async()=>mh(await El(u),g)),()=>{f.bc(),u.asyncQueue.enqueueAndForget(async()=>ph(await El(u),g))}}}function Pd(e,t){{var n=Cl(e=F(e,B));e=Dl(t)?t:{next:t};const r=new cl(e);return n.asyncQueue.enqueueAndForget(async()=>{var e=await El(n),t=r;e.Ru.add(t),t.next()}),()=>{r.bc(),n.asyncQueue.enqueueAndForget(async()=>{var e=await El(n),t=r;e.Ru.delete(t)})}}}function Bd(e,t){{var n=Cl(e),r=t;const s=new m;return n.asyncQueue.enqueueAndForget(async()=>async function(t,e,n){const r=Kh(t);try{const t=await function(e,s){const i=e,a=h.now(),o=s.reduce((e,t)=>e.add(t.key),O());let u,c;return i.persistence.runTransaction("Locally write mutations","readwrite",n=>{let t=la,r=O();return i.Gi.getEntries(n,o).next(e=>{(t=e).forEach((e,t)=>{t.isValidDocument()||(r=r.add(e))})}).next(()=>i.localDocuments.getOverlayedDocuments(n,t)).next(e=>{u=e;const t=[];for(const n of s){const s=function(e,t){let n=null;for(const r of e.fieldTransforms){const e=t.data.field(r.field),s=Pi(r.transform,e||null);null!=s&&(n=null===n?Ys.empty():n).set(r.field,s)}return n||null}(n,u.get(n.key).overlayedDocument);null!=s&&t.push(new ta(n.key,s,function r(e){const s=[];return ms(e.fields,(e,t)=>{const n=new x([e]);if(Qs(t)){const e=r(t.mapValue).fields;if(0===e.length)s.push(n);else for(const t of e)s.push(n.child(t))}else s.push(n)}),new bs(s)}(s.value.mapValue),M.exists(!0)))}return i.mutationQueue.addMutationBatch(n,a,t,s)}).next(e=>{var t=(c=e).applyToLocalDocumentSet(u,r);return i.documentOverlayCache.saveOverlays(n,e.batchId,t)})}).then(()=>({batchId:c.batchId,changes:ga(u)}))}(r.localStore,e);r.sharedClientState.addPendingMutation(t.batchId);{var s=r;var i=t.batchId;var a=n;let e=s.hc[s.currentUser.toKey()];e=(e=e||new C(T)).insert(i,a),s.hc[s.currentUser.toKey()]=e}await Ph(r,t.changes),await th(r.remoteStore)}catch(t){const e=ch(t,"Failed to persist write");n.reject(e)}}(await bl(n),r,s)),s.promise}}function Ud(e,t,n){var r=n.docs.get(t._key),s=new Md(e);return new Nd(e,s,t._key,r,new Cd(n.hasPendingWrites,n.fromCache),t.converter)}const qd={maxAttempts:5};class Kd{constructor(e,t){this._firestore=e,this._commitHandler=t,this._mutations=[],this._committed=!1,this._dataReader=Ql(e)}set(e,t,n){this._verifyNotCommitted();const r=Gd(e,this._firestore),s=Dd(r.converter,t,n),i=zl(this._dataReader,"WriteBatch.set",r._key,s,null!==r.converter,n);return this._mutations.push(i.toMutation(r._key,M.none())),this}update(e,t,n,...r){this._verifyNotCommitted();e=Gd(e,this._firestore);let s;return s="string"==typeof(t=v(t))||t instanceof Vl?ed(this._dataReader,"WriteBatch.update",e._key,t,n,r):Zl(this._dataReader,"WriteBatch.update",e._key,t),this._mutations.push(s.toMutation(e._key,M.exists(!0))),this}delete(e){this._verifyNotCommitted();e=Gd(e,this._firestore);return this._mutations=this._mutations.concat(new ia(e._key,M.none())),this}commit(){return this._verifyNotCommitted(),this._committed=!0,0<this._mutations.length?this._commitHandler(this._mutations):Promise.resolve()}_verifyNotCommitted(){if(this._committed)throw new b(I.FAILED_PRECONDITION,"A write batch can no longer be used after commit() has been called.")}}function Gd(e,t){if((e=v(e)).firestore!==t)throw new b(I.INVALID_ARGUMENT,"Provided document reference is from a different Firestore instance.");return e}class jd extends class{constructor(e,t){this._firestore=e,this._transaction=t,this._dataReader=Ql(e)}get(e){const n=Gd(e,this._firestore),r=new Ad(this._firestore);return this._transaction.lookup([n._key]).then(e=>{if(!e||1!==e.length)return E();const t=e[0];if(t.isFoundDocument())return new ld(this._firestore,r,t.key,t,n.converter);if(t.isNoDocument())return new ld(this._firestore,r,n._key,null,n.converter);throw E()})}set(e,t,n){e=Gd(e,this._firestore),t=Dd(e.converter,t,n),t=zl(this._dataReader,"Transaction.set",e._key,t,null!==e.converter,n);return this._transaction.set(e._key,t),this}update(e,t,n,...r){e=Gd(e,this._firestore),n="string"==typeof(t=v(t))||t instanceof Vl?ed(this._dataReader,"Transaction.update",e._key,t,n,r):Zl(this._dataReader,"Transaction.update",e._key,t);return this._transaction.update(e._key,n),this}delete(e){e=Gd(e,this._firestore);return this._transaction.delete(e._key),this}}{constructor(e,t){super(e,t),this._firestore=e}get(e){const t=Gd(e,this._firestore),n=new Md(this._firestore);return super.get(e).then(e=>new Nd(this._firestore,n,t._key,e._document,new Cd(!1,!1),t.converter))}}function Qd(e,t){if(void 0===t)return{merge:!1};if(void 0!==t.mergeFields&&void 0!==t.merge)throw new b("invalid-argument",`Invalid options passed to function ${e}(): You cannot `+'specify both "merge" and "mergeFields".');return t}function zd(){if("undefined"==typeof Uint8Array)throw new b("unimplemented","Uint8Arrays are not available in this environment.")}function Hd(){if("undefined"==typeof atob)throw new b("unimplemented","Blobs are unavailable in Firestore in this environment.")}vr=vf.SDK_VERSION,xr=vr,vf._registerComponent(new j("firestore",(e,{instanceIdentifier:t,options:n})=>{const r=e.getProvider("app").getImmediate(),s=new B(new Mr(e.getProvider("auth-internal")),new Pr(e.getProvider("app-check-internal")),function(e,t){if(Object.prototype.hasOwnProperty.apply(e.options,["projectId"]))return new As(e.options.projectId,t);throw new b(I.INVALID_ARGUMENT,'"projectId" not provided in firebase.initializeApp.')}(r,t),r);return n=Object.assign({useFetchStreams:!0},n),s._setSettings(n),s},"PUBLIC").setMultipleInstances(!0)),vf.registerVersion(Se,"3.7.3",void 0),vf.registerVersion(Se,"3.7.3","esm2017");class Wd{constructor(e){this._delegate=e}static fromBase64String(e){return Hd(),new Wd(Ol.fromBase64String(e))}static fromUint8Array(e){return zd(),new Wd(Ol.fromUint8Array(e))}toBase64(){return Hd(),this._delegate.toBase64()}toUint8Array(){return zd(),this._delegate.toUint8Array()}isEqual(e){return this._delegate.isEqual(e._delegate)}toString(){return"Blob(base64: "+this.toBase64()+")"}}function $d(e){if("object"==typeof e&&null!==e){var t=e;for(const n of["next","error","complete"])if(n in t&&"function"==typeof t[n])return 1}}class Yd{enableIndexedDbPersistence(e,t){return e=e._delegate,t={forceOwnership:t},Ml(e=F(e,B)),n=Cl(e),e=e._freezeSettings(),r=new zh,kl(n,r,new jh(r,e.cacheSizeBytes,null==t?void 0:t.forceOwnership));var n,r}enableMultiTabIndexedDbPersistence(e){return Ml(e=F(e=e._delegate,B)),t=Cl(e),e=e._freezeSettings(),n=new zh,kl(t,n,new Qh(n,e.cacheSizeBytes));var t,n}clearIndexedDbPersistence(e){{var t=e._delegate;if(t._initialized&&!t._terminated)throw new b(I.FAILED_PRECONDITION,"Persistence can only be cleared before a Firestore instance is initialized or after it is terminated.");const n=new m;return t._queue.enqueueAndForgetEvenWhileRestricted(async()=>{try{await async function(e){if(!rs.C())return Promise.resolve();e+="main";await rs.delete(e)}(sc(t._databaseId,t._persistenceKey)),n.resolve()}catch(e){n.reject(e)}}),n.promise}}}class Xd{constructor(e,t,n){this._delegate=t,this._persistenceProvider=n,this.INTERNAL={delete:()=>this.terminate()},e instanceof As||(this._appCompat=e)}get _databaseId(){return this._delegate._databaseId}settings(e){var t=this._delegate._getSettings();e.merge||t.host===e.host||Cr("You are overriding the original host. If you did not intend to override your settings, use {merge: true}."),e.merge&&delete(e=Object.assign(Object.assign({},t),e)).merge,this._delegate._setSettings(e)}useEmulator(n,r,e={}){{var[n,r,e,s={}]=[this._delegate,n,r,e];const i=(n=F(n,tl))._getSettings();if("firestore.googleapis.com"!==i.host&&i.host!==r&&Cr("Host has been set in both settings() and useEmulator(), emulator host will be used"),n._setSettings(Object.assign(Object.assign({},i),{host:r+":"+e,ssl:!1})),s.mockUserToken){let e,t;if("string"==typeof s.mockUserToken)e=s.mockUserToken,t=o.MOCK_USER;else{e=function(e,t){if(e.uid)throw new Error('The "uid" field is no longer supported by mockUserToken. Please use "sub" instead for Firebase Auth User ID.');var t=t||"demo-project",n=e.iat||0,r=e.sub||e.user_id;if(r)return r=Object.assign({iss:"https://securetoken.google.com/"+t,aud:t,iat:n,exp:n+3600,auth_time:n,sub:r,user_id:r,firebase:{sign_in_provider:"custom",identities:{}}},e),[u(JSON.stringify({alg:"none",type:"JWT"})),u(JSON.stringify(r)),""].join(".");throw new Error("mockUserToken must contain 'sub' or 'user_id' field!")}(s.mockUserToken,null==(r=n._app)?void 0:r.options.projectId);const i=s.mockUserToken.sub||s.mockUserToken.user_id;if(!i)throw new b(I.INVALID_ARGUMENT,"mockUserToken must contain 'sub' or 'user_id' field!");t=new o(i)}n._authCredentials=new Lr(new kr(e,t))}return}}enableNetwork(){return Rl(this._delegate)}disableNetwork(){return e=this._delegate,(n=Cl(e=F(e,B))).asyncQueue.enqueue(async()=>{const e=await vl(n),t=await Il(n);return e.setNetworkEnabled(!1),async function(){const e=t;e._u.add(0),await jc(e),e.gu.set("Offline")}()});var e,n}enablePersistence(e){let t=!1,n=!1;return e&&(t=!!e.synchronizeTabs,n=!!e.experimentalForceOwningTab,Wh("synchronizeTabs",t,"experimentalForceOwningTab",n)),t?this._persistenceProvider.enableMultiTabIndexedDbPersistence(this):this._persistenceProvider.enableIndexedDbPersistence(this,n)}clearPersistence(){return this._persistenceProvider.clearIndexedDbPersistence(this)}terminate(){return this._appCompat&&(this._appCompat._removeServiceInstance("firestore-compat"),this._appCompat._removeServiceInstance("firestore")),this._delegate._delete()}waitForPendingWrites(){var e=this._delegate;{var t=Cl(e=F(e,B));const n=new m;return t.asyncQueue.enqueueAndForget(async()=>async function(e,t){const n=e;Xc(n.remoteStore)||f("SyncEngine","The network is disabled. The task returned by 'awaitPendingWrites()' will not complete until the network is enabled.");try{const e=await function(){const t=n.localStore;return t.persistence.runTransaction("Get highest unacknowledged batch id","readonly",e=>t.mutationQueue.getHighestUnacknowledgedBatchId(e))}();if(-1===e)return void t.resolve();const r=n.lc.get(e)||[];r.push(t),n.lc.set(e,r)}catch(e){const n=ch(e,"Initialization of waitForPendingWrites() operation failed");t.reject(n)}}(await bl(t),n)),n.promise}}onSnapshotsInSync(e){return Pd(this._delegate,e)}get app(){if(this._appCompat)return this._appCompat;throw new b("failed-precondition","Firestore was not initialized using the Firebase SDK. 'app' is not available")}collection(e){try{return new df(this,sl(this._delegate,e))}catch(e){throw rf(e,"collection()","Firestore.collection()")}}doc(e){try{return new nf(this,il(this._delegate,e))}catch(e){throw rf(e,"doc()","Firestore.doc()")}}collectionGroup(e){try{return new cf(this,function(e,t){if(e=F(e,tl),Hh("collectionGroup","collection id",t),0<=t.indexOf("/"))throw new b(I.INVALID_ARGUMENT,`Invalid collection ID '${t}' passed to function collectionGroup(). Collection IDs must not contain '/'.`);return new nl(e,null,new vi(_.emptyPath(),t))}(this._delegate,e))}catch(e){throw rf(e,"collectionGroup()","Firestore.collectionGroup()")}}runTransaction(t){var n=this._delegate,r=e=>t(new Zd(this,e)),e=void 0;if(n=F(n,B),(e=Object.assign(Object.assign({},qd),e)).maxAttempts<1)throw new b(I.INVALID_ARGUMENT,"Max attempts must be at least 1");{var s=Cl(n),i=e=>r(new jd(n,e)),a=e;const o=new m;return s.asyncQueue.enqueueAndForget(async()=>{var e=await yl(s).then(e=>e.datastore);new dl(s.asyncQueue,e,a,i,o).run()}),o.promise}}batch(){return Cl(this._delegate),new ef(new Kd(this._delegate,e=>Bd(this._delegate,e)))}loadBundle(e){return n=Cl(t=F(this._delegate,B)),r=new Al,_l(n,t._databaseId,e,r),r;var t,n,r}namedQuery(e){return Ll(this._delegate,e).then(e=>e?new cf(this,e):null)}}class Jd extends xd{constructor(e){super(),this.firestore=e}convertBytes(e){return new Wd(new Ol(e))}convertReference(e){e=this.convertDocumentKey(e,this.firestore._databaseId);return nf.forKey(e,this.firestore,null)}}class Zd{constructor(e,t){this._firestore=e,this._delegate=t,this._userDataWriter=new Jd(e)}get(e){const t=ff(e);return this._delegate.get(t).then(e=>new of(this._firestore,new Nd(this._firestore._delegate,this._userDataWriter,e._key,e._document,e.metadata,t.converter)))}set(e,t,n){e=ff(e);return n?(Qd("Transaction.set",n),this._delegate.set(e,t,n)):this._delegate.set(e,t),this}update(e,t,n,...r){e=ff(e);return 2===arguments.length?this._delegate.update(e,t):this._delegate.update(e,t,n,...r),this}delete(e){e=ff(e);return this._delegate.delete(e),this}}class ef{constructor(e){this._delegate=e}set(e,t,n){e=ff(e);return n?(Qd("WriteBatch.set",n),this._delegate.set(e,t,n)):this._delegate.set(e,t),this}update(e,t,n,...r){e=ff(e);return 2===arguments.length?this._delegate.update(e,t):this._delegate.update(e,t,n,...r),this}delete(e){e=ff(e);return this._delegate.delete(e),this}commit(){return this._delegate.commit()}}class tf{constructor(e,t,n){this._firestore=e,this._userDataWriter=t,this._delegate=n}fromFirestore(e,t){e=new kd(this._firestore._delegate,this._userDataWriter,e._key,e._document,e.metadata,null);return this._delegate.fromFirestore(new uf(this._firestore,e),null!=t?t:{})}toFirestore(e,t){return t?this._delegate.toFirestore(e,t):this._delegate.toFirestore(e)}static getInstance(e,t){const n=tf.INSTANCES;let r=n.get(e),s=(r||(r=new WeakMap,n.set(e,r)),r.get(t));return s||(s=new tf(e,new Jd(e),t),r.set(t,s)),s}}tf.INSTANCES=new WeakMap;class nf{constructor(e,t){this.firestore=e,this._delegate=t,this._userDataWriter=new Jd(e)}static forPath(e,t,n){if(e.length%2!=0)throw new b("invalid-argument","Invalid document reference. Document references must have an even number of segments, but "+e.canonicalString()+" has "+e.length);return new nf(t,new P(t._delegate,n,new D(e)))}static forKey(e,t,n){return new nf(t,new P(t._delegate,n,e))}get id(){return this._delegate.id}get parent(){return new df(this.firestore,this._delegate.parent)}get path(){return this._delegate.path}collection(e){try{return new df(this.firestore,sl(this._delegate,e))}catch(e){throw rf(e,"collection()","DocumentReference.collection()")}}isEqual(e){return(e=v(e))instanceof P&&al(this._delegate,e)}set(e,t){t=Qd("DocumentReference.set",t);try{return t?Od(this._delegate,e,t):Od(this._delegate,e)}catch(e){throw rf(e,"setDoc()","DocumentReference.set()")}}update(e,t,...n){try{return 1===arguments.length?Vd(this._delegate,e):Vd(this._delegate,e,t,...n)}catch(e){throw rf(e,"updateDoc()","DocumentReference.update()")}}delete(){return Bd(F((e=this._delegate).firestore,B),[new ia(e._key,M.none())]);var e}onSnapshot(...e){var t=sf(e),e=af(e,e=>new of(this.firestore,new Nd(this.firestore._delegate,this._userDataWriter,e._key,e._document,e.metadata,this._delegate.converter)));return Fd(this._delegate,t,e)}get(e){let t;return(t=("cache"===(null==e?void 0:e.source)?function(t){t=F(t,P);const n=F(t.firestore,B),e=Cl(n),r=new Md(n);return function(e,t){const n=new m;return e.asyncQueue.enqueueAndForget(async()=>async function(e,t,n){try{const r=await function(t){const n=e;return n.persistence.runTransaction("read document","readonly",e=>n.localDocuments.getDocument(e,t))}(t);r.isFoundDocument()?n.resolve(r):r.isNoDocument()?n.resolve(null):n.reject(new b(I.UNAVAILABLE,"Failed to get document from cache. (However, this document may exist on the server. Run again without setting 'source' in the GetOptions to attempt to retrieve the document from the server.)"))}catch(e){t=ch(e,`Failed to get document '${t} from cache`);n.reject(t)}}(await wl(e),t,n)),n.promise}(e,t._key).then(e=>new Nd(n,r,t._key,e,new Cd(null!==e&&e.hasLocalMutations,!0),t.converter))}:"server"===(null==e?void 0:e.source)?function(t){t=F(t,P);const n=F(t.firestore,B);return Tl(Cl(n),t._key,{source:"server"}).then(e=>Ud(n,t,e))}:function(t){t=F(t,P);const n=F(t.firestore,B);return Tl(Cl(n),t._key).then(e=>Ud(n,t,e))})(this._delegate)).then(e=>new of(this.firestore,new Nd(this.firestore._delegate,this._userDataWriter,e._key,e._document,e.metadata,this._delegate.converter)))}withConverter(e){return new nf(this.firestore,e?this._delegate.withConverter(tf.getInstance(this.firestore,e)):this._delegate.withConverter(null))}}function rf(e,t,n){return e.message=e.message.replace(t,n),e}function sf(e){for(const t of e)if("object"==typeof t&&!$d(t))return t;return{}}function af(e,t){let n;return{next:e=>{n.next&&n.next(t(e))},error:null==(e=(n=$d(e[0])?e[0]:$d(e[1])?e[1]:"function"==typeof e[0]?{next:e[0],error:e[1],complete:e[2]}:{next:e[1],error:e[2],complete:e[3]}).error)?void 0:e.bind(n),complete:null==(e=n.complete)?void 0:e.bind(n)}}class of{constructor(e,t){this._firestore=e,this._delegate=t}get ref(){return new nf(this._firestore,this._delegate.ref)}get id(){return this._delegate.id}get metadata(){return this._delegate.metadata}get exists(){return this._delegate.exists()}data(e){return this._delegate.data(e)}get(e,t){return this._delegate.get(e,t)}isEqual(e){return Ld(this._delegate,e._delegate)}}class uf extends of{data(e){e=this._delegate.data(e);return void 0===e&&E(),e}}class cf{constructor(e,t){this.firestore=e,this._delegate=t,this._userDataWriter=new Jd(e)}where(e,t,n){try{return new cf(this.firestore,pd(this._delegate,(r=n,s=t,i=fd("where",e),new yd(i,s,r))))}catch(e){throw rf(e,/(orderBy|where)\(\)/,"Query.$1()")}var r,s,i}orderBy(e,t){try{return new cf(this.firestore,pd(this._delegate,([n,r="asc"]=[e,t],s=r,i=fd("orderBy",n),new vd(i,s))))}catch(e){throw rf(e,/(orderBy|where)\(\)/,"Query.$1()")}var n,r,s,i}limit(e){try{return new cf(this.firestore,pd(this._delegate,(Jh("limit",t=e),new wd("limit",t,"F"))))}catch(e){throw rf(e,"limit()","Query.limit()")}var t}limitToLast(e){try{return new cf(this.firestore,pd(this._delegate,(Jh("limitToLast",t=e),new wd("limitToLast",t,"L"))))}catch(e){throw rf(e,"limitToLast()","Query.limitToLast()")}var t}startAt(...e){try{return new cf(this.firestore,pd(this._delegate,([...t]=[...e],new Id("startAt",t,!0))))}catch(e){throw rf(e,"startAt()","Query.startAt()")}var t}startAfter(...e){try{return new cf(this.firestore,pd(this._delegate,([...t]=[...e],new Id("startAfter",t,!1))))}catch(e){throw rf(e,"startAfter()","Query.startAfter()")}var t}endBefore(...e){try{return new cf(this.firestore,pd(this._delegate,([...t]=[...e],new bd("endBefore",t,!1))))}catch(e){throw rf(e,"endBefore()","Query.endBefore()")}var t}endAt(...e){try{return new cf(this.firestore,pd(this._delegate,([...t]=[...e],new bd("endAt",t,!0))))}catch(e){throw rf(e,"endAt()","Query.endAt()")}var t}isEqual(e){return ol(this._delegate,e._delegate)}get(e){let t;return(t=("cache"===(null==e?void 0:e.source)?function(t){t=F(t,nl);const n=F(t.firestore,B),e=Cl(n),r=new Md(n);return function(e,t){const n=new m;return e.asyncQueue.enqueueAndForget(async()=>async function(e,t,n){try{const r=await gc(e,t,!0),s=new _h(t,r.Hi),i=s.Wu(r.documents),a=s.applyChanges(i,!1);n.resolve(a.snapshot)}catch(e){t=ch(e,`Failed to execute query '${t} against cache`);n.reject(t)}}(await wl(e),t,n)),n.promise}(e,t._query).then(e=>new Rd(n,r,t,e))}:"server"===(null==e?void 0:e.source)?function(t){t=F(t,nl);const n=F(t.firestore,B),e=Cl(n),r=new Md(n);return Sl(e,t._query,{source:"server"}).then(e=>new Rd(n,r,t,e))}:function(t){t=F(t,nl);const n=F(t.firestore,B),e=Cl(n),r=new Md(n);return gd(t._query),Sl(e,t._query).then(e=>new Rd(n,r,t,e))})(this._delegate)).then(e=>new lf(this.firestore,new Rd(this.firestore._delegate,this._userDataWriter,this._delegate,e._snapshot)))}onSnapshot(...e){var t=sf(e),e=af(e,e=>new lf(this.firestore,new Rd(this.firestore._delegate,this._userDataWriter,this._delegate,e._snapshot)));return Fd(this._delegate,t,e)}withConverter(e){return new cf(this.firestore,e?this._delegate.withConverter(tf.getInstance(this.firestore,e)):this._delegate.withConverter(null))}}class hf{constructor(e,t){this._firestore=e,this._delegate=t}get type(){return this._delegate.type}get doc(){return new uf(this._firestore,this._delegate.doc)}get oldIndex(){return this._delegate.oldIndex}get newIndex(){return this._delegate.newIndex}}class lf{constructor(e,t){this._firestore=e,this._delegate=t}get query(){return new cf(this._firestore,this._delegate.query)}get metadata(){return this._delegate.metadata}get size(){return this._delegate.size}get empty(){return this._delegate.empty}get docs(){return this._delegate.docs.map(e=>new uf(this._firestore,e))}docChanges(e){return this._delegate.docChanges(e).map(e=>new hf(this._firestore,e))}forEach(t,n){this._delegate.forEach(e=>{t.call(n,new uf(this._firestore,e))})}isEqual(e){return Ld(this._delegate,e._delegate)}}class df extends cf{constructor(e,t){super(e,t),this.firestore=e,this._delegate=t}get id(){return this._delegate.id}get path(){return this._delegate.path}get parent(){var e=this._delegate.parent;return e?new nf(this.firestore,e):null}doc(e){try{return void 0===e?new nf(this.firestore,il(this._delegate)):new nf(this.firestore,il(this._delegate,e))}catch(e){throw rf(e,"doc()","CollectionReference.doc()")}}add(e){return function(e,t){const n=F(e.firestore,B),r=il(e),s=Dd(e.converter,t);return Bd(n,[zl(Ql(e.firestore),"addDoc",r._key,s,null!==e.converter,{}).toMutation(r._key,M.exists(!1))]).then(()=>r)}(this._delegate,e).then(e=>new nf(this.firestore,e))}isEqual(e){return al(this._delegate,e._delegate)}withConverter(e){return new df(this.firestore,e?this._delegate.withConverter(tf.getInstance(this.firestore,e)):this._delegate.withConverter(null))}}function ff(e){return F(e,P)}var Te={Firestore:Xd,GeoPoint:Pl,Timestamp:h,Blob:Wd,Transaction:Zd,WriteBatch:ef,DocumentReference:nf,DocumentSnapshot:of,Query:cf,QueryDocumentSnapshot:uf,QuerySnapshot:lf,CollectionReference:df,FieldPath:class mf{constructor(...e){this._delegate=new Vl(...e)}static documentId(){return new mf(x.keyField().canonicalString())}isEqual(e){return(e=v(e))instanceof Vl&&this._delegate._internalPath.isEqual(e._internalPath)}},FieldValue:class pf{constructor(e){this._delegate=e}static serverTimestamp(){const e=new $l("serverTimestamp");return e._methodName="FieldValue.serverTimestamp",new pf(e)}static delete(){const e=new Hl("deleteField");return e._methodName="FieldValue.delete",new pf(e)}static arrayUnion(...e){[...e]=[...e];const t=new Yl("arrayUnion",e);return t._methodName="FieldValue.arrayUnion",new pf(t)}static arrayRemove(...e){[...e]=[...e];const t=new Xl("arrayRemove",e);return t._methodName="FieldValue.arrayRemove",new pf(t)}static increment(e){const t=new Jl("increment",e);return t._methodName="FieldValue.increment",new pf(t)}isEqual(e){return this._delegate.isEqual(e._delegate)}},setLogLevel:function(e){Dr.setLogLevel(e)},CACHE_SIZE_UNLIMITED:-1},e=t.default,gf=(e,t)=>new Xd(e,t,new Yd);e.INTERNAL.registerComponent(new j("firestore-compat",e=>{var t=e.getProvider("app-compat").getImmediate(),e=e.getProvider("firestore").getImmediate();return gf(t,e)},"PUBLIC").setServiceProps(Object.assign({},Te))),e.registerVersion("@firebase/firestore-compat","0.2.3")}.apply(this,arguments)}catch(e){throw console.error(e),new Error("Cannot instantiate firebase-firestore-compat.js - be sure to load firebase-app.js first.")}});